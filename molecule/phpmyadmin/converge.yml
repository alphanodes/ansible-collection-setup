---
- name: Converge
  hosts: all
  become: true

  pre_tasks:
    - name: Update apt cache.
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false

  vars:
    # PHP configuration
    php_version: "8.2"
    php_fpm_base: /run/php/php-fpm
    php_fpm_pools:
      - name: phpmyadmin
        user: www-data
        group: www-data
        pool: phpmyadmin
        skip_user_create: true

    # nodejs configuration
    nodejs_install_npm_user: root  # Use root in container tests

  roles:
    - role: alphanodes.setup.common
    - role: alphanodes.setup.php_cli
      vars:
        php_cli_version: "{{ php_version }}"
    - role: alphanodes.setup.mysql_client
    - role: alphanodes.setup.php_fpm
      vars:
        php_fpm_version: "{{ php_version }}"

  post_tasks:
    - name: Verify PHP is installed
      ansible.builtin.command: php --version
      changed_when: false
      register: php_version_output

    - name: Verify PHP-FPM is configured
      ansible.builtin.stat:
        path: "{{ php_fpm_base }}-phpmyadmin.sock"
      register: fpm_socket

    - name: Verify MySQL client is installed
      ansible.builtin.command: mysql --version
      changed_when: false

    - name: Display success message
      ansible.builtin.debug:
        msg: "phpMyAdmin dependencies test completed successfully"
