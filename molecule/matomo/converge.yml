---
- name: Converge
  hosts: all
  become: true
  vars:
    # nginx_mono configuration
    nginx_with_ipv6: false
    nginx_with_http3: false
    nginx_with_protection: false
    nginx_ssl_protocols: 'TLSv1.3'
    hoster: 'local'

    # SSL configuration - self-signed certificate for testing
    ssl_certs:
      - name: matomo
        provider: selfsigned
        subject_common_name: matomo.local

    # PHP-FPM settings
    php_fpm_listen: /run/php/php-fpm.sock

    # MySQL settings for testing
    mysql_root_password: 'test_root_password'
    mysql_socket_force: true
    mysql_server_tmpdir: /tmp

    # Matomo configuration - Standard mode (nginx + MySQL)
    matomo_with_nginx: true
    matomo_with_mysql: true
    # Skip core:update in tests - we don't have actual DB tables for upgrade testing
    sync_master: true
    matomo_vhost_server: matomo.local
    # Test server_alias combination (matomo_vhost_main + matomo_vhost_alias)
    matomo_vhost_main: matomo-main.local
    matomo_vhost_alias: matomo-alias.local
    matomo_vhost_letsencrypt: false
    matomo_vhost_ssl_cert: matomo
    matomo_vhost_ssl_only: true
    matomo_vhost_for_zabbix: false
    matomo_db_password: 'test_matomo_password'

    # === NEW FEATURES TO TEST ===
    # Enable geolocation with DBIP database download
    matomo_geolocation_enabled: true

    # Console config settings (idempotent via matomo console)
    # These will be applied via console config:set after installation
    matomo_console_config:
      General:
        force_ssl: 1
        show_update_notification_to_superusers_only: 1

    # Upgrade cleanup feature (tested only during actual upgrades)
    matomo_upgrade_cleanup_unexpected_files: true

  pre_tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false

    # Create mysql group FIRST so we can set correct permissions for matomo directory
    # This is needed because matomo_with_mysql=true expects group 'mysql'
    - name: Create mysql group for matomo directory permissions
      ansible.builtin.group:
        name: mysql
        system: true

    # Note: matomo role sets group to 'mysql' when matomo_with_mysql=true and mode 0750
    # We create with mysql group here to match what the role expects (idempotent)
    - name: Create matomo directory for testing
      ansible.builtin.file:
        path: /srv/matomo
        state: directory
        owner: www-data
        group: mysql
        mode: '0750'

    - name: Create matomo config directory for testing
      ansible.builtin.file:
        path: /srv/matomo/config
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create matomo misc directory for testing (geoip)
      ansible.builtin.file:
        path: /srv/matomo/misc
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create matomo private directory for testing (DBIP archives)
      ansible.builtin.file:
        path: /srv/matomo/private
        state: directory
        owner: www-data
        group: www-data
        mode: '0750'

    # Use force: false to not overwrite files on subsequent runs (idempotent)
    - name: Create dummy index.php for testing
      ansible.builtin.copy:
        content: |
          <?php
          echo 'Matomo Test';
          phpinfo();
        dest: /srv/matomo/index.php
        owner: www-data
        group: www-data
        mode: '0644'
        force: false

    - name: Create dummy matomo.php for testing (allowed FPM location)
      ansible.builtin.copy:
        content: |
          <?php
          echo 'Matomo Main Entry';
        dest: /srv/matomo/matomo.php
        owner: www-data
        group: www-data
        mode: '0644'
        force: false

    - name: Create dummy piwik.php for testing (legacy entry point)
      ansible.builtin.copy:
        content: |
          <?php
          echo 'Piwik Legacy Entry';
        dest: /srv/matomo/piwik.php
        owner: www-data
        group: www-data
        mode: '0644'
        force: false

    - name: Create js directory for js/index.php testing
      ansible.builtin.file:
        path: /srv/matomo/js
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create dummy js/index.php for testing
      ansible.builtin.copy:
        content: |
          <?php
          echo 'Matomo JS Tracker';
        dest: /srv/matomo/js/index.php
        owner: www-data
        group: www-data
        mode: '0644'
        force: false

    - name: Create plugins directory for testing
      ansible.builtin.file:
        path: /srv/matomo/plugins
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create HeatmapSessionRecording plugin directory
      ansible.builtin.file:
        path: /srv/matomo/plugins/HeatmapSessionRecording
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create configs.php for HeatmapSessionRecording testing
      ansible.builtin.copy:
        content: |
          <?php
          echo 'HeatmapSessionRecording Configs';
        dest: /srv/matomo/plugins/HeatmapSessionRecording/configs.php
        owner: www-data
        group: www-data
        mode: '0644'
        force: false

    - name: Create sensitive directories for deny testing
      # Note: console is NOT in this list because Matomo installs it as a file (PHP CLI)
      ansible.builtin.file:
        path: "/srv/matomo/{{ item }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'
      loop:
        - config
        - tmp
        - core
        - lang
        - libs
        - vendor
        - misc
        - node_modules

    # Config with correct format matching what the matomo role expects:
    # - Quotes around database values
    # - show_update_notification_to_superusers_only setting
    - name: Create config.ini.php for matomo config
      ansible.builtin.copy:
        content: |
          [General]
          force_ssl = 1
          salt = testsalt12345678
          [database]
          host = "localhost"
          username = "matomo"
          password = "test_matomo_password"
          dbname = "matomo"
          tables_prefix = piwik_
          show_update_notification_to_superusers_only = 1
        dest: /srv/matomo/config/config.ini.php
        owner: www-data
        group: www-data
        mode: '0660'
        force: false

  tasks:
    - name: Include matomo role
      ansible.builtin.include_role:
        name: alphanodes.setup.matomo
