---
- name: Converge
  hosts: all
  become: true
  vars:
    # nginx_mono configuration
    nginx_with_ipv6: false
    nginx_with_http3: false
    nginx_with_protection: false
    nginx_ssl_protocols: 'TLSv1.3'
    hoster: 'local'

    # SSL configuration - self-signed certificate for testing
    ssl_certs:
      - name: matomo
        provider: selfsigned
        subject_common_name: matomo.local

    # PHP-FPM settings
    php_fpm_listen: /run/php/php-fpm.sock

    # MySQL settings for testing
    mysql_root_password: 'test_root_password'
    # Use socket authentication for reliable connection in containers
    mysql_socket_force: true
    # Use /tmp for tmpdir in Docker containers to avoid /run/mysqld permission issues
    mysql_server_tmpdir: /tmp
    # MySQL 8.0 for Debian 12 (bookworm), 8.4-lts for Debian 13+ (trixie)
    # Ubuntu uses native repos with MySQL 8.0 (no Oracle repo needed)
    mysql_apt_components: "{{ 'mysql-8.0' if ansible_facts.distribution_release == 'bookworm' else 'mysql-8.4-lts' }}"

    # Matomo configuration - Standard mode (nginx + MySQL)
    matomo_with_nginx: true
    matomo_with_mysql: true
    # Skip core:update in tests - we don't have actual DB tables for upgrade testing
    sync_master: true
    matomo_vhost_server: matomo.local
    matomo_vhost_letsencrypt: false
    matomo_vhost_ssl_cert: matomo
    matomo_vhost_ssl_only: true
    matomo_vhost_for_zabbix: false
    matomo_db_password: 'test_matomo_password'

  pre_tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false

    # Note: matomo role sets group to 'mysql' when matomo_with_mysql=true and mode 0750
    # We create with www-data here, role will adjust owner/group/mode as needed
    - name: Create matomo directory for testing
      ansible.builtin.file:
        path: /srv/matomo
        state: directory
        owner: www-data
        group: www-data
        mode: '0750'

    - name: Create matomo config directory for testing
      ansible.builtin.file:
        path: /srv/matomo/config
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create matomo misc directory for testing (geoip)
      ansible.builtin.file:
        path: /srv/matomo/misc
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    # Use force: false to not overwrite files on subsequent runs (idempotent)
    - name: Create dummy index.php for testing
      ansible.builtin.copy:
        content: |
          <?php
          echo 'Matomo Test';
          phpinfo();
        dest: /srv/matomo/index.php
        owner: www-data
        group: www-data
        mode: '0644'
        force: false

    - name: Create dummy matomo.php for testing (allowed FPM location)
      ansible.builtin.copy:
        content: |
          <?php
          echo 'Matomo Main Entry';
        dest: /srv/matomo/matomo.php
        owner: www-data
        group: www-data
        mode: '0644'
        force: false

    - name: Create dummy piwik.php for testing (legacy entry point)
      ansible.builtin.copy:
        content: |
          <?php
          echo 'Piwik Legacy Entry';
        dest: /srv/matomo/piwik.php
        owner: www-data
        group: www-data
        mode: '0644'
        force: false

    - name: Create js directory for js/index.php testing
      ansible.builtin.file:
        path: /srv/matomo/js
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create dummy js/index.php for testing
      ansible.builtin.copy:
        content: |
          <?php
          echo 'Matomo JS Tracker';
        dest: /srv/matomo/js/index.php
        owner: www-data
        group: www-data
        mode: '0644'
        force: false

    - name: Create plugins directory for testing
      ansible.builtin.file:
        path: /srv/matomo/plugins
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create HeatmapSessionRecording plugin directory
      ansible.builtin.file:
        path: /srv/matomo/plugins/HeatmapSessionRecording
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create configs.php for HeatmapSessionRecording testing
      ansible.builtin.copy:
        content: |
          <?php
          echo 'HeatmapSessionRecording Configs';
        dest: /srv/matomo/plugins/HeatmapSessionRecording/configs.php
        owner: www-data
        group: www-data
        mode: '0644'
        force: false

    - name: Create sensitive directories for deny testing
      # Note: console is NOT in this list because Matomo installs it as a file (PHP CLI)
      ansible.builtin.file:
        path: "/srv/matomo/{{ item }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'
      loop:
        - config
        - tmp
        - core
        - lang
        - libs
        - vendor
        - misc
        - node_modules

    # Config with correct format matching what the matomo role expects:
    # - Quotes around database values
    # - show_update_notification_to_superusers_only setting
    - name: Create config.ini.php for matomo config
      ansible.builtin.copy:
        content: |
          [General]
          force_ssl = 1
          salt = testsalt12345678
          [database]
          host = "localhost"
          username = "matomo"
          password = "test_matomo_password"
          dbname = "matomo"
          tables_prefix = piwik_
          show_update_notification_to_superusers_only = 1
        dest: /srv/matomo/config/config.ini.php
        owner: www-data
        group: www-data
        mode: '0660'
        force: false

  tasks:
    - name: Include matomo role
      ansible.builtin.include_role:
        name: alphanodes.setup.matomo
