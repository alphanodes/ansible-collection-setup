---
# Cluster Frontend Scenario: nginx + PHP-FPM, but NO MySQL server
# Use case: Frontend/Tracker nodes connecting to external database
- name: Converge - Cluster Frontend (no MySQL)
  hosts: all
  become: true
  vars:
    # nginx_mono configuration
    nginx_with_ipv6: false
    nginx_with_http3: false
    nginx_with_protection: false
    nginx_ssl_protocols: 'TLSv1.3'
    hoster: 'local'

    # SSL configuration - self-signed certificate for testing
    ssl_certs:
      - name: matomo
        provider: selfsigned
        subject_common_name: matomo.local

    # PHP-FPM settings
    php_fpm_listen: /run/php/php-fpm.sock

    # MySQL client version for Debian (Ubuntu uses native repos)
    # MySQL 8.0 for Debian 12 (bookworm), 8.4-lts for Debian 13+ (trixie)
    mysql_apt_components: "{{ 'mysql-8.0' if ansible_facts.distribution_release == 'bookworm' else 'mysql-8.4-lts' }}"

    # Matomo configuration - Cluster Frontend mode (nginx, NO MySQL)
    matomo_with_nginx: true
    matomo_with_mysql: false
    matomo_vhost_server: matomo.local
    matomo_vhost_letsencrypt: false
    matomo_vhost_ssl_cert: matomo
    matomo_vhost_ssl_only: true
    matomo_vhost_for_zabbix: true
    # External database connection (simulated)
    matomo_db_host: 'db.example.com'
    matomo_db_password: 'external_db_password'

  pre_tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false

    - name: Create matomo directory for testing
      ansible.builtin.file:
        path: /srv/matomo
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create matomo config directory for testing
      ansible.builtin.file:
        path: /srv/matomo/config
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create matomo misc directory for testing (geoip)
      ansible.builtin.file:
        path: /srv/matomo/misc
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create dummy index.php for testing
      ansible.builtin.copy:
        content: |
          <?php
          echo 'Matomo Cluster Frontend';
          phpinfo();
        dest: /srv/matomo/index.php
        owner: www-data
        group: www-data
        mode: '0644'

    - name: Create dummy matomo.php for testing
      ansible.builtin.copy:
        content: |
          <?php
          echo 'Matomo Main Entry';
        dest: /srv/matomo/matomo.php
        owner: www-data
        group: www-data
        mode: '0644'

    - name: Create js directory for js/index.php testing
      ansible.builtin.file:
        path: /srv/matomo/js
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create dummy js/index.php for testing
      ansible.builtin.copy:
        content: |
          <?php
          echo 'Matomo JS Tracker';
        dest: /srv/matomo/js/index.php
        owner: www-data
        group: www-data
        mode: '0644'

    - name: Create sensitive directories for deny testing
      ansible.builtin.file:
        path: "/srv/matomo/{{ item }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'
      loop:
        - console
        - config
        - tmp
        - core
        - lang
        - libs
        - vendor
        - plugins
        - misc
        - node_modules

    - name: Create config.ini.php for matomo config
      ansible.builtin.copy:
        content: |
          [General]
          force_ssl = 1
          salt = testsalt12345678
          [database]
          host = db.example.com
          username = matomo
          password = external_db_password
          dbname = matomo
          tables_prefix = piwik_
        dest: /srv/matomo/config/config.ini.php
        owner: www-data
        group: www-data
        mode: '0660'

  tasks:
    - name: Include matomo role
      ansible.builtin.include_role:
        name: alphanodes.setup.matomo
