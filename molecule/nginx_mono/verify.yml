---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Check if nginx is running
      ansible.builtin.service:
        name: nginx
        state: started
      check_mode: true
      register: nginx_service
      failed_when: nginx_service.changed

    - name: Check nginx configuration syntax
      ansible.builtin.command: nginx -t
      register: nginx_syntax
      changed_when: false

    - name: Verify action normalization (no double semicolons)
      ansible.builtin.shell: |
        set -euo pipefail
        awk '/location \/_ping/,/}/ {print}' /etc/nginx/sites-available/ethercalc.conf | grep -E "add_header X-Ping pong;\$|return 204;\$"
      args:
        executable: /bin/bash
      register: normalize_check
      changed_when: false
      failed_when: normalize_check.rc != 0

    - name: Verify additional_headers normalization
      ansible.builtin.shell: |
        set -e
        grep -F 'add_header X-Test-Header "ok";' /etc/nginx/sites-available/ethercalc.conf
        grep -F 'add_header X-Second "yes";' /etc/nginx/sites-available/ethercalc.conf
      register: addhdr_check
      changed_when: false
      failed_when: addhdr_check.rc != 0

    - name: Verify fastcgi_params normalization (rendered but harmless)
      ansible.builtin.shell: |
        set -e
        # fastcgi_param may or may not be present depending on config; accept absence gracefully
        ! grep -q 'fastcgi_param .*;;' /etc/nginx/sites-available/ethercalc.conf
      register: fpmparam_check
      changed_when: false
      failed_when: fpmparam_check.rc != 0

    - name: Verify proxy_headers normalization
      ansible.builtin.shell: |
        set -e
        grep -F 'proxy_set_header X-Forwarded-Proto $scheme;' /etc/nginx/sites-available/ethercalc.conf
      register: proxyhdr_check
      changed_when: false
      failed_when: proxyhdr_check.rc != 0

    - name: Verify proxy_redirect normalization
      ansible.builtin.shell: |
        set -euo pipefail
        awk '/location \/ \{/,/}/ {print}' /etc/nginx/sites-available/ethercalc.conf | grep -E "^\s*proxy_redirect off;\s*$"
      args:
        executable: /bin/bash
      register: proxyredir_check
      changed_when: false
      failed_when: proxyredir_check.rc != 0

    - name: Verify rewrite_lines normalization
      ansible.builtin.shell: |
        set -e
        grep -E '^\s*rewrite \^/old/\(\.\*\) /new/\$1 permanent;\s*$' /etc/nginx/sites-available/ethercalc.conf
      register: rewrite_check
      changed_when: false
      failed_when: rewrite_check.rc != 0

    - name: Check if ethercalc vhost config exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/ethercalc.conf
      register: ethercalc_vhost

    - name: Verify ethercalc vhost is enabled
      ansible.builtin.stat:
        path: /etc/nginx/sites-enabled/ethercalc.conf
      register: ethercalc_enabled

    - name: Check nginx proxy configuration is valid
      ansible.builtin.lineinfile:
        path: /etc/nginx/sites-available/ethercalc.conf
        line: "proxy_pass http://127.0.0.1:8000;"
        state: absent
      check_mode: true
      register: proxy_config
      failed_when: proxy_config.changed

    - name: Test that nginx accepts connections (basic connectivity)
      ansible.builtin.wait_for:
        port: 80
        host: localhost
        delay: 1
        timeout: 10
      register: nginx_connection

    - name: Verify nginx_mono templates are self-contained
      ansible.builtin.find:
        paths: /etc/nginx/sites-available/
        patterns: "*.conf"
        contains: "templates/nginx/"
      register: external_refs
      failed_when: external_refs.matched > 0

    # Include mode tests
    - name: Check if include mode file exists
      ansible.builtin.stat:
        path: /etc/nginx/test_include.conf
      register: include_file

    - name: Verify include mode does NOT create sites-available file
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/test_include.conf
      register: include_vhost
      failed_when: include_vhost.stat.exists

    - name: Verify include mode does NOT create sites-enabled symlink
      ansible.builtin.stat:
        path: /etc/nginx/sites-enabled/test_include.conf
      register: include_enabled
      failed_when: include_enabled.stat.exists

    - name: Verify include file contains location block
      ansible.builtin.shell: |
        set -e
        grep -F 'location /testapp/ {' /etc/nginx/test_include.conf
      register: include_location
      changed_when: false
      failed_when: include_location.rc != 0

    - name: Verify include file contains proxy_pass
      ansible.builtin.shell: |
        set -e
        grep -F 'proxy_pass http://127.0.0.1:9000;' /etc/nginx/test_include.conf
      register: include_proxy
      changed_when: false
      failed_when: include_proxy.rc != 0

    - name: Verify include file does NOT contain server block
      ansible.builtin.shell: |
        set -e
        ! grep -q '^server {' /etc/nginx/test_include.conf
      register: include_no_server
      changed_when: false
      failed_when: include_no_server.rc != 0

    - name: Check if htpasswd file for include mode exists
      ansible.builtin.stat:
        path: /etc/nginx/.htpasswd_test_include
      register: include_htpasswd

    # Instance mode (nginx_vhosts) tests
    - name: Check if parking vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/parking.conf
      register: parking_vhost

    - name: Check if parking vhost is enabled
      ansible.builtin.stat:
        path: /etc/nginx/sites-enabled/parking.conf
      register: parking_enabled

    - name: Verify parking vhost has correct server_name
      ansible.builtin.shell: |
        set -e
        grep -F 'server_name parking.local;' /etc/nginx/sites-available/parking.conf
      register: parking_server_name
      changed_when: false
      failed_when: parking_server_name.rc != 0

    - name: Verify parking vhost comment uses instance.name
      ansible.builtin.shell: |
        set -e
        grep -F '# nginx parking vhost configuration' /etc/nginx/sites-available/parking.conf
      register: parking_comment
      changed_when: false
      failed_when: parking_comment.rc != 0

    - name: Check if static_site vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/static_site.conf
      register: static_vhost

    - name: Check if htpasswd for static_site exists (without nginx_ prefix)
      ansible.builtin.stat:
        path: /etc/nginx/.htpasswd_static_site
      register: static_htpasswd

    - name: Verify static_site vhost has auth_basic configured
      ansible.builtin.shell: |
        set -e
        grep -F 'auth_basic_user_file /etc/nginx/.htpasswd_static_site;' /etc/nginx/sites-available/static_site.conf
      register: static_auth
      changed_when: false
      failed_when: static_auth.rc != 0

    - name: Verify static_site has error_404 configured
      ansible.builtin.shell: |
        set -e
        grep -F 'error_page 404 /404.html;' /etc/nginx/sites-available/static_site.conf
      register: static_error404
      changed_when: false
      failed_when: static_error404.rc != 0

    - name: Check if php_app vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/php_app.conf
      register: php_vhost

    - name: Verify php_app vhost has FPM configuration
      ansible.builtin.shell: |
        set -e
        grep -F 'fastcgi_pass' /etc/nginx/sites-available/php_app.conf
      register: php_fpm
      changed_when: false
      failed_when: php_fpm.rc != 0

    - name: Check if proxy_app vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/proxy_app.conf
      register: proxy_vhost

    - name: Verify proxy_app vhost has proxy_pass configured
      ansible.builtin.shell: |
        set -e
        grep -F 'proxy_pass http://127.0.0.1:3000;' /etc/nginx/sites-available/proxy_app.conf
      register: proxy_pass
      changed_when: false
      failed_when: proxy_pass.rc != 0

    # block_unsafe_methods tests
    - name: Check if static_safe vhost exists (block_unsafe_methods enabled)
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/static_safe.conf
      register: safe_vhost

    - name: Check if static_open vhost exists (block_unsafe_methods disabled)
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/static_open.conf
      register: open_vhost

    - name: Verify static_safe has not_allowed_method protection
      ansible.builtin.shell: |
        set -e
        grep -F 'if ($not_allowed_method)' /etc/nginx/sites-available/static_safe.conf
        grep -F 'return 405;' /etc/nginx/sites-available/static_safe.conf
      register: safe_method_check
      changed_when: false
      failed_when: safe_method_check.rc != 0

    - name: Verify static_open does NOT have not_allowed_method protection
      ansible.builtin.shell: |
        set -e
        ! grep -q 'if ($not_allowed_method)' /etc/nginx/sites-available/static_open.conf
      register: open_method_check
      changed_when: false
      failed_when: open_method_check.rc != 0

    - name: Test PUT request to safe.local returns 405 (blocked)
      ansible.builtin.command: >
        curl -s -o /dev/null -w '%{http_code}' -X PUT -H 'Host: safe.local'
        http://127.0.0.1/
      register: safe_put_response
      changed_when: false
      failed_when: safe_put_response.stdout != '405'

    - name: Test DELETE request to safe.local returns 405 (blocked)
      ansible.builtin.command: >
        curl -s -o /dev/null -w '%{http_code}' -X DELETE -H 'Host: safe.local'
        http://127.0.0.1/
      register: safe_delete_response
      changed_when: false
      failed_when: safe_delete_response.stdout != '405'

    - name: Test GET request to safe.local works (allowed method)
      ansible.builtin.command: >
        curl -s -o /dev/null -w '%{http_code}' -X GET -H 'Host: safe.local'
        http://127.0.0.1/
      register: safe_get_response
      changed_when: false
      failed_when: safe_get_response.stdout != '200'

    # raw_actions tests (server-level raw nginx directives)
    - name: Check if raw_actions_test vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/raw_actions_test.conf
      register: raw_actions_vhost

    - name: Verify raw_actions_test vhost contains rewrite rule
      ansible.builtin.shell: |
        set -e
        grep -F 'if (!-f $request_filename)' /etc/nginx/sites-available/raw_actions_test.conf
        grep -F 'rewrite ^(.*)$ /index.php?q=$1 last;' /etc/nginx/sites-available/raw_actions_test.conf
      register: raw_actions_check
      changed_when: false
      failed_when: raw_actions_check.rc != 0

    - name: Verify raw_actions indentation is correct (2 spaces)
      ansible.builtin.shell: |
        set -e
        grep -E '^\s{2}if \(!\-f' /etc/nginx/sites-available/raw_actions_test.conf
        grep -E '^\s{4}rewrite' /etc/nginx/sites-available/raw_actions_test.conf
      register: raw_actions_indent
      changed_when: false
      failed_when: raw_actions_indent.rc != 0

    # Named location with proxy_pass tests (Test 7)
    - name: Check if named_location_test vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/named_location_test.conf
      register: named_location_vhost

    - name: Verify named location @backend exists
      ansible.builtin.shell: |
        set -e
        grep -F 'location @backend {' /etc/nginx/sites-available/named_location_test.conf
      register: named_backend_check
      changed_when: false
      failed_when: named_backend_check.rc != 0

    - name: Verify named location has proxy_pass
      ansible.builtin.shell: |
        set -eo pipefail
        awk '/location @backend/,/}/' /etc/nginx/sites-available/named_location_test.conf | grep -F 'proxy_pass http://backend_app;'
      args:
        executable: /bin/bash
      register: named_proxy_pass
      changed_when: false
      failed_when: named_proxy_pass.rc != 0

    - name: Verify named location has proxy_timeout
      ansible.builtin.shell: |
        set -eo pipefail
        awk '/location @backend/,/}/' /etc/nginx/sites-available/named_location_test.conf | grep -F 'proxy_read_timeout 300;'
      args:
        executable: /bin/bash
      register: named_timeout
      changed_when: false
      failed_when: named_timeout.rc != 0

    - name: Verify try_files to named location
      ansible.builtin.shell: |
        set -e
        grep -F 'try_files $uri @backend;' /etc/nginx/sites-available/named_location_test.conf
      register: named_try_files
      changed_when: false
      failed_when: named_try_files.rc != 0

    - name: Verify WebSocket location /cable has upgrade headers
      ansible.builtin.shell: |
        set -eo pipefail
        awk '/location \/cable/,/}/' /etc/nginx/sites-available/named_location_test.conf | grep -F 'proxy_set_header Upgrade $http_upgrade;'
      args:
        executable: /bin/bash
      register: cable_websocket
      changed_when: false
      failed_when: cable_websocket.rc != 0

    - name: Verify upstream block exists
      ansible.builtin.shell: |
        set -e
        grep -F 'upstream backend_app {' /etc/nginx/sites-available/named_location_test.conf
      register: upstream_block
      changed_when: false
      failed_when: upstream_block.rc != 0

    # Proxy Buffer Settings tests (Test 8)
    - name: Check if buffer_test vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/buffer_test.conf
      register: buffer_vhost

    - name: Verify proxy_buffers is configured
      ansible.builtin.shell: |
        set -e
        grep -F 'proxy_buffers 16 128k;' /etc/nginx/sites-available/buffer_test.conf
      register: buffer_check
      changed_when: false
      failed_when: buffer_check.rc != 0

    - name: Verify proxy_buffer_size is configured
      ansible.builtin.shell: |
        set -e
        grep -F 'proxy_buffer_size 128k;' /etc/nginx/sites-available/buffer_test.conf
      register: buffer_size_check
      changed_when: false
      failed_when: buffer_size_check.rc != 0

    - name: Verify proxy_busy_buffers_size is configured
      ansible.builtin.shell: |
        set -e
        grep -F 'proxy_busy_buffers_size 256k;' /etc/nginx/sites-available/buffer_test.conf
      register: busy_buffers_check
      changed_when: false
      failed_when: busy_buffers_check.rc != 0

    # Rate Limiting tests (Test 9)
    - name: Check if limit_req_zones.conf exists
      ansible.builtin.stat:
        path: /etc/nginx/conf.d/limit_req_zones.conf
      register: limit_zones_file

    - name: Verify rate limit zone test_api is defined
      ansible.builtin.shell: |
        set -e
        grep -F 'limit_req_zone $binary_remote_addr zone=test_api:10m rate=10r/s;' /etc/nginx/conf.d/limit_req_zones.conf
      register: zone_api_check
      changed_when: false
      failed_when: zone_api_check.rc != 0

    - name: Verify rate limit zone test_form is defined
      ansible.builtin.shell: |
        set -e
        grep -F 'limit_req_zone $binary_remote_addr zone=test_form:10m rate=5r/m;' /etc/nginx/conf.d/limit_req_zones.conf
      register: zone_form_check
      changed_when: false
      failed_when: zone_form_check.rc != 0

    - name: Check if ratelimit_test vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/ratelimit_test.conf
      register: ratelimit_vhost

    - name: Verify limit_req directive is in vhost
      ansible.builtin.shell: |
        set -e
        grep -F 'limit_req zone=test_api burst=20 nodelay;' /etc/nginx/sites-available/ratelimit_test.conf
      register: limit_req_check
      changed_when: false
      failed_when: limit_req_check.rc != 0

    - name: Verify limit_req_status is configured
      ansible.builtin.shell: |
        set -e
        grep -F 'limit_req_status 429;' /etc/nginx/sites-available/ratelimit_test.conf
      register: limit_status_check
      changed_when: false
      failed_when: limit_status_check.rc != 0

    # Custom Protection Rules tests (Test 10)
    - name: Check if protection_test vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/protection_test.conf
      register: protection_vhost

    - name: Verify custom protection rule bad_bot is configured
      ansible.builtin.shell: |
        set -e
        grep -F 'if ($bad_bot) { return 403; }' /etc/nginx/sites-available/protection_test.conf
      register: protection_badbot_check
      changed_when: false
      failed_when: protection_badbot_check.rc != 0

    - name: Verify custom protection rule admin is configured
      ansible.builtin.shell: |
        set -e
        grep -F 'if ($request_uri ~* "^/admin") { return 404; }' /etc/nginx/sites-available/protection_test.conf
      register: protection_admin_check
      changed_when: false
      failed_when: protection_admin_check.rc != 0

    # Custom htpasswd_name tests (Test 11)
    - name: Check if myapp vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/myapp.conf
      register: myapp_vhost

    - name: Check if htpasswd with custom name exists (redmine_myapp pattern)
      ansible.builtin.stat:
        path: /etc/nginx/.htpasswd_redmine_myapp
      register: custom_htpasswd

    - name: Verify htpasswd with default name does NOT exist
      ansible.builtin.stat:
        path: /etc/nginx/.htpasswd_myapp
      register: default_htpasswd
      failed_when: default_htpasswd.stat.exists

    - name: Verify myapp vhost uses custom htpasswd path
      ansible.builtin.shell: |
        set -e
        grep -F 'auth_basic_user_file /etc/nginx/.htpasswd_redmine_myapp;' /etc/nginx/sites-available/myapp.conf
      register: custom_htpasswd_path
      changed_when: false
      failed_when: custom_htpasswd_path.rc != 0

    - name: Verify myapp vhost has auth_basic configured
      ansible.builtin.shell: |
        set -e
        grep -F 'auth_basic "Restricted access only";' /etc/nginx/sites-available/myapp.conf
      register: myapp_auth_basic
      changed_when: false
      failed_when: myapp_auth_basic.rc != 0

    # vhost_default with redirect tests (Test 12)
    - name: Check if default_redirect_test vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/default_redirect_test.conf
      register: default_redirect_vhost

    - name: Verify default_redirect_test has redirect server block with server_name _
      ansible.builtin.shell: |
        set -e
        grep -F 'server_name _;' /etc/nginx/sites-available/default_redirect_test.conf
      register: redirect_server_name
      changed_when: false
      failed_when: redirect_server_name.rc != 0

    - name: Verify default_redirect_test has redirect to canonical hostname
      ansible.builtin.shell: |
        set -e
        grep -F 'return 301 http://canonical.local$request_uri;' /etc/nginx/sites-available/default_redirect_test.conf
      register: redirect_to_canonical
      changed_when: false
      failed_when: redirect_to_canonical.rc != 0

    - name: Verify redirect server block has default_server flag
      ansible.builtin.shell: |
        set -eo pipefail
        # Check that default_server appears BEFORE server_name _ (in redirect block)
        awk '/server_name _;/{found_underscore=1} /default_server/{if(!found_underscore) found_default=1} END{exit found_default ? 0 : 1}' /etc/nginx/sites-available/default_redirect_test.conf
      args:
        executable: /bin/bash
      register: redirect_default_server
      changed_when: false
      failed_when: redirect_default_server.rc != 0

    - name: Verify main vhost does NOT have default_server (only redirect block has it)
      ansible.builtin.shell: |
        set -eo pipefail
        # The main server block (with server_name canonical.local) should NOT have default_server
        # Count how many times default_server appears - should be exactly 1 (in redirect block only)
        count=$(grep -c 'default_server' /etc/nginx/sites-available/default_redirect_test.conf)
        # With HTTP only (no SSL), we expect exactly 1 default_server (on port 80 redirect)
        [ "$count" -eq 1 ]
      args:
        executable: /bin/bash
      register: main_no_default_server
      changed_when: false
      failed_when: main_no_default_server.rc != 0

    - name: Verify main vhost has correct server_name
      ansible.builtin.shell: |
        set -e
        grep -F 'server_name canonical.local;' /etc/nginx/sites-available/default_redirect_test.conf
      register: main_server_name
      changed_when: false
      failed_when: main_server_name.rc != 0

    - name: Display test results
      ansible.builtin.debug:
        msg:
          - "=== Service Mode Tests ==="
          - "Nginx service: {{ 'OK' if not nginx_service.changed else 'FAILED' }}"
          - "Nginx syntax: {{ 'OK' if nginx_syntax.rc == 0 else 'FAILED' }}"
          - "Normalize actions: {{ 'OK' if normalize_check.rc == 0 else 'FAILED' }}"
          - "Add headers normalized: {{ 'OK' if addhdr_check.rc == 0 else 'FAILED' }}"
          - "FastCGI params: {{ 'OK' if fpmparam_check.rc == 0 else 'FAILED' }}"
          - "Proxy headers normalized: {{ 'OK' if proxyhdr_check.rc == 0 else 'FAILED' }}"
          - "Proxy redirect normalized: {{ 'OK' if proxyredir_check.rc == 0 else 'FAILED' }}"
          - "Rewrite lines normalized: {{ 'OK' if rewrite_check.rc == 0 else 'FAILED' }}"
          - "Ethercalc vhost exists: {{ 'OK' if ethercalc_vhost.stat.exists else 'FAILED' }}"
          - "Ethercalc enabled: {{ 'OK' if ethercalc_enabled.stat.exists else 'FAILED' }}"
          - "Proxy config: {{ 'OK' if not proxy_config.changed else 'FAILED' }}"
          - "Nginx connectivity: {{ 'OK' if nginx_connection is succeeded else 'FAILED' }}"
          - "No external refs: {{ 'OK' if external_refs.matched == 0 else 'FAILED' }}"
          - "=== Include Mode Tests ==="
          - "Include file exists: {{ 'OK' if include_file.stat.exists else 'FAILED' }}"
          - "Include mode no vhost: {{ 'OK' if not include_vhost.stat.exists else 'FAILED' }}"
          - "Include mode no enabled: {{ 'OK' if not include_enabled.stat.exists else 'FAILED' }}"
          - "Include has location: {{ 'OK' if include_location.rc == 0 else 'FAILED' }}"
          - "Include has proxy: {{ 'OK' if include_proxy.rc == 0 else 'FAILED' }}"
          - "Include no server block: {{ 'OK' if include_no_server.rc == 0 else 'FAILED' }}"
          - "Include htpasswd exists: {{ 'OK' if include_htpasswd.stat.exists else 'FAILED' }}"
          - "=== Instance Mode (nginx_vhosts) Tests ==="
          - "Parking vhost exists: {{ 'OK' if parking_vhost.stat.exists else 'FAILED' }}"
          - "Parking vhost enabled: {{ 'OK' if parking_enabled.stat.exists else 'FAILED' }}"
          - "Parking server_name correct: {{ 'OK' if parking_server_name.rc == 0 else 'FAILED' }}"
          - "Parking comment correct: {{ 'OK' if parking_comment.rc == 0 else 'FAILED' }}"
          - "Static vhost exists: {{ 'OK' if static_vhost.stat.exists else 'FAILED' }}"
          - "Static htpasswd exists: {{ 'OK' if static_htpasswd.stat.exists else 'FAILED' }}"
          - "Static auth_basic correct: {{ 'OK' if static_auth.rc == 0 else 'FAILED' }}"
          - "Static error_404 configured: {{ 'OK' if static_error404.rc == 0 else 'FAILED' }}"
          - "PHP vhost exists: {{ 'OK' if php_vhost.stat.exists else 'FAILED' }}"
          - "PHP FPM configured: {{ 'OK' if php_fpm.rc == 0 else 'FAILED' }}"
          - "Proxy vhost exists: {{ 'OK' if proxy_vhost.stat.exists else 'FAILED' }}"
          - "Proxy pass configured: {{ 'OK' if proxy_pass.rc == 0 else 'FAILED' }}"
          - "=== block_unsafe_methods Tests ==="
          - "Safe vhost exists: {{ 'OK' if safe_vhost.stat.exists else 'FAILED' }}"
          - "Open vhost exists: {{ 'OK' if open_vhost.stat.exists else 'FAILED' }}"
          - "Safe has method protection: {{ 'OK' if safe_method_check.rc == 0 else 'FAILED' }}"
          - "Open has NO method protection: {{ 'OK' if open_method_check.rc == 0 else 'FAILED' }}"
          - "Safe PUT returns 405: {{ 'OK' if safe_put_response.stdout == '405' else 'FAILED' }}"
          - "Safe DELETE returns 405: {{ 'OK' if safe_delete_response.stdout == '405' else 'FAILED' }}"
          - "Safe GET returns 200: {{ 'OK' if safe_get_response.stdout == '200' else 'FAILED' }}"
          - "=== raw_actions Tests ==="
          - "raw_actions vhost exists: {{ 'OK' if raw_actions_vhost.stat.exists else 'FAILED' }}"
          - "raw_actions rewrite rule: {{ 'OK' if raw_actions_check.rc == 0 else 'FAILED' }}"
          - "raw_actions indentation: {{ 'OK' if raw_actions_indent.rc == 0 else 'FAILED' }}"
          - "=== Named Location Tests ==="
          - "Named location vhost exists: {{ 'OK' if named_location_vhost.stat.exists else 'FAILED' }}"
          - "Named @backend exists: {{ 'OK' if named_backend_check.rc == 0 else 'FAILED' }}"
          - "Named proxy_pass configured: {{ 'OK' if named_proxy_pass.rc == 0 else 'FAILED' }}"
          - "Named proxy_timeout configured: {{ 'OK' if named_timeout.rc == 0 else 'FAILED' }}"
          - "try_files to @backend: {{ 'OK' if named_try_files.rc == 0 else 'FAILED' }}"
          - "WebSocket /cable headers: {{ 'OK' if cable_websocket.rc == 0 else 'FAILED' }}"
          - "Upstream block exists: {{ 'OK' if upstream_block.rc == 0 else 'FAILED' }}"
          - "=== Proxy Buffer Tests ==="
          - "Buffer vhost exists: {{ 'OK' if buffer_vhost.stat.exists else 'FAILED' }}"
          - "proxy_buffers configured: {{ 'OK' if buffer_check.rc == 0 else 'FAILED' }}"
          - "proxy_buffer_size configured: {{ 'OK' if buffer_size_check.rc == 0 else 'FAILED' }}"
          - "proxy_busy_buffers_size configured: {{ 'OK' if busy_buffers_check.rc == 0 else 'FAILED' }}"
          - "=== Rate Limiting Tests ==="
          - "limit_req_zones.conf exists: {{ 'OK' if limit_zones_file.stat.exists else 'FAILED' }}"
          - "Zone test_api defined: {{ 'OK' if zone_api_check.rc == 0 else 'FAILED' }}"
          - "Zone test_form defined: {{ 'OK' if zone_form_check.rc == 0 else 'FAILED' }}"
          - "Ratelimit vhost exists: {{ 'OK' if ratelimit_vhost.stat.exists else 'FAILED' }}"
          - "limit_req in vhost: {{ 'OK' if limit_req_check.rc == 0 else 'FAILED' }}"
          - "limit_req_status 429: {{ 'OK' if limit_status_check.rc == 0 else 'FAILED' }}"
          - "=== Custom Protection Tests ==="
          - "Protection vhost exists: {{ 'OK' if protection_vhost.stat.exists else 'FAILED' }}"
          - "bad_bot rule configured: {{ 'OK' if protection_badbot_check.rc == 0 else 'FAILED' }}"
          - "admin rule configured: {{ 'OK' if protection_admin_check.rc == 0 else 'FAILED' }}"
          - "=== Custom htpasswd_name Tests ==="
          - "myapp vhost exists: {{ 'OK' if myapp_vhost.stat.exists else 'FAILED' }}"
          - "Custom htpasswd file exists: {{ 'OK' if custom_htpasswd.stat.exists else 'FAILED' }}"
          - "Default htpasswd NOT exists: {{ 'OK' if not default_htpasswd.stat.exists else 'FAILED' }}"
          - "Custom htpasswd path in vhost: {{ 'OK' if custom_htpasswd_path.rc == 0 else 'FAILED' }}"
          - "auth_basic configured: {{ 'OK' if myapp_auth_basic.rc == 0 else 'FAILED' }}"
          - "=== vhost_default Redirect Tests ==="
          - "default_redirect_test vhost exists: {{ 'OK' if default_redirect_vhost.stat.exists else 'FAILED' }}"
          - "Redirect has server_name _: {{ 'OK' if redirect_server_name.rc == 0 else 'FAILED' }}"
          - "Redirect to canonical hostname: {{ 'OK' if redirect_to_canonical.rc == 0 else 'FAILED' }}"
          - "Redirect block has default_server: {{ 'OK' if redirect_default_server.rc == 0 else 'FAILED' }}"
          - "Main vhost no default_server: {{ 'OK' if main_no_default_server.rc == 0 else 'FAILED' }}"
          - "Main vhost correct server_name: {{ 'OK' if main_server_name.rc == 0 else 'FAILED' }}"
