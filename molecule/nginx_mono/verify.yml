---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Check if nginx is running
      ansible.builtin.service:
        name: nginx
        state: started
      check_mode: true
      register: nginx_service
      failed_when: nginx_service.changed

    - name: Check nginx configuration syntax
      ansible.builtin.command: nginx -t
      register: nginx_syntax
      changed_when: false

    - name: Verify action normalization (no double semicolons)
      ansible.builtin.shell: |
        set -euo pipefail
        awk '/location \/_ping/,/}/ {print}' /etc/nginx/sites-available/ethercalc.conf | grep -E "add_header X-Ping pong;\$|return 204;\$"
      args:
        executable: /bin/bash
      register: normalize_check
      changed_when: false
      failed_when: normalize_check.rc != 0

    - name: Verify additional_headers normalization
      ansible.builtin.shell: |
        set -e
        grep -F 'add_header X-Test-Header "ok";' /etc/nginx/sites-available/ethercalc.conf
        grep -F 'add_header X-Second "yes";' /etc/nginx/sites-available/ethercalc.conf
      register: addhdr_check
      changed_when: false
      failed_when: addhdr_check.rc != 0

    - name: Verify fastcgi_params normalization (rendered but harmless)
      ansible.builtin.shell: |
        set -e
        # fastcgi_param may or may not be present depending on config; accept absence gracefully
        ! grep -q 'fastcgi_param .*;;' /etc/nginx/sites-available/ethercalc.conf
      register: fpmparam_check
      changed_when: false
      failed_when: fpmparam_check.rc != 0

    - name: Verify proxy_headers normalization
      ansible.builtin.shell: |
        set -e
        grep -F 'proxy_set_header X-Forwarded-Proto $scheme;' /etc/nginx/sites-available/ethercalc.conf
      register: proxyhdr_check
      changed_when: false
      failed_when: proxyhdr_check.rc != 0

    - name: Verify proxy_redirect normalization
      ansible.builtin.shell: |
        set -euo pipefail
        awk '/location \/ \{/,/}/ {print}' /etc/nginx/sites-available/ethercalc.conf | grep -E "^\s*proxy_redirect off;\s*$"
      args:
        executable: /bin/bash
      register: proxyredir_check
      changed_when: false
      failed_when: proxyredir_check.rc != 0

    - name: Verify rewrite_lines normalization
      ansible.builtin.shell: |
        set -e
        grep -E '^\s*rewrite \^/old/\(\.\*\) /new/\$1 permanent;\s*$' /etc/nginx/sites-available/ethercalc.conf
      register: rewrite_check
      changed_when: false
      failed_when: rewrite_check.rc != 0

    - name: Check if ethercalc vhost config exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/ethercalc.conf
      register: ethercalc_vhost

    - name: Verify ethercalc vhost is enabled
      ansible.builtin.stat:
        path: /etc/nginx/sites-enabled/ethercalc.conf
      register: ethercalc_enabled

    - name: Check nginx proxy configuration is valid
      ansible.builtin.lineinfile:
        path: /etc/nginx/sites-available/ethercalc.conf
        line: "proxy_pass http://127.0.0.1:8000;"
        state: absent
      check_mode: true
      register: proxy_config
      failed_when: proxy_config.changed

    - name: Test that nginx accepts connections (basic connectivity)
      ansible.builtin.wait_for:
        port: 80
        host: localhost
        delay: 1
        timeout: 10
      register: nginx_connection

    - name: Verify nginx_mono templates are self-contained
      ansible.builtin.find:
        paths: /etc/nginx/sites-available/
        patterns: "*.conf"
        contains: "templates/nginx/"
      register: external_refs
      failed_when: external_refs.matched > 0

    # Include mode tests
    - name: Check if include mode file exists
      ansible.builtin.stat:
        path: /etc/nginx/test_include.conf
      register: include_file

    - name: Verify include mode does NOT create sites-available file
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/test_include.conf
      register: include_vhost
      failed_when: include_vhost.stat.exists

    - name: Verify include mode does NOT create sites-enabled symlink
      ansible.builtin.stat:
        path: /etc/nginx/sites-enabled/test_include.conf
      register: include_enabled
      failed_when: include_enabled.stat.exists

    - name: Verify include file contains location block
      ansible.builtin.shell: |
        set -e
        grep -F 'location /testapp/ {' /etc/nginx/test_include.conf
      register: include_location
      changed_when: false
      failed_when: include_location.rc != 0

    - name: Verify include file contains proxy_pass
      ansible.builtin.shell: |
        set -e
        grep -F 'proxy_pass http://127.0.0.1:9000;' /etc/nginx/test_include.conf
      register: include_proxy
      changed_when: false
      failed_when: include_proxy.rc != 0

    - name: Verify include file does NOT contain server block
      ansible.builtin.shell: |
        set -e
        ! grep -q '^server {' /etc/nginx/test_include.conf
      register: include_no_server
      changed_when: false
      failed_when: include_no_server.rc != 0

    - name: Check if htpasswd file for include mode exists
      ansible.builtin.stat:
        path: /etc/nginx/.htpasswd_test_include
      register: include_htpasswd

    - name: Display test results
      ansible.builtin.debug:
        msg:
          - "Nginx service: {{ 'OK' if not nginx_service.changed else 'FAILED' }}"
          - "Nginx syntax: {{ 'OK' if nginx_syntax.rc == 0 else 'FAILED' }}"
          - "Normalize actions: {{ 'OK' if normalize_check.rc == 0 else 'FAILED' }}"
          - "Add headers normalized: {{ 'OK' if addhdr_check.rc == 0 else 'FAILED' }}"
          - "FastCGI params: {{ 'OK' if fpmparam_check.rc == 0 else 'FAILED' }}"
          - "Proxy headers normalized: {{ 'OK' if proxyhdr_check.rc == 0 else 'FAILED' }}"
          - "Proxy redirect normalized: {{ 'OK' if proxyredir_check.rc == 0 else 'FAILED' }}"
          - "Rewrite lines normalized: {{ 'OK' if rewrite_check.rc == 0 else 'FAILED' }}"
          - "Ethercalc vhost exists: {{ 'OK' if ethercalc_vhost.stat.exists else 'FAILED' }}"
          - "Ethercalc enabled: {{ 'OK' if ethercalc_enabled.stat.exists else 'FAILED' }}"
          - "Proxy config: {{ 'OK' if not proxy_config.changed else 'FAILED' }}"
          - "Nginx connectivity: {{ 'OK' if nginx_connection is succeeded else 'FAILED' }}"
          - "No external refs: {{ 'OK' if external_refs.matched == 0 else 'FAILED' }}"
          - "Include file exists: {{ 'OK' if include_file.stat.exists else 'FAILED' }}"
          - "Include mode no vhost: {{ 'OK' if not include_vhost.stat.exists else 'FAILED' }}"
          - "Include mode no enabled: {{ 'OK' if not include_enabled.stat.exists else 'FAILED' }}"
          - "Include has location: {{ 'OK' if include_location.rc == 0 else 'FAILED' }}"
          - "Include has proxy: {{ 'OK' if include_proxy.rc == 0 else 'FAILED' }}"
          - "Include no server block: {{ 'OK' if include_no_server.rc == 0 else 'FAILED' }}"
          - "Include htpasswd exists: {{ 'OK' if include_htpasswd.stat.exists else 'FAILED' }}"
