---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Check if nginx is running
      ansible.builtin.service:
        name: nginx
        state: started
      check_mode: true
      register: nginx_service
      failed_when: nginx_service.changed

    - name: Check nginx configuration syntax
      ansible.builtin.command: nginx -t
      register: nginx_syntax
      changed_when: false

    - name: Check if ethercalc vhost config exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/ethercalc.conf
      register: ethercalc_vhost

    - name: Verify ethercalc vhost is enabled
      ansible.builtin.stat:
        path: /etc/nginx/sites-enabled/ethercalc.conf
      register: ethercalc_enabled

    - name: Check nginx proxy configuration is valid
      ansible.builtin.lineinfile:
        path: /etc/nginx/sites-available/ethercalc.conf
        line: "proxy_pass http://127.0.0.1:8000;"
        state: absent
      check_mode: true
      register: proxy_config
      failed_when: proxy_config.changed

    - name: Test that nginx accepts connections (basic connectivity)
      ansible.builtin.wait_for:
        port: 80
        host: localhost
        delay: 1
        timeout: 10
      register: nginx_connection

    - name: Verify nginx_mono templates are self-contained
      ansible.builtin.find:
        paths: /etc/nginx/sites-available/
        patterns: "*.conf"
        contains: "templates/nginx/"
      register: external_refs
      failed_when: external_refs.matched > 0

    - name: Display test results
      ansible.builtin.debug:
        msg:
          - "Nginx service: {{ 'OK' if not nginx_service.changed else 'FAILED' }}"
          - "Nginx syntax: {{ 'OK' if nginx_syntax.rc == 0 else 'FAILED' }}"
          - "Ethercalc vhost exists: {{ 'OK' if ethercalc_vhost.stat.exists else 'FAILED' }}"
          - "Ethercalc enabled: {{ 'OK' if ethercalc_enabled.stat.exists else 'FAILED' }}"
          - "Proxy config: {{ 'OK' if not proxy_config.changed else 'FAILED' }}"
          - "Nginx connectivity: {{ 'OK' if nginx_connection is succeeded else 'FAILED' }}"
          - "No external refs: {{ 'OK' if external_refs.matched == 0 else 'FAILED' }}"
