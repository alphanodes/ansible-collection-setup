---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Check if nginx is running
      ansible.builtin.service:
        name: nginx
        state: started
      check_mode: true
      register: nginx_service
      failed_when: nginx_service.changed

    - name: Check nginx configuration syntax
      ansible.builtin.command: nginx -t
      register: nginx_syntax
      changed_when: false

    - name: Verify action normalization (no double semicolons)
      ansible.builtin.shell: |
        set -euo pipefail
        awk '/location \/_ping/,/}/ {print}' /etc/nginx/sites-available/ethercalc.conf | grep -E "add_header X-Ping pong;\$|return 204;\$"
      args:
        executable: /bin/bash
      register: normalize_check
      changed_when: false
      failed_when: normalize_check.rc != 0

    - name: Verify additional_headers normalization
      ansible.builtin.shell: |
        set -e
        grep -F 'add_header X-Test-Header "ok";' /etc/nginx/sites-available/ethercalc.conf
        grep -F 'add_header X-Second "yes";' /etc/nginx/sites-available/ethercalc.conf
      register: addhdr_check
      changed_when: false
      failed_when: addhdr_check.rc != 0

    - name: Verify fastcgi_params normalization (rendered but harmless)
      ansible.builtin.shell: |
        set -e
        # fastcgi_param may or may not be present depending on config; accept absence gracefully
        ! grep -q 'fastcgi_param .*;;' /etc/nginx/sites-available/ethercalc.conf
      register: fpmparam_check
      changed_when: false
      failed_when: fpmparam_check.rc != 0

    - name: Verify proxy_headers normalization
      ansible.builtin.shell: |
        set -e
        grep -F 'proxy_set_header X-Forwarded-Proto $scheme;' /etc/nginx/sites-available/ethercalc.conf
      register: proxyhdr_check
      changed_when: false
      failed_when: proxyhdr_check.rc != 0

    - name: Verify proxy_redirect normalization
      ansible.builtin.shell: |
        set -euo pipefail
        awk '/location \/ \{/,/}/ {print}' /etc/nginx/sites-available/ethercalc.conf | grep -E "^\s*proxy_redirect off;\s*$"
      args:
        executable: /bin/bash
      register: proxyredir_check
      changed_when: false
      failed_when: proxyredir_check.rc != 0

    - name: Verify rewrite_lines normalization
      ansible.builtin.shell: |
        set -e
        grep -E '^\s*rewrite \^/old/\(\.\*\) /new/\$1 permanent;\s*$' /etc/nginx/sites-available/ethercalc.conf
      register: rewrite_check
      changed_when: false
      failed_when: rewrite_check.rc != 0

    - name: Check if ethercalc vhost config exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/ethercalc.conf
      register: ethercalc_vhost

    - name: Verify ethercalc vhost is enabled
      ansible.builtin.stat:
        path: /etc/nginx/sites-enabled/ethercalc.conf
      register: ethercalc_enabled

    - name: Check nginx proxy configuration is valid
      ansible.builtin.lineinfile:
        path: /etc/nginx/sites-available/ethercalc.conf
        line: "proxy_pass http://127.0.0.1:8000;"
        state: absent
      check_mode: true
      register: proxy_config
      failed_when: proxy_config.changed

    - name: Test that nginx accepts connections (basic connectivity)
      ansible.builtin.wait_for:
        port: 80
        host: localhost
        delay: 1
        timeout: 10
      register: nginx_connection

    - name: Verify nginx_mono templates are self-contained
      ansible.builtin.find:
        paths: /etc/nginx/sites-available/
        patterns: "*.conf"
        contains: "templates/nginx/"
      register: external_refs
      failed_when: external_refs.matched > 0

    # Include mode tests
    - name: Check if include mode file exists
      ansible.builtin.stat:
        path: /etc/nginx/test_include.conf
      register: include_file

    - name: Verify include mode does NOT create sites-available file
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/test_include.conf
      register: include_vhost
      failed_when: include_vhost.stat.exists

    - name: Verify include mode does NOT create sites-enabled symlink
      ansible.builtin.stat:
        path: /etc/nginx/sites-enabled/test_include.conf
      register: include_enabled
      failed_when: include_enabled.stat.exists

    - name: Verify include file contains location block
      ansible.builtin.shell: |
        set -e
        grep -F 'location /testapp/ {' /etc/nginx/test_include.conf
      register: include_location
      changed_when: false
      failed_when: include_location.rc != 0

    - name: Verify include file contains proxy_pass
      ansible.builtin.shell: |
        set -e
        grep -F 'proxy_pass http://127.0.0.1:9000;' /etc/nginx/test_include.conf
      register: include_proxy
      changed_when: false
      failed_when: include_proxy.rc != 0

    - name: Verify include file does NOT contain server block
      ansible.builtin.shell: |
        set -e
        ! grep -q '^server {' /etc/nginx/test_include.conf
      register: include_no_server
      changed_when: false
      failed_when: include_no_server.rc != 0

    - name: Check if htpasswd file for include mode exists
      ansible.builtin.stat:
        path: /etc/nginx/.htpasswd_test_include
      register: include_htpasswd

    # Instance mode (nginx_vhosts) tests
    - name: Check if parking vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/parking.conf
      register: parking_vhost

    - name: Check if parking vhost is enabled
      ansible.builtin.stat:
        path: /etc/nginx/sites-enabled/parking.conf
      register: parking_enabled

    - name: Verify parking vhost has default_server flag
      ansible.builtin.shell: |
        set -eo pipefail
        grep -E 'listen [0-9]+ default_server|listen 80 default_server' /etc/nginx/sites-available/parking.conf
      args:
        executable: /bin/bash
      register: parking_default
      changed_when: false
      failed_when: parking_default.rc != 0

    - name: Verify parking vhost comment uses instance.name
      ansible.builtin.shell: |
        set -e
        grep -F '# nginx parking vhost configuration' /etc/nginx/sites-available/parking.conf
      register: parking_comment
      changed_when: false
      failed_when: parking_comment.rc != 0

    - name: Check if static_site vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/static_site.conf
      register: static_vhost

    - name: Check if htpasswd for static_site exists (without nginx_ prefix)
      ansible.builtin.stat:
        path: /etc/nginx/.htpasswd_static_site
      register: static_htpasswd

    - name: Verify static_site vhost has auth_basic configured
      ansible.builtin.shell: |
        set -e
        grep -F 'auth_basic_user_file /etc/nginx/.htpasswd_static_site;' /etc/nginx/sites-available/static_site.conf
      register: static_auth
      changed_when: false
      failed_when: static_auth.rc != 0

    - name: Verify static_site has error_404 configured
      ansible.builtin.shell: |
        set -e
        grep -F 'error_page 404 /404.html;' /etc/nginx/sites-available/static_site.conf
      register: static_error404
      changed_when: false
      failed_when: static_error404.rc != 0

    - name: Check if php_app vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/php_app.conf
      register: php_vhost

    - name: Verify php_app vhost has FPM configuration
      ansible.builtin.shell: |
        set -e
        grep -F 'fastcgi_pass' /etc/nginx/sites-available/php_app.conf
      register: php_fpm
      changed_when: false
      failed_when: php_fpm.rc != 0

    - name: Check if proxy_app vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/proxy_app.conf
      register: proxy_vhost

    - name: Verify proxy_app vhost has proxy_pass configured
      ansible.builtin.shell: |
        set -e
        grep -F 'proxy_pass http://127.0.0.1:3000;' /etc/nginx/sites-available/proxy_app.conf
      register: proxy_pass
      changed_when: false
      failed_when: proxy_pass.rc != 0

    # block_unsafe_methods tests
    - name: Check if static_safe vhost exists (block_unsafe_methods enabled)
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/static_safe.conf
      register: safe_vhost

    - name: Check if static_open vhost exists (block_unsafe_methods disabled)
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/static_open.conf
      register: open_vhost

    - name: Verify static_safe has not_allowed_method protection
      ansible.builtin.shell: |
        set -e
        grep -F 'if ($not_allowed_method)' /etc/nginx/sites-available/static_safe.conf
        grep -F 'return 405;' /etc/nginx/sites-available/static_safe.conf
      register: safe_method_check
      changed_when: false
      failed_when: safe_method_check.rc != 0

    - name: Verify static_open does NOT have not_allowed_method protection
      ansible.builtin.shell: |
        set -e
        ! grep -q 'if ($not_allowed_method)' /etc/nginx/sites-available/static_open.conf
      register: open_method_check
      changed_when: false
      failed_when: open_method_check.rc != 0

    - name: Test PUT request to safe.local returns 405 (blocked)
      ansible.builtin.command: >
        curl -s -o /dev/null -w '%{http_code}' -X PUT -H 'Host: safe.local'
        http://127.0.0.1/
      register: safe_put_response
      changed_when: false
      failed_when: safe_put_response.stdout != '405'

    - name: Test DELETE request to safe.local returns 405 (blocked)
      ansible.builtin.command: >
        curl -s -o /dev/null -w '%{http_code}' -X DELETE -H 'Host: safe.local'
        http://127.0.0.1/
      register: safe_delete_response
      changed_when: false
      failed_when: safe_delete_response.stdout != '405'

    - name: Test GET request to safe.local works (allowed method)
      ansible.builtin.command: >
        curl -s -o /dev/null -w '%{http_code}' -X GET -H 'Host: safe.local'
        http://127.0.0.1/
      register: safe_get_response
      changed_when: false
      failed_when: safe_get_response.stdout != '200'

    # raw_actions tests (server-level raw nginx directives)
    - name: Check if raw_actions_test vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/raw_actions_test.conf
      register: raw_actions_vhost

    - name: Verify raw_actions_test vhost contains rewrite rule
      ansible.builtin.shell: |
        set -e
        grep -F 'if (!-f $request_filename)' /etc/nginx/sites-available/raw_actions_test.conf
        grep -F 'rewrite ^(.*)$ /index.php?q=$1 last;' /etc/nginx/sites-available/raw_actions_test.conf
      register: raw_actions_check
      changed_when: false
      failed_when: raw_actions_check.rc != 0

    - name: Verify raw_actions indentation is correct (2 spaces)
      ansible.builtin.shell: |
        set -e
        grep -E '^\s{2}if \(!\-f' /etc/nginx/sites-available/raw_actions_test.conf
        grep -E '^\s{4}rewrite' /etc/nginx/sites-available/raw_actions_test.conf
      register: raw_actions_indent
      changed_when: false
      failed_when: raw_actions_indent.rc != 0

    - name: Display test results
      ansible.builtin.debug:
        msg:
          - "=== Service Mode Tests ==="
          - "Nginx service: {{ 'OK' if not nginx_service.changed else 'FAILED' }}"
          - "Nginx syntax: {{ 'OK' if nginx_syntax.rc == 0 else 'FAILED' }}"
          - "Normalize actions: {{ 'OK' if normalize_check.rc == 0 else 'FAILED' }}"
          - "Add headers normalized: {{ 'OK' if addhdr_check.rc == 0 else 'FAILED' }}"
          - "FastCGI params: {{ 'OK' if fpmparam_check.rc == 0 else 'FAILED' }}"
          - "Proxy headers normalized: {{ 'OK' if proxyhdr_check.rc == 0 else 'FAILED' }}"
          - "Proxy redirect normalized: {{ 'OK' if proxyredir_check.rc == 0 else 'FAILED' }}"
          - "Rewrite lines normalized: {{ 'OK' if rewrite_check.rc == 0 else 'FAILED' }}"
          - "Ethercalc vhost exists: {{ 'OK' if ethercalc_vhost.stat.exists else 'FAILED' }}"
          - "Ethercalc enabled: {{ 'OK' if ethercalc_enabled.stat.exists else 'FAILED' }}"
          - "Proxy config: {{ 'OK' if not proxy_config.changed else 'FAILED' }}"
          - "Nginx connectivity: {{ 'OK' if nginx_connection is succeeded else 'FAILED' }}"
          - "No external refs: {{ 'OK' if external_refs.matched == 0 else 'FAILED' }}"
          - "=== Include Mode Tests ==="
          - "Include file exists: {{ 'OK' if include_file.stat.exists else 'FAILED' }}"
          - "Include mode no vhost: {{ 'OK' if not include_vhost.stat.exists else 'FAILED' }}"
          - "Include mode no enabled: {{ 'OK' if not include_enabled.stat.exists else 'FAILED' }}"
          - "Include has location: {{ 'OK' if include_location.rc == 0 else 'FAILED' }}"
          - "Include has proxy: {{ 'OK' if include_proxy.rc == 0 else 'FAILED' }}"
          - "Include no server block: {{ 'OK' if include_no_server.rc == 0 else 'FAILED' }}"
          - "Include htpasswd exists: {{ 'OK' if include_htpasswd.stat.exists else 'FAILED' }}"
          - "=== Instance Mode (nginx_vhosts) Tests ==="
          - "Parking vhost exists: {{ 'OK' if parking_vhost.stat.exists else 'FAILED' }}"
          - "Parking vhost enabled: {{ 'OK' if parking_enabled.stat.exists else 'FAILED' }}"
          - "Parking has default_server: {{ 'OK' if parking_default.rc == 0 else 'FAILED' }}"
          - "Parking comment correct: {{ 'OK' if parking_comment.rc == 0 else 'FAILED' }}"
          - "Static vhost exists: {{ 'OK' if static_vhost.stat.exists else 'FAILED' }}"
          - "Static htpasswd exists: {{ 'OK' if static_htpasswd.stat.exists else 'FAILED' }}"
          - "Static auth_basic correct: {{ 'OK' if static_auth.rc == 0 else 'FAILED' }}"
          - "Static error_404 configured: {{ 'OK' if static_error404.rc == 0 else 'FAILED' }}"
          - "PHP vhost exists: {{ 'OK' if php_vhost.stat.exists else 'FAILED' }}"
          - "PHP FPM configured: {{ 'OK' if php_fpm.rc == 0 else 'FAILED' }}"
          - "Proxy vhost exists: {{ 'OK' if proxy_vhost.stat.exists else 'FAILED' }}"
          - "Proxy pass configured: {{ 'OK' if proxy_pass.rc == 0 else 'FAILED' }}"
          - "=== block_unsafe_methods Tests ==="
          - "Safe vhost exists: {{ 'OK' if safe_vhost.stat.exists else 'FAILED' }}"
          - "Open vhost exists: {{ 'OK' if open_vhost.stat.exists else 'FAILED' }}"
          - "Safe has method protection: {{ 'OK' if safe_method_check.rc == 0 else 'FAILED' }}"
          - "Open has NO method protection: {{ 'OK' if open_method_check.rc == 0 else 'FAILED' }}"
          - "Safe PUT returns 405: {{ 'OK' if safe_put_response.stdout == '405' else 'FAILED' }}"
          - "Safe DELETE returns 405: {{ 'OK' if safe_delete_response.stdout == '405' else 'FAILED' }}"
          - "Safe GET returns 200: {{ 'OK' if safe_get_response.stdout == '200' else 'FAILED' }}"
          - "=== raw_actions Tests ==="
          - "raw_actions vhost exists: {{ 'OK' if raw_actions_vhost.stat.exists else 'FAILED' }}"
          - "raw_actions rewrite rule: {{ 'OK' if raw_actions_check.rc == 0 else 'FAILED' }}"
          - "raw_actions indentation: {{ 'OK' if raw_actions_indent.rc == 0 else 'FAILED' }}"
