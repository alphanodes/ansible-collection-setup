---
- name: Converge
  hosts: all
  become: true

  pre_tasks:
    - name: Update apt cache.
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false

    - name: Install required packages for nginx and nodejs
      ansible.builtin.apt:
        name:
          - git
          - redis-server
        state: present

    - name: Create test directories for block_unsafe_methods tests
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /srv/static_safe
        - /srv/static_open
        - /srv/raw_test
        - /srv/named_test
        - /srv/buffer_test
        - /srv/ratelimit_test
        - /srv/protection_test
        - /srv/default_redirect_test

    - name: Create test index files
      ansible.builtin.copy:
        content: "<html><body>{{ item.name }}</body></html>"
        dest: "{{ item.path }}/index.html"
        mode: '0644'
      loop:
        - { name: "safe", path: "/srv/static_safe" }
        - { name: "open", path: "/srv/static_open" }

  vars:
    # nodejs configuration (fix for Docker container)
    nodejs_install_npm_user: root
    npm_config_prefix: /root/.npm-global
    npm_config_unsafe_perm: "true"

    # nginx_mono configuration
    nginx_with_ssl: false  # Disable SSL for testing
    nginx_with_ipv6: false
    nginx_force_ssl: false
    nginx_with_websocket: true  # Enable WebSocket globally for testing
    nginx_resolver: ['8.8.8.8', '8.8.4.4']  # Fix undefined hoster variable
    hoster: 'local'  # Define hoster for testing
    # Rate limit zones for Test 9 (must be defined globally, written on first nginx_mono call)
    nginx_limit_req_zones:
      - "$binary_remote_addr zone=test_api:10m rate=10r/s"
      - "$binary_remote_addr zone=test_form:10m rate=5r/m"

    # PHP-FPM configuration (for nginx_vhosts FPM tests)
    php_fpm_listen: /run/php/php-fpm.sock
    php_fpm_base: /run/php/php-fpm

    # ethercalc configuration
    ethercalc_enabled: true
    ethercalc_vhost_server: test.local
    ethercalc_ip: 127.0.0.1
    ethercalc_port: 8000
    ethercalc_redis_enabled: false  # Disable Redis for testing
    ethercalc_vhost_users: []  # No auth for testing
    ethercalc_vhost_for_zabbix: false
    ethercalc_vhost_letsencrypt: false

    # No SSL certs needed for testing
    ssl_certs: []

  roles:
    # Test 1: Full vhost mode (default behavior)
    - role: alphanodes.setup.nginx_mono
      vars:
        nginx_mono_service_name: ethercalc
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: "{{ ethercalc_vhost_server }}"
          root: "/srv/ethercalc"
          index: "index.html"
          proxy_pass: "http://{{ ethercalc_ip }}:{{ ethercalc_port }}"
          proxy_location: "/"
          proxy_websocket: true
          proxy_headers:
            - "X-Forwarded-Proto $scheme"
            - "X-Forwarded-Host $host"
          proxy_redirect: "off"
          additional_headers:
            - 'X-Test-Header "ok"'
            - 'X-Second "yes"'
          rewrite_lines:
            - '^/old/(.*) /new/$1 permanent'
            - '^/x/(.*) /y/$1 last'
          # intentionally mix actions with and without semicolons
          locations:
            - name: "/_health"
              action: "return 200"
            - name: "/_ping"
              actions:
                - "add_header X-Ping pong"
                - "return 204"
          vhost_users: []
          vhost_for_zabbix: false
          letsencrypt: false

    # Test 2: Include mode (for path-based deployments)
    - role: alphanodes.setup.nginx_mono
      vars:
        nginx_mono_include_mode: true
        nginx_mono_service_name: test_include
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          proxy_pass: "http://127.0.0.1:9000"
          proxy_location: "/testapp/"
          proxy_headers:
            - "X-Include-Test true"
          vhost_users:
            - user: testuser
              password: testpass
          vhost_for_zabbix: false
          letsencrypt: false

    # Test 3: block_unsafe_methods enabled (should reject PUT/DELETE with 405)
    - role: alphanodes.setup.nginx_mono
      vars:
        nginx_mono_service_name: static_safe
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: safe.local
          root: /srv/static_safe
          index: index.html
          block_unsafe_methods: true
          vhost_for_zabbix: false
          letsencrypt: false

    # Test 4: block_unsafe_methods disabled (default - should allow PUT/DELETE)
    - role: alphanodes.setup.nginx_mono
      vars:
        nginx_mono_service_name: static_open
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: open.local
          root: /srv/static_open
          index: index.html
          # block_unsafe_methods: false  # default
          vhost_for_zabbix: false
          letsencrypt: false

    # Test 5: raw_actions at server level (like vimbadmin rewrite rule)
    - role: alphanodes.setup.nginx_mono
      vars:
        nginx_mono_service_name: raw_actions_test
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: raw.local
          root: /srv/raw_test
          index: index.php index.html
          raw_actions:
            - |
              if (!-f $request_filename) {
                rewrite ^(.*)$ /index.php?q=$1 last;
                break;
              }
          vhost_for_zabbix: false
          letsencrypt: false

    # Test 6: Instance mode with nginx_vhosts
    # Note: vhost_default is tested in Test 12 (default_redirect_test)
    - role: alphanodes.setup.nginx_mono
      vars:
        nginx_vhosts:
          - name: parking
            server_name: parking.local
            root: /srv/parking
            index: index.html
            vhost_for_zabbix: false
          - name: static_site
            server_name: static.local
            root: /srv/static
            index: index.html
            vhost_users:
              - user: admin
                password: secret123
            auth_basic_realm: "Restricted Area"
            error_404_enabled: true
          - name: php_app
            server_name: php.local
            root: /srv/php
            index: index.php index.html
            with_fpm: true
            vhost_for_zabbix: false
          - name: proxy_app
            server_name: proxy.local
            proxy_pass: "http://127.0.0.1:3000"
            proxy_location: "/"
            vhost_for_zabbix: false

    # Test 7: Named location with proxy_pass (like Redmine @puma pattern)
    - role: alphanodes.setup.nginx_mono
      vars:
        nginx_mono_service_name: named_location_test
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: named.local
          root: /srv/named_test
          index: index.html
          upstream_name: backend_app
          upstream_servers:
            - "127.0.0.1:3000"
          locations:
            # Root location with try_files to named location
            - name: "/"
              raw_actions:
                - "try_files $uri @backend;"
            # Named location with proxy_pass
            - name: "@backend"
              proxy_pass: "http://backend_app"
              proxy_timeout: 300
            # WebSocket named location (like ActionCable)
            - name: "/cable"
              proxy_pass: "http://backend_app/cable"
              proxy_websocket: true
          vhost_for_zabbix: false
          letsencrypt: false

    # Test 8: Proxy buffer settings
    - role: alphanodes.setup.nginx_mono
      vars:
        nginx_mono_service_name: buffer_test
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: buffer.local
          root: /srv/buffer_test
          proxy_pass: "http://127.0.0.1:3000"
          proxy_location: "/"
          proxy_buffers: "16 128k"
          proxy_buffer_size: "128k"
          proxy_busy_buffers_size: "256k"
          vhost_for_zabbix: false
          letsencrypt: false

    # Test 9: Rate limiting (zones are defined globally in vars section)
    - role: alphanodes.setup.nginx_mono
      vars:
        nginx_mono_service_name: ratelimit_test
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: ratelimit.local
          root: /srv/ratelimit_test
          index: index.html
          # Use rate limiting in server block
          limit_req:
            - "zone=test_api burst=20 nodelay"
            - "zone=test_form burst=5"
          limit_req_status: 429
          vhost_for_zabbix: false
          letsencrypt: false

    # Test 10: Custom protection rules
    - role: alphanodes.setup.nginx_mono
      vars:
        nginx_mono_service_name: protection_test
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: protection.local
          root: /srv/protection_test
          index: index.html
          custom_protection_rules:
            - "if ($bad_bot) { return 403; }"
            - "if ($request_uri ~* \"^/admin\") { return 404; }"
          vhost_for_zabbix: false
          letsencrypt: false

    # Test 11: Custom htpasswd_name (like Redmine pattern: role_instance)
    - role: alphanodes.setup.nginx_mono
      vars:
        nginx_mono_service_name: myapp
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: myapp.local
          root: /srv/protection_test
          index: index.html
          htpasswd_name: "redmine_myapp"
          vhost_users:
            - user: admin
              password: secret123
          auth_basic_realm: "Restricted access only"
          vhost_for_zabbix: false
          letsencrypt: false

    # Test 12: vhost_default with redirect (like Redmine with wildcard DNS)
    # When vhost_default is true, a separate redirect server block should be created
    # that catches unknown hosts and redirects to the canonical server_name
    - role: alphanodes.setup.nginx_mono
      vars:
        nginx_mono_service_name: default_redirect_test
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: canonical.local
          root: /srv/default_redirect_test
          index: index.html
          vhost_default: true
          vhost_for_zabbix: false
          letsencrypt: false

    # Test 13: vhost_users WITHOUT auth_basic_realm (like Redmine with pghero/pg_extras)
    # When vhost_users is defined but NO auth_basic_realm, the htpasswd file should be
    # created but NO auth_basic should be set at server level. This is important for
    # Redmine where only specific locations (/pghero, /pg_extras) use the htpasswd file.
    - role: alphanodes.setup.nginx_mono
      vars:
        nginx_mono_service_name: htpasswd_only_test
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: htpasswd-only.local
          root: /srv/protection_test
          index: index.html
          # vhost_users defined but NO auth_basic_realm - htpasswd file should be created
          # but NO auth_basic at server level
          vhost_users:
            - user: pghero_user
              password: pghero_pass
          vhost_for_zabbix: false
          letsencrypt: false

    # Test 14: Vhost mode with proxy_pass and vhost_users but NO auth_basic_realm (like Grafana)
    # When a normal vhost has proxy_pass and vhost_users defined (but no auth_basic_realm),
    # auth_basic should be set at location level in proxy.inc.j2 with default realm.
    - role: alphanodes.setup.nginx_mono
      vars:
        nginx_mono_service_name: proxy_auth_test
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: proxy-auth.local
          proxy_pass: "http://127.0.0.1:3000/"
          proxy_location: "/"
          # vhost_users defined but NO auth_basic_realm - should still have auth_basic
          # in proxy location with default realm
          vhost_users:
            - user: grafana_user
              password: grafana_pass
          vhost_for_zabbix: false
          letsencrypt: false

    # Test 15: Proxy mode with vhost_users AND auth_basic_realm (like Radicale)
    # When proxy_pass is defined AND auth_basic_realm is set, auth_basic should be
    # in proxy location with CUSTOM realm, but NOT at server level.
    - role: alphanodes.setup.nginx_mono
      vars:
        nginx_mono_service_name: proxy_custom_realm_test
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: proxy-realm.local
          proxy_pass: "http://127.0.0.1:5232/"
          proxy_location: "/"
          # Both vhost_users AND auth_basic_realm defined - like Radicale
          # auth_basic should be in proxy location with custom realm
          # NO auth_basic at server level (proxy_pass takes precedence)
          vhost_users:
            - user: radicale_user
              password: radicale_pass
          auth_basic_realm: "Radicale CalDAV/CardDAV"
          vhost_for_zabbix: false
          letsencrypt: false
