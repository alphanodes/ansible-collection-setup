---
- name: Converge
  hosts: all
  become: true

  pre_tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false

  vars:
    # Central DKIM domains dictionary
    dkim_domains:
      example.com:
        selector: dkim_key
        key_size: 2048

  roles:
    # Redis role (dependency of rspamd)
    - role: alphanodes.setup.redis_server

    # Rspamd role (calls dkim role automatically via include_role)
    - role: alphanodes.setup.rspamd
      vars:
        rspamd_worker_controller_password: '$2$testpasswordhash'
        rspamd_dkim_domain: example.com  # Lookup key in dkim_domains dict
        rspamd_enable_service: true
        rspamd_vhost_server: 'rspamd.example.com'  # Enable vhost for nginx_mono testing
        rspamd_vhost_location: '/'  # Full vhost mode
        rspamd_web_user: 'rspamd'
        rspamd_web_password: 'testpassword'
