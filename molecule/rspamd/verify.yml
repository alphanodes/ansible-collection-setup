---
- name: Verify
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Verify rspamd package is installed
      ansible.builtin.command: dpkg -l rspamd
      register: rspamd_pkg
      changed_when: false
      failed_when: rspamd_pkg.rc != 0

    - name: Verify rspamd service is running
      ansible.builtin.systemd:
        name: rspamd
      register: rspamd_service
      failed_when: rspamd_service.status.ActiveState != 'active'

    - name: Verify Redis is running (dependency)
      ansible.builtin.systemd:
        name: redis-server
      register: redis_service
      failed_when: redis_service.status.ActiveState != 'active'

    - name: Verify DKIM key exists
      ansible.builtin.stat:
        path: /var/lib/dkim/example.com/dkim_key.key
      register: dkim_key
      failed_when: not dkim_key.stat.exists

    - name: Verify DKIM key has correct owner (root)
      ansible.builtin.stat:
        path: /var/lib/dkim/example.com/dkim_key.key
      register: dkim_key_owner
      failed_when: dkim_key_owner.stat.pw_name != 'root'

    - name: Verify DKIM key has correct group (dkim)
      ansible.builtin.stat:
        path: /var/lib/dkim/example.com/dkim_key.key
      register: dkim_key_group
      failed_when: dkim_key_group.stat.gr_name != 'dkim'

    - name: Verify DKIM key has correct permissions (0640)
      ansible.builtin.stat:
        path: /var/lib/dkim/example.com/dkim_key.key
      register: dkim_key_perms
      failed_when: dkim_key_perms.stat.mode != '0640'

    - name: Verify _rspamd user is member of dkim group
      ansible.builtin.command: groups _rspamd
      register: rspamd_groups
      changed_when: false
      failed_when: "'dkim' not in rspamd_groups.stdout"

    - name: Verify rspamd DKIM configuration exists
      ansible.builtin.stat:
        path: /etc/rspamd/local.d/dkim_signing.conf
      register: dkim_conf
      failed_when: not dkim_conf.stat.exists

    - name: Verify rspamd ARC configuration exists
      ansible.builtin.stat:
        path: /etc/rspamd/local.d/arc.conf
      register: arc_conf
      failed_when: not arc_conf.stat.exists

    - name: Verify rspamd Redis configuration exists
      ansible.builtin.stat:
        path: /etc/rspamd/local.d/redis.conf
      register: redis_conf
      failed_when: not redis_conf.stat.exists

    - name: Verify rspamd milter headers configuration exists
      ansible.builtin.stat:
        path: /etc/rspamd/local.d/milter_headers.conf
      register: milter_conf
      failed_when: not milter_conf.stat.exists

    - name: Verify rspamd controller configuration exists
      ansible.builtin.stat:
        path: /etc/rspamd/local.d/worker-controller.inc
      register: controller_conf
      failed_when: not controller_conf.stat.exists

    - name: Verify rspamd proxy worker configuration exists
      ansible.builtin.stat:
        path: /etc/rspamd/local.d/worker-proxy.inc
      register: proxy_conf
      failed_when: not proxy_conf.stat.exists

    - name: Verify rspamd actions configuration exists
      ansible.builtin.stat:
        path: /etc/rspamd/local.d/actions.conf
      register: actions_conf
      failed_when: not actions_conf.stat.exists

    - name: Verify rspamd options configuration exists
      ansible.builtin.stat:
        path: /etc/rspamd/local.d/options.inc
      register: options_conf
      failed_when: not options_conf.stat.exists

    - name: Verify rspamd greylist configuration exists
      ansible.builtin.stat:
        path: /etc/rspamd/local.d/greylist.conf
      register: greylist_conf
      failed_when: not greylist_conf.stat.exists

    - name: Verify rspamd ratelimit configuration exists
      ansible.builtin.stat:
        path: /etc/rspamd/local.d/ratelimit.conf
      register: ratelimit_conf
      failed_when: not ratelimit_conf.stat.exists

    - name: Test rspamd proxy worker socket is listening (Postfix milter)
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: 11332
        timeout: 5

    - name: Test rspamd web UI socket is listening (controller)
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: 11334
        timeout: 5

    - name: Verify DKIM path pattern in rspamd config (multi-domain with $domain variable)
      ansible.builtin.command: grep -q 'path = "/var/lib/dkim/\$domain/' /etc/rspamd/local.d/dkim_signing.conf
      changed_when: false

    - name: Verify DKIM selector in rspamd config
      ansible.builtin.command: grep -q 'selector = "dkim_key"' /etc/rspamd/local.d/dkim_signing.conf
      changed_when: false

    - name: Verify allow_username_mismatch is enabled (for alias support)
      ansible.builtin.command: grep -q 'allow_username_mismatch = true' /etc/rspamd/local.d/dkim_signing.conf
      changed_when: false

    - name: Verify nginx vhost file exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/rspamd.conf
      register: nginx_vhost
      failed_when: not nginx_vhost.stat.exists

    - name: Verify nginx vhost is enabled
      ansible.builtin.stat:
        path: /etc/nginx/sites-enabled/rspamd.conf
      register: nginx_enabled
      failed_when: not nginx_enabled.stat.exists

    - name: Verify htpasswd file exists
      ansible.builtin.stat:
        path: /etc/nginx/.htpasswd_rspamd
      register: htpasswd_file
      failed_when: not htpasswd_file.stat.exists

    - name: Verify nginx configuration is valid
      ansible.builtin.command: nginx -t
      changed_when: false
