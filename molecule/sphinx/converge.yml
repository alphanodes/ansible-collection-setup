---
- name: Converge
  hosts: all
  become: true

  vars:
    # Use 'present' for idempotency tests, production uses 'latest'
    python_pip_default_state: present
    # Skip actual sphinx build (no real sphinx project)
    sphinx_always_build: false
    # Use TLS 1.3 only to skip slow dhparam generation
    nginx_ssl_protocols: 'TLSv1.3'
    # Test instance configuration
    sphinx_instances:
      - name: test_docs
        repo: /tmp/test_sphinx_repo
        vhost_users:
          - user: testuser
            password: testpassword

  pre_tasks:
    - name: Update apt cache.
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false

    # Fix for Ubuntu 24.04 Docker: man directory missing causes OpenJDK installation to fail
    # with "error creating symbolic link '/usr/share/man/man1/java.1.gz.dpkg-tmp': No such file or directory"
    - name: Ensure man pages directory exists for OpenJDK installation
      ansible.builtin.file:
        path: /usr/share/man/man1
        state: directory
        mode: '0755'

    - name: Install git for test repository
      ansible.builtin.apt:
        name: git
        state: present

    - name: Create test git repository directory
      ansible.builtin.file:
        path: /tmp/test_sphinx_repo
        state: directory
        mode: '0755'

    - name: Initialize test git repository
      ansible.builtin.command:
        cmd: git init
        chdir: /tmp/test_sphinx_repo
        creates: /tmp/test_sphinx_repo/.git

    - name: Configure git user for test repo
      ansible.builtin.command:
        cmd: "{{ item }}"
        chdir: /tmp/test_sphinx_repo
      loop:
        - git config user.email "test@example.com"
        - git config user.name "Test User"
      changed_when: false

    - name: Create test file and commit
      ansible.builtin.shell: |
        echo "Test" > README.md
        git add README.md
        git commit -m "Initial commit" || true
      args:
        chdir: /tmp/test_sphinx_repo
      changed_when: false

  roles:
    - role: alphanodes.setup.common
    - role: alphanodes.setup.sphinx
