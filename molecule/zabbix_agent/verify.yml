---
- name: Verify
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Check zabbix-agent2 is installed
      ansible.builtin.command: dpkg -l zabbix-agent2
      register: zabbix_package
      changed_when: false
      failed_when: zabbix_package.rc != 0

    - name: Check zabbix-agent2 service is running
      ansible.builtin.systemd:
        name: zabbix-agent2
      register: zabbix_service
      failed_when: zabbix_service.status.ActiveState != "active"

    - name: Check zabbix configuration file exists
      ansible.builtin.stat:
        path: /etc/zabbix/zabbix_agent2.conf
      register: zabbix_conf
      failed_when: not zabbix_conf.stat.exists

    - name: Check zabbix addons directory exists
      ansible.builtin.stat:
        path: /usr/share/zabbix_addons/scripts
      register: zabbix_addons
      failed_when: not zabbix_addons.stat.exists

    - name: Check linux_check.sh script exists
      ansible.builtin.stat:
        path: /usr/share/zabbix_addons/scripts/linux_check.sh
      register: linux_check
      failed_when: not linux_check.stat.exists

    - name: Check sudoers configuration exists
      ansible.builtin.stat:
        path: /etc/sudoers.d/zabbix
      register: zabbix_sudoers
      failed_when: not zabbix_sudoers.stat.exists

    - name: Check zabbix user exists
      ansible.builtin.getent:
        database: passwd
        key: zabbix
      register: zabbix_user

    - name: Verify zabbix agent is listening on port 10050
      ansible.builtin.wait_for:
        port: 10050
        timeout: 5

    - name: Read zabbix_agent2.conf content
      ansible.builtin.slurp:
        src: /etc/zabbix/zabbix_agent2.conf
      register: zabbix_conf_content

    - name: Decode zabbix_agent2.conf content
      ansible.builtin.set_fact:
        zabbix_conf_decoded: "{{ zabbix_conf_content.content | b64decode }}"

    - name: Verify journalctl UserParameter has joined keywords
      ansible.builtin.assert:
        that:
          - "'undefined|failed|warning|missing' in zabbix_conf_decoded"
        fail_msg: "journalctl keywords not properly joined with pipe"
        success_msg: "journalctl keywords correctly joined"

    - name: Verify journalctl_service UserParameter exists with correct pattern
      ansible.builtin.assert:
        that:
          - "'UserParameter=journalctl_service' in zabbix_conf_decoded"
          - "'grep -Ei' in zabbix_conf_decoded"
        fail_msg: "journalctl_service UserParameter not found or malformed"
        success_msg: "journalctl_service UserParameter correctly configured"

    - name: Verify ignore patterns are joined correctly
      ansible.builtin.assert:
        that:
          - "'RoutingError|WARNING' in zabbix_conf_decoded"
        fail_msg: "ignore_all patterns not properly joined"
        success_msg: "ignore_all patterns correctly joined"
