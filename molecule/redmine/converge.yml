---
- name: Converge
  hosts: all
  become: true
  vars:
    # nginx_mono configuration
    nginx_with_ipv6: false
    nginx_with_http3: false
    nginx_with_protection: true
    nginx_ssl_protocols: 'TLSv1.3'
    hoster: 'local'

    # SSL configuration - self-signed certificate for testing
    ssl_certs:
      - name: redmine
        provider: selfsigned
        subject_common_name: redmine.local

    # PostgreSQL settings
    postgresql_version: '17'
    postgresql_global_config_options:
      - option: listen_addresses
        value: localhost
    postgresql_users:
      - name: redmine
        password: test_redmine_password
        db: redmine
    postgresql_databases:
      - name: redmine
        owner: redmine

    # Redmine configuration - Full test with nginx_mono
    redmine_with_nginx: true
    redmine_with_postgresql: true
    redmine_with_mysql: false
    redmine_with_memcache: false
    redmine_use_rvm_as_default: false
    redmine_repo_update: false

    # Skip actual Redmine deployment but configure nginx
    redmine_skip_deploy: true

    redmine_instances:
      redmine:
        server_name: redmine.local
        adapter: postgresql
        db_password: test_redmine_password
        letsencrypt_cert: false
        vhost_ssl_cert: redmine
        vhost_default: true
        vhost_for_zabbix: false
      redmine_agile:
        server_name: agile.local
        adapter: postgresql
        db_password: test_redmine_password
        letsencrypt_cert: false
        vhost_ssl_cert: redmine
        with_agile: true
        vhost_for_zabbix: false

  pre_tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false

    - name: Create redmine system user
      ansible.builtin.user:
        name: redmine
        system: true
        home: /srv/redmine
        shell: /bin/bash
        create_home: true

    - name: Create redmine_agile system user
      ansible.builtin.user:
        name: redmine_agile
        system: true
        home: /srv/redmine_agile
        shell: /bin/bash
        create_home: true

    - name: Create redmine directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: redmine
        group: redmine
        mode: '0755'
      loop:
        - /srv/redmine/redmine
        - /srv/redmine/redmine/public
        - /srv/redmine/files
        - /run/redmine

    - name: Create redmine_agile directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: redmine_agile
        group: redmine_agile
        mode: '0755'
      loop:
        - /srv/redmine_agile/redmine
        - /srv/redmine_agile/redmine/public
        - /srv/redmine_agile/files
        - /run/redmine_agile

    - name: Create dummy index.html for testing
      ansible.builtin.copy:
        content: |
          <!DOCTYPE html>
          <html>
          <head><title>Redmine Test</title></head>
          <body><h1>Redmine Test Page</h1></body>
          </html>
        dest: "{{ item }}"
        owner: root
        group: root
        mode: '0644'
      loop:
        - /srv/redmine/redmine/public/index.html
        - /srv/redmine_agile/redmine/public/index.html

    - name: Create dummy puma socket for testing
      ansible.builtin.file:
        path: "{{ item }}"
        state: touch
        owner: root
        group: root
        mode: '0660'
      loop:
        - /run/redmine/redmine.sock
        - /run/redmine_agile/redmine.sock

  tasks:
    - name: Include common role
      ansible.builtin.include_role:
        name: alphanodes.setup.common

    - name: Include ssl role
      ansible.builtin.include_role:
        name: alphanodes.setup.ssl

    - name: Include postgresql role
      ansible.builtin.include_role:
        name: alphanodes.setup.postgresql

    - name: Install nginx package for conf.d directory
      ansible.builtin.apt:
        name: nginx
        state: present

    - name: Ensure nginx conf.d directory exists
      ansible.builtin.file:
        path: /etc/nginx/conf.d
        state: directory
        mode: '0755'

    - name: Install nginx redmine maps configuration (using real template)
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../../roles/redmine/templates/etc/nginx/redmine_maps.conf"
        dest: /etc/nginx/conf.d/redmine_maps.conf
        mode: '0644'

    - name: Include nginx_mono for redmine
      ansible.builtin.include_role:
        name: alphanodes.setup.nginx_mono
      vars:
        nginx_with_websocket: false
        nginx_mono_service_name: redmine
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: redmine.local
          root: /srv/redmine/redmine/public
          index: index.html
          vhost_default: true
          vhost_for_zabbix: false
          letsencrypt: false
          ssl_cert: redmine
          upstream_name: redmine
          upstream_servers:
            - "unix:/run/redmine/redmine.sock"
          custom_protection_rules:
            - "if ($bad_redmine_locations) { return 404; }"
          locations:
            - name: "/"
              raw_actions:
                - "try_files $uri @puma;"
            - name: "@puma"
              proxy_pass: "http://redmine"
              proxy_timeout: "120"
              proxy_buffers: "16 128k"
              proxy_buffer_size: "128k"
              proxy_busy_buffers_size: "256k"

    - name: Include nginx_mono for redmine_agile (with WebSocket)
      ansible.builtin.include_role:
        name: alphanodes.setup.nginx_mono
      vars:
        nginx_with_websocket: true
        nginx_mono_service_name: redmine_agile
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: agile.local
          root: /srv/redmine_agile/redmine/public
          index: index.html
          vhost_for_zabbix: false
          letsencrypt: false
          ssl_cert: redmine
          upstream_name: redmine_agile
          upstream_servers:
            - "unix:/run/redmine_agile/redmine.sock"
          custom_protection_rules:
            - "if ($bad_redmine_locations) { return 404; }"
          locations:
            - name: "/"
              raw_actions:
                - "try_files $uri @puma;"
            - name: "@puma"
              proxy_pass: "http://redmine_agile"
              proxy_timeout: "120"
              proxy_buffers: "16 128k"
              proxy_buffer_size: "128k"
              proxy_busy_buffers_size: "256k"
            - name: "/rup_cable_agile"
              proxy_pass: "http://redmine_agile/rup_cable_agile"
              proxy_websocket: true
              proxy_timeout: "120"
