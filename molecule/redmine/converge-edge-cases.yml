---
# Edge case tests for Redmine nginx_mono integration
# Tests: custom port, vhost_users (basic auth), redirects
- name: Converge Edge Cases
  hosts: all
  become: true
  vars:
    # nginx_mono configuration
    nginx_with_ipv6: false
    nginx_with_http3: false
    nginx_with_protection: true
    nginx_ssl_protocols: 'TLSv1.3'
    hoster: 'local'

    # SSL configuration - self-signed certificate for testing
    ssl_certs:
      - name: redmine
        provider: selfsigned
        subject_common_name: redmine.local

    # PostgreSQL settings
    postgresql_version: '17'
    postgresql_global_config_options:
      - option: listen_addresses
        value: localhost
    postgresql_users:
      - name: redmine
        password: test_redmine_password
        db: redmine
    postgresql_databases:
      - name: redmine
        owner: redmine

    # Redmine configuration
    redmine_with_nginx: true
    redmine_with_postgresql: true
    redmine_with_mysql: false
    redmine_with_memcache: false
    redmine_use_rvm_as_default: false
    redmine_repo_update: false
    redmine_skip_deploy: true

    redmine_instances:
      # Test: Custom port 8443
      redmine_custom_port:
        server_name: custom-port.local
        server_port: 8443
        adapter: postgresql
        db_password: test_redmine_password
        letsencrypt_cert: false
        vhost_ssl_cert: redmine
        vhost_for_zabbix: false

      # Test: Basic Auth with vhost_users
      redmine_protected:
        server_name: protected.local
        adapter: postgresql
        db_password: test_redmine_password
        letsencrypt_cert: false
        vhost_ssl_cert: redmine
        vhost_for_zabbix: false
        vhost_users:
          - user: testuser
            password: testpassword123

      # Test: With redirects
      redmine_redirects:
        server_name: main.local
        adapter: postgresql
        db_password: test_redmine_password
        letsencrypt_cert: false
        vhost_ssl_cert: redmine
        vhost_for_zabbix: false
        redirects:
          - old.local
          - legacy.local

  pre_tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false

    - name: Create redmine system users
      ansible.builtin.user:
        name: "{{ item }}"
        system: true
        home: "/srv/{{ item }}"
        shell: /bin/bash
        create_home: true
      loop:
        - redmine_custom_port
        - redmine_protected
        - redmine_redirects

    - name: Create redmine directories
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner }}"
        group: "{{ item.owner }}"
        mode: '0755'
      loop:
        - {path: /srv/redmine_custom_port/redmine, owner: redmine_custom_port}
        - {path: /srv/redmine_custom_port/redmine/public, owner: redmine_custom_port}
        - {path: /srv/redmine_protected/redmine, owner: redmine_protected}
        - {path: /srv/redmine_protected/redmine/public, owner: redmine_protected}
        - {path: /srv/redmine_redirects/redmine, owner: redmine_redirects}
        - {path: /srv/redmine_redirects/redmine/public, owner: redmine_redirects}

    - name: Create run directories
      ansible.builtin.file:
        path: "/run/{{ item }}"
        state: directory
        owner: "{{ item }}"
        group: "{{ item }}"
        mode: '0755'
      loop:
        - redmine_custom_port
        - redmine_protected
        - redmine_redirects

    - name: Create dummy index.html for testing
      ansible.builtin.copy:
        content: |
          <!DOCTYPE html>
          <html>
          <head><title>Redmine Test</title></head>
          <body><h1>Redmine Test Page</h1></body>
          </html>
        dest: "/srv/{{ item }}/redmine/public/index.html"
        owner: root
        group: root
        mode: '0644'
      loop:
        - redmine_custom_port
        - redmine_protected
        - redmine_redirects

    - name: Create dummy puma socket for testing
      ansible.builtin.file:
        path: "/run/{{ item }}/redmine.sock"
        state: touch
        owner: root
        group: root
        mode: '0660'
      loop:
        - redmine_custom_port
        - redmine_protected
        - redmine_redirects

  tasks:
    - name: Include common role
      ansible.builtin.include_role:
        name: alphanodes.setup.common

    - name: Include ssl role
      ansible.builtin.include_role:
        name: alphanodes.setup.ssl

    - name: Include postgresql role
      ansible.builtin.include_role:
        name: alphanodes.setup.postgresql

    - name: Install nginx package for conf.d directory
      ansible.builtin.apt:
        name: nginx
        state: present

    - name: Ensure nginx conf.d directory exists
      ansible.builtin.file:
        path: /etc/nginx/conf.d
        state: directory
        mode: '0755'

    - name: Install nginx redmine maps configuration (using real template)
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../../roles/redmine/templates/etc/nginx/redmine_maps.conf"
        dest: /etc/nginx/conf.d/redmine_maps.conf
        mode: '0644'

    # Test 1: Custom Port 8443
    - name: Include nginx_mono for redmine_custom_port (port 8443)
      ansible.builtin.include_role:
        name: alphanodes.setup.nginx_mono
      vars:
        nginx_with_websocket: false
        nginx_mono_service_name: redmine_custom_port
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: custom-port.local
          server_port: 8443
          root: /srv/redmine_custom_port/redmine/public
          index: index.html
          vhost_for_zabbix: false
          letsencrypt: false
          ssl_cert: redmine
          upstream_name: redmine_custom_port
          upstream_servers:
            - "unix:/run/redmine_custom_port/redmine.sock"
          custom_protection_rules:
            - "if ($bad_redmine_locations) { return 404; }"
          locations:
            - name: "/"
              raw_actions:
                - "try_files $uri @puma;"
            - name: "@puma"
              proxy_pass: "http://redmine_custom_port"
              proxy_timeout: "120"

    # Test 2: Basic Auth with vhost_users
    - name: Include nginx_mono for redmine_protected (with basic auth)
      ansible.builtin.include_role:
        name: alphanodes.setup.nginx_mono
      vars:
        nginx_with_websocket: false
        nginx_mono_service_name: redmine_protected
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: protected.local
          root: /srv/redmine_protected/redmine/public
          index: index.html
          vhost_for_zabbix: false
          letsencrypt: false
          ssl_cert: redmine
          upstream_name: redmine_protected
          upstream_servers:
            - "unix:/run/redmine_protected/redmine.sock"
          vhost_users:
            - user: testuser
              password: testpassword123
          custom_protection_rules:
            - "if ($bad_redmine_locations) { return 404; }"
          locations:
            - name: "/"
              raw_actions:
                - "try_files $uri @puma;"
            - name: "@puma"
              proxy_pass: "http://redmine_protected"
              proxy_timeout: "120"

    # Test 3: With redirects
    - name: Include nginx_mono for redmine_redirects
      ansible.builtin.include_role:
        name: alphanodes.setup.nginx_mono
      vars:
        nginx_with_websocket: false
        nginx_mono_service_name: redmine_redirects
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: main.local
          root: /srv/redmine_redirects/redmine/public
          index: index.html
          vhost_for_zabbix: false
          letsencrypt: false
          ssl_cert: redmine
          upstream_name: redmine_redirects
          upstream_servers:
            - "unix:/run/redmine_redirects/redmine.sock"
          redirects:
            - old.local
            - legacy.local
          custom_protection_rules:
            - "if ($bad_redmine_locations) { return 404; }"
          locations:
            - name: "/"
              raw_actions:
                - "try_files $uri @puma;"
            - name: "@puma"
              proxy_pass: "http://redmine_redirects"
              proxy_timeout: "120"
