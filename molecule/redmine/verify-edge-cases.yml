---
- name: Verify Edge Cases
  hosts: all
  become: true
  gather_facts: false
  tasks:
    - name: Check nginx is running
      ansible.builtin.command: systemctl is-active nginx
      register: nginx_status
      changed_when: false

    - name: Assert nginx is active
      ansible.builtin.assert:
        that:
          - nginx_status.rc == 0
          - nginx_status.stdout == 'active'
        fail_msg: "nginx is not running"

    - name: Check nginx configuration syntax
      ansible.builtin.command: nginx -t
      register: nginx_syntax
      changed_when: false

    - name: Assert nginx configuration is valid
      ansible.builtin.assert:
        that:
          - nginx_syntax.rc == 0
        fail_msg: "nginx configuration is invalid"

    # Test 1: Custom Port 8443
    - name: Check custom port vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/redmine_custom_port.conf
      register: custom_port_vhost

    - name: Assert custom port vhost exists
      ansible.builtin.assert:
        that:
          - custom_port_vhost.stat.exists
        fail_msg: "custom port vhost configuration does not exist"

    - name: Check custom port vhost contains port 8443
      ansible.builtin.command: grep -q "listen 8443 ssl" /etc/nginx/sites-available/redmine_custom_port.conf
      register: port_check
      changed_when: false

    - name: Assert port 8443 is configured
      ansible.builtin.assert:
        that:
          - port_check.rc == 0
        fail_msg: "port 8443 not found in vhost configuration"

    # Test 2: Basic Auth
    - name: Check protected vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/redmine_protected.conf
      register: protected_vhost

    - name: Assert protected vhost exists
      ansible.builtin.assert:
        that:
          - protected_vhost.stat.exists
        fail_msg: "protected vhost configuration does not exist"

    - name: Check htpasswd file exists
      ansible.builtin.stat:
        path: /etc/nginx/.htpasswd_redmine_protected
      register: htpasswd_file

    - name: Assert htpasswd file exists
      ansible.builtin.assert:
        that:
          - htpasswd_file.stat.exists
        fail_msg: "htpasswd file does not exist at /etc/nginx/.htpasswd_redmine_protected"

    - name: Check vhost contains auth_basic directive
      ansible.builtin.command: grep -q "auth_basic" /etc/nginx/sites-available/redmine_protected.conf
      register: auth_check
      changed_when: false

    - name: Assert auth_basic is configured
      ansible.builtin.assert:
        that:
          - auth_check.rc == 0
        fail_msg: "auth_basic directive not found in vhost"

    # Test 3: Redirects
    - name: Check redirects vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/redmine_redirects.conf
      register: redirects_vhost

    - name: Assert redirects vhost exists
      ansible.builtin.assert:
        that:
          - redirects_vhost.stat.exists
        fail_msg: "redirects vhost configuration does not exist"

    - name: Check vhost contains redirect domains
      ansible.builtin.command: grep -q "old.local" /etc/nginx/sites-available/redmine_redirects.conf
      register: redirect_check
      changed_when: false

    - name: Assert redirect domain is configured
      ansible.builtin.assert:
        that:
          - redirect_check.rc == 0
        fail_msg: "redirect domain old.local not found in vhost"

    - name: Check redirect returns 301
      ansible.builtin.command: grep -q "return 301" /etc/nginx/sites-available/redmine_redirects.conf
      register: redirect_301_check
      changed_when: false

    - name: Assert 301 redirect is configured
      ansible.builtin.assert:
        that:
          - redirect_301_check.rc == 0
        fail_msg: "301 redirect not found in vhost"

    # Test 4: Reverse proxy host forwarding
    - name: Check proxy vhost exists
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/redmine_proxy.conf
      register: proxy_vhost

    - name: Assert proxy vhost exists
      ansible.builtin.assert:
        that:
          - proxy_vhost.stat.exists
        fail_msg: "proxy vhost configuration does not exist"

    - name: Check redmine_maps.conf contains forwarded_host map
      ansible.builtin.command: grep -q "map \$http_host \$forwarded_host" /etc/nginx/conf.d/redmine_maps.conf
      register: forwarded_host_map_check
      changed_when: false

    - name: Assert forwarded_host map exists
      ansible.builtin.assert:
        that:
          - forwarded_host_map_check.rc == 0
        fail_msg: "forwarded_host map not found in redmine_maps.conf"

    - name: Check redmine_maps.conf contains proxy source mapping
      ansible.builtin.command: grep -q "int.ssl.proxy.local proxy.local" /etc/nginx/conf.d/redmine_maps.conf
      register: proxy_mapping_check
      changed_when: false

    - name: Assert proxy source mapping exists
      ansible.builtin.assert:
        that:
          - proxy_mapping_check.rc == 0
        fail_msg: "proxy source mapping not found in redmine_maps.conf"

    - name: Check vhost contains X-Forwarded-Host header
      ansible.builtin.command: grep -q "X-Forwarded-Host \$forwarded_host" /etc/nginx/sites-available/redmine_proxy.conf
      register: forwarded_host_header_check
      changed_when: false

    - name: Assert X-Forwarded-Host header is configured
      ansible.builtin.assert:
        that:
          - forwarded_host_header_check.rc == 0
        fail_msg: "X-Forwarded-Host header not found in proxy vhost"

    - name: Check vhost uses http_host for Host header
      ansible.builtin.command: grep -q "Host \$http_host" /etc/nginx/sites-available/redmine_proxy.conf
      register: http_host_check
      changed_when: false

    - name: Assert Host header uses http_host
      ansible.builtin.assert:
        that:
          - http_host_check.rc == 0
        fail_msg: "Host header should use $http_host when nginx_with_proxy_forwarded_hosts is set"

    - name: Display verification summary
      ansible.builtin.debug:
        msg: |
          Edge Cases Verification complete:
          - nginx running with valid configuration
          - Custom port 8443: vhost configured correctly
          - Basic auth: htpasswd file and auth_basic directive present
          - Redirects: redirect domains and 301 configured
          - Proxy forwarded hosts: map and headers configured correctly
