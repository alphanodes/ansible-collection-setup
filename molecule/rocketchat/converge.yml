---
- name: Converge
  hosts: all
  become: true

  pre_tasks:
    - name: Update apt cache.
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600

    - name: Add python3-debian for deb822 support
      ansible.builtin.apt:
        name: python3-debian
        state: present

  vars:
    # nginx_mono configuration (defaults + testing new features)
    nginx_with_ssl: false  # Disable SSL for testing
    nginx_with_ipv6: false
    nginx_force_ssl: false
    nginx_with_http3: false  # Test with HTTP/3 disabled (would need SSL)
    nginx_with_reuseport: true  # Test reuseport optimization
    nginx_resolver: ['8.8.8.8', '8.8.4.4']
    hoster: 'local'

    # rocketchat configuration
    rocketchat_enabled: true
    rocketchat_vhost_server: rocketchat.local
    rocketchat_internal_host: 127.0.0.1
    rocketchat_internal_port: 3000
    rocketchat_application_path: /opt/rocketchat
    rocketchat_vhost_users: []  # No auth for testing
    rocketchat_vhost_for_zabbix: false
    rocketchat_vhost_letsencrypt: false
    rocketchat_vhost_includes: []

    # No SSL certs needed for testing
    ssl_certs: []

  # Test nginx_mono directly with rocketchat configuration
  tasks:
    - name: Create rocketchat directory for testing
      ansible.builtin.file:
        path: "{{ rocketchat_application_path }}"
        state: directory
        mode: '0755'

    - name: Create dummy rocketchat service for testing
      ansible.builtin.systemd:
        name: rocketchat
        state: stopped
        enabled: false
      ignore_errors: true

    - name: Test nginx_mono configuration with rocketchat settings
      ansible.builtin.include_role:
        name: alphanodes.setup.nginx_mono
      vars:
        nginx_with_websocket: true
        nginx_mono_service_name: rocketchat
        nginx_mono_service_enabled: true
        nginx_mono_service_config:
          server_name: "{{ rocketchat_vhost_server }}"
          server_port: 80  # HTTP-only for testing
          root: "{{ rocketchat_application_path }}"
          upstream_name: rocket_chat
          upstream_servers:
            - "{{ rocketchat_internal_host }}:{{ rocketchat_internal_port }}"
          proxy_pass: "http://rocket_chat"
          proxy_location: "/"
          proxy_websocket: true
          proxy_host_header: "$host:$server_port"
          proxy_forwarded_proto: "https"
          proxy_connection_upgrade: "upgrade"
          proxy_redirect: "off"
          proxy_timeout: 86400
          proxy_headers:
            - "Referer $http_referer"
            - "X-Forwarded-Ssl on"
            - "X-Nginx-Proxy true"
          error_497_redirect: "https://$host:$server_port$request_uri"
          additional_headers:
            - "Referrer-Policy 'no-referrer'"
          vhost_users: []
          vhost_for_zabbix: false
          letsencrypt: false
