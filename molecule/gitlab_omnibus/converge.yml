---
- name: Converge
  hosts: all
  become: true

  pre_tasks:
    - name: Update apt cache.
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false

    - name: Install OpenSSL for self-signed certificate
      ansible.builtin.apt:
        name: openssl
        state: present

    - name: Create /etc/gitlab/ssl directory
      ansible.builtin.file:
        path: /etc/gitlab/ssl
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Generate self-signed SSL certificate for testing
      ansible.builtin.command:
        cmd: >
          openssl req -x509 -nodes -days 365 -newkey rsa:2048
          -keyout /etc/gitlab/ssl/gitlab-test.example.com.key
          -out /etc/gitlab/ssl/gitlab-test.example.com.crt
          -subj "/C=US/ST=Test/L=Test/O=Test/CN=gitlab-test.example.com"
        creates: /etc/gitlab/ssl/gitlab-test.example.com.crt

  vars:
    # Use a valid FQDN for testing
    gitlab_vhost_server: gitlab-test.example.com
    # Disable Let's Encrypt for testing (use self-signed cert instead)
    gitlab_vhost_letsencrypt: false

  roles:
    - role: alphanodes.setup.common
    - role: alphanodes.setup.gitlab_omnibus

  post_tasks:
    - name: Verify GitLab configuration file exists
      ansible.builtin.stat:
        path: /etc/gitlab/gitlab.rb
      register: gitlab_config

    - name: Check gitlab_omnibus role completed
      ansible.builtin.debug:
        msg: "GitLab Omnibus role executed successfully - config exists: {{ gitlab_config.stat.exists }}"
