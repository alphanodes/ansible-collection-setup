---
name: Release

on:
  push:
    tags:
      - '*'

jobs:
  release:
    name: Publish to Galaxy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set RELEASE_VERSION from tag
        shell: bash
        run: |
          REF="${GITHUB_REF_NAME}"
          if [[ "$REF" == v* ]]; then
            echo "RELEASE_VERSION=${REF#v}" >> "$GITHUB_ENV"
          else
            echo "RELEASE_VERSION=$REF" >> "$GITHUB_ENV"
          fi

      - name: Publish collection to Ansible Galaxy
        uses: artis3n/ansible_galaxy_collection@v2
        with:
          api_key: ${{ secrets.GALAXY_API_KEY }}
          galaxy_version: ${{ env.RELEASE_VERSION }}

      # Note:
      # We intentionally do not commit galaxy.yml with the new version.
      # The version used for publishing is derived from the tag only.
