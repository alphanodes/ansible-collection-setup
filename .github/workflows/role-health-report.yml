---
name: "Role Health Report"

'on':
  push:
    branches:
      - main
    paths:
      - '.github/workflows/role-health-report.yml'
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0'

jobs:
  collect-metadata:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Check out the codebase
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set matrix
        id: set-matrix
        run: |
          # Dynamically find all roles with matching molecule scenario
          ROLES=$(for role in roles/*/; do
            role_name=$(basename "$role")
            if [ -d "molecule/$role_name" ]; then
              echo "\"$role_name\""
            fi
          done | sort | tr '\n' ',' | sed 's/,$//')
          echo "matrix={\"role\":[$ROLES]}" >> $GITHUB_OUTPUT

  health-check:
    needs: collect-metadata
    runs-on: ubuntu-latest
    env:
      PY_COLORS: 1
      ANSIBLE_FORCE_COLOR: 1

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.collect-metadata.outputs.matrix) }}

    steps:
      - name: Check out the codebase
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install test dependencies
        run: |
          python -m pip install --no-cache-dir --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install gixy-ng

      - name: Collect role metadata
        id: metadata
        run: |
          ROLE="${{ matrix.role }}"

          # Count role tasks (in roles/<role>/tasks/)
          ROLE_TASKS=$(grep -r "^\s*- name:" "roles/${ROLE}/tasks/" 2>/dev/null | wc -l | tr -d ' ')
          echo "role_tasks=$ROLE_TASKS" >> $GITHUB_OUTPUT

          # Count verify tasks
          VERIFY_FILE="molecule/${{ matrix.role }}/verify.yml"
          if [ -f "$VERIFY_FILE" ]; then
            VERIFY_TASKS=$(grep -c "^\s*- name:" "$VERIFY_FILE" 2>/dev/null || echo "0")
          else
            VERIFY_TASKS="0"
          fi
          echo "verify_tasks=$VERIFY_TASKS" >> $GITHUB_OUTPUT

          # Get dependencies from meta/main.yml and include_role in tasks
          META_FILE="roles/${ROLE}/meta/main.yml"
          DEPS_LIST=""

          # From meta/main.yml
          if [ -f "$META_FILE" ]; then
            META_DEPS=$(grep -A 20 "^dependencies:" "$META_FILE" | grep "role:" | sed 's/.*role: alphanodes.setup.//' | sed 's/.*role: //' | tr '\n' ' ')
            DEPS_LIST="$META_DEPS"
          fi

          # From include_role in tasks
          if [ -d "roles/${ROLE}/tasks" ]; then
            INCLUDE_DEPS=$(grep -r "include_role" "roles/${ROLE}/tasks/" 2>/dev/null | grep "name:" | sed 's/.*name: alphanodes.setup.//' | sed 's/.*name: //' | tr -d "'" | tr -d '"' | tr '\n' ' ')
            DEPS_LIST="$DEPS_LIST $INCLUDE_DEPS"
          fi

          # Clean up and format (exclude common, it has its own column)
          DEPS=$(echo "$DEPS_LIST" | tr ' ' '\n' | grep -v "^common$" | sort -u | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g' | sed 's/^, //')
          [ -z "$DEPS" ] && DEPS="-"
          echo "dependencies=$DEPS" >> $GITHUB_OUTPUT

          # Check if alphanodes.setup.common is a dependency in meta/main.yml
          if [ -f "$META_FILE" ] && grep -q "alphanodes.setup.common" "$META_FILE" 2>/dev/null; then
            echo "has_common_dep=true" >> $GITHUB_OUTPUT
          else
            echo "has_common_dep=false" >> $GITHUB_OUTPUT
          fi

          # Check if role uses nginx (check meta/main.yml directly for nginx dependency)
          if grep -q "nginx" "$META_FILE" 2>/dev/null; then
            echo "uses_nginx=true" >> $GITHUB_OUTPUT
          elif [ -d "roles/${ROLE}/templates" ] && grep -rq "nginx" "roles/${ROLE}/templates/" 2>/dev/null; then
            echo "uses_nginx=true" >> $GITHUB_OUTPUT
          else
            echo "uses_nginx=false" >> $GITHUB_OUTPUT
          fi

          # Get last change date
          LAST_CHANGE=$(git log -1 --format='%cs' -- "roles/${ROLE}/" 2>/dev/null || echo "unknown")
          echo "last_change=$LAST_CHANGE" >> $GITHUB_OUTPUT

          # Get tested distros from workflow file and check CI workflow exists
          WORKFLOW_FILE=".github/workflows/${{ matrix.role }}.yml"
          if [ -f "$WORKFLOW_FILE" ]; then
            echo "ci_workflow=true" >> $GITHUB_OUTPUT
            DISTROS=$(grep -A 5 "distro:" "$WORKFLOW_FILE" | grep -E "^\s*-\s+[a-z0-9]+$" | sed 's/.*- //' | \
              sed 's/debian12/bookworm/g' | \
              sed 's/debian13/trixie/g' | \
              sed 's/ubuntu2404/noble/g' | \
              sed 's/ubuntu2204/jammy/g' | \
              tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')
            [ -z "$DISTROS" ] && DISTROS="-"
          else
            echo "ci_workflow=false" >> $GITHUB_OUTPUT
            DISTROS="-"
          fi
          echo "distros=$DISTROS" >> $GITHUB_OUTPUT

          # Check if CI badge exists in README.md
          if grep -q "workflows/${{ matrix.role }}.yml/badge.svg" README.md 2>/dev/null; then
            echo "ci_badge=true" >> $GITHUB_OUTPUT
          else
            echo "ci_badge=false" >> $GITHUB_OUTPUT
          fi


          # Count changed_when: false (potential idempotency workarounds)
          CHANGED_WHEN_FALSE=$(grep -r "changed_when:.*false" "roles/${ROLE}/tasks/" 2>/dev/null | wc -l | tr -d ' ')
          echo "changed_when_false=$CHANGED_WHEN_FALSE" >> $GITHUB_OUTPUT

          # Count unused variables in defaults/main.yml
          DEFAULTS_FILE="roles/${ROLE}/defaults/main.yml"
          if [ -f "$DEFAULTS_FILE" ]; then
            UNUSED=0
            UNUSED_LIST=""
            for VAR in $(grep -E "^[a-z_]+:" "$DEFAULTS_FILE" | cut -d: -f1); do
              # For common role, search entire collection; for others, search only own role
              if [ "$ROLE" = "common" ]; then
                FOUND=false
                grep -rq "$VAR" roles/*/tasks/ 2>/dev/null && FOUND=true
                grep -rq "$VAR" roles/*/templates/ 2>/dev/null && FOUND=true
                grep -rq "$VAR" roles/*/handlers/ 2>/dev/null && FOUND=true
                grep -rq "$VAR" roles/*/vars/ 2>/dev/null && FOUND=true
                grep -rq "{{ *$VAR" roles/*/defaults/ 2>/dev/null && FOUND=true
              else
                FOUND=false
                grep -rq "$VAR" "roles/${ROLE}/tasks/" 2>/dev/null && FOUND=true
                grep -rq "$VAR" "roles/${ROLE}/templates/" 2>/dev/null && FOUND=true
                grep -rq "$VAR" "roles/${ROLE}/handlers/" 2>/dev/null && FOUND=true
                grep -rq "$VAR" "roles/${ROLE}/vars/" 2>/dev/null && FOUND=true
                grep -q "{{ *$VAR" "$DEFAULTS_FILE" 2>/dev/null && FOUND=true
              fi
              if [ "$FOUND" = "false" ]; then
                UNUSED=$((UNUSED + 1))
                [ -n "$UNUSED_LIST" ] && UNUSED_LIST="${UNUSED_LIST},"
                UNUSED_LIST="${UNUSED_LIST}${VAR}"
              fi
            done
            echo "unused_vars=$UNUSED" >> $GITHUB_OUTPUT
            echo "unused_list=${UNUSED_LIST}" >> $GITHUB_OUTPUT
          else
            echo "unused_vars=0" >> $GITHUB_OUTPUT
            echo "unused_list=" >> $GITHUB_OUTPUT
          fi

      - name: Run Molecule converge
        id: molecule
        run: |
          START_TIME=$(date +%s)
          molecule converge -s ${{ matrix.role }} 2>&1 || true
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          echo "duration=${MINUTES}m ${SECONDS}s" >> $GITHUB_OUTPUT
        env:
          MOLECULE_DISTRO: debian13
        continue-on-error: true

      - name: Run idempotency check
        id: idempotency
        run: |
          # Run converge again to check idempotency
          IDEMP_OUTPUT=$(molecule converge -s ${{ matrix.role }} 2>&1 || true)
          # Extract changed count from the last play recap
          CHANGED=$(echo "$IDEMP_OUTPUT" | grep -E "changed=[0-9]+" | tail -1 | grep -oE "changed=[0-9]+" | cut -d= -f2)
          [ -z "$CHANGED" ] && CHANGED="?"
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT
        env:
          MOLECULE_DISTRO: debian13
        continue-on-error: true

      - name: Run Gixy security check
        id: gixy
        run: |
          CONTAINER_ID=$(docker ps -q --filter "name=instance" 2>/dev/null | head -1)
          if [ -n "$CONTAINER_ID" ]; then
            mkdir -p /tmp/nginx-config
            docker cp "$CONTAINER_ID:/etc/nginx/nginx.conf" /tmp/nginx-config/ 2>/dev/null || true
            docker cp "$CONTAINER_ID:/etc/nginx/sites-enabled/" /tmp/nginx-config/ 2>/dev/null || true

            if [ -f "/tmp/nginx-config/nginx.conf" ]; then
              # Run gixy and capture full output
              GIXY_OUTPUT=$(gixy /tmp/nginx-config/nginx.conf 2>&1 || true)

              # Save full output for details section
              echo "$GIXY_OUTPUT" > /tmp/gixy-full-output.txt

              # Parse counts
              HIGH=$(echo "$GIXY_OUTPUT" | grep "High:" | grep -oE "[0-9]+" || echo "0")
              MEDIUM=$(echo "$GIXY_OUTPUT" | grep "Medium:" | grep -oE "[0-9]+" || echo "0")
              LOW=$(echo "$GIXY_OUTPUT" | grep "Low:" | grep -oE "[0-9]+" || echo "0")

              [ -z "$HIGH" ] && HIGH="0"
              [ -z "$MEDIUM" ] && MEDIUM="0"
              [ -z "$LOW" ] && LOW="0"

              echo "high=$HIGH" >> $GITHUB_OUTPUT
              echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
              echo "low=$LOW" >> $GITHUB_OUTPUT
              echo "tested=true" >> $GITHUB_OUTPUT

              # Generate status icon
              if [ "$HIGH" -gt 0 ]; then
                echo "status=âŒ ${HIGH}H" >> $GITHUB_OUTPUT
                echo "has_issues=true" >> $GITHUB_OUTPUT
              elif [ "$MEDIUM" -gt 0 ]; then
                echo "status=âš ï¸ ${MEDIUM}M" >> $GITHUB_OUTPUT
                echo "has_issues=true" >> $GITHUB_OUTPUT
              elif [ "$LOW" -gt 0 ]; then
                echo "status=ðŸ’¡ ${LOW}L" >> $GITHUB_OUTPUT
                echo "has_issues=true" >> $GITHUB_OUTPUT
              else
                echo "status=âœ…" >> $GITHUB_OUTPUT
                echo "has_issues=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "tested=false" >> $GITHUB_OUTPUT
              echo "status=ðŸ”§" >> $GITHUB_OUTPUT
              echo "has_issues=false" >> $GITHUB_OUTPUT
              echo "high=0" >> $GITHUB_OUTPUT
              echo "medium=0" >> $GITHUB_OUTPUT
              echo "low=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "tested=false" >> $GITHUB_OUTPUT
            echo "status=ðŸ”§" >> $GITHUB_OUTPUT
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "medium=0" >> $GITHUB_OUTPUT
            echo "low=0" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Cleanup
        if: always()
        run: molecule destroy -s ${{ matrix.role }} 2>/dev/null || true

      - name: Write result
        run: |
          mkdir -p /tmp/results
          USES_NGINX="${{ steps.metadata.outputs.uses_nginx }}"
          TESTED="${{ steps.gixy.outputs.tested }}"
          HAS_ISSUES="${{ steps.gixy.outputs.has_issues }}"
          STATUS="${{ steps.gixy.outputs.status }}"

          # Determine final status
          if [ "$USES_NGINX" = "false" ]; then
            FINAL_STATUS="-"
            HAS_ISSUES="false"
          elif [ "$TESTED" = "false" ]; then
            FINAL_STATUS="ðŸ”§"
            HAS_ISSUES="false"
          else
            FINAL_STATUS="$STATUS"
          fi

          # Read full gixy output if exists
          if [ -f "/tmp/gixy-full-output.txt" ]; then
            GIXY_DETAILS=$(cat /tmp/gixy-full-output.txt | base64 -w 0)
          else
            GIXY_DETAILS=""
          fi

          {
            echo "role=${{ matrix.role }}"
            echo "role_tasks=${{ steps.metadata.outputs.role_tasks }}"
            echo "verify_tasks=${{ steps.metadata.outputs.verify_tasks }}"
            echo "distros=${{ steps.metadata.outputs.distros }}"
            echo "dependencies=${{ steps.metadata.outputs.dependencies }}"
            echo "gixy_status=${FINAL_STATUS}"
            echo "has_issues=${HAS_ISSUES}"
            echo "gixy_details=${GIXY_DETAILS}"
            echo "duration=${{ steps.molecule.outputs.duration }}"
            echo "last_change=${{ steps.metadata.outputs.last_change }}"
            echo "uses_nginx=${USES_NGINX}"
            echo "ci_workflow=${{ steps.metadata.outputs.ci_workflow }}"
            echo "ci_badge=${{ steps.metadata.outputs.ci_badge }}"
            echo "has_common_dep=${{ steps.metadata.outputs.has_common_dep }}"
            echo "unused_vars=${{ steps.metadata.outputs.unused_vars }}"
            echo "unused_list=${{ steps.metadata.outputs.unused_list }}"
            echo "changed_when_false=${{ steps.metadata.outputs.changed_when_false }}"
            echo "idempotent=${{ steps.idempotency.outputs.changed }}"
          } > /tmp/results/${{ matrix.role }}.txt

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.role }}
          path: /tmp/results/${{ matrix.role }}.txt

  update-gist:
    needs: health-check
    runs-on: ubuntu-latest
    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: result-*
          path: /tmp/results
          merge-multiple: true

      - name: Generate report
        run: |
          DATE=$(date -u +"%Y-%m-%d %H:%M UTC")

          cat << 'HEADER' > ./report.md
          # Role Health & Security Report

          **Collection:** [alphanodes.setup](https://github.com/alphanodes/ansible-collection-setup)

          > Automatically generated by GitHub Actions

          ## Results

          | Role | [Tasks](## "Number of role tasks") | [Tests](## "Number of verify tasks") | [Distros](## "Tested distributions") | [Deps](## "Role dependencies from meta and include_role") | [Common](## "Has alphanodes.setup.common dependency") | [CI](## "CI workflow exists") | [Badge](## "CI badge in README") | [Idemp](## "Idempotency: changed=0 on 2nd run") | [CWF](## "changed_when: false count") | [Unused](## "Unused variables in defaults") | [Gixy](https://github.com/dvershinin/gixy "nginx security check") | [Duration](## "Molecule converge time") | [Changed](## "Last change date") |
          |------|-------|-------|---------|------|--------|-------|-------|-------|-----|--------|------|----------|---------|
          HEADER

          # Collect issues for details section
          mkdir -p ./issues

          # Process each result file
          for file in /tmp/results/*.txt; do
            if [ -f "$file" ]; then
              unset ROLE ROLE_TASKS VERIFY_TASKS DISTROS DEPS GIXY_STATUS HAS_ISSUES GIXY_DETAILS DURATION LAST_CHANGE
              unset CI_WORKFLOW CI_BADGE HAS_COMMON_DEP UNUSED_VARS UNUSED_LIST CHANGED_WHEN_FALSE IDEMPOTENT

              while IFS='=' read -r key value; do
                case "$key" in
                  role) ROLE="$value" ;;
                  role_tasks) ROLE_TASKS="$value" ;;
                  verify_tasks) VERIFY_TASKS="$value" ;;
                  distros) DISTROS="$value" ;;
                  dependencies) DEPS="$value" ;;
                  gixy_status) GIXY_STATUS="$value" ;;
                  has_issues) HAS_ISSUES="$value" ;;
                  gixy_details) GIXY_DETAILS="$value" ;;
                  duration) DURATION="$value" ;;
                  last_change) LAST_CHANGE="$value" ;;
                  ci_workflow) CI_WORKFLOW="$value" ;;
                  ci_badge) CI_BADGE="$value" ;;
                  has_common_dep) HAS_COMMON_DEP="$value" ;;
                  unused_vars) UNUSED_VARS="$value" ;;
                  unused_list) UNUSED_LIST="$value" ;;
                  changed_when_false) CHANGED_WHEN_FALSE="$value" ;;
                  idempotent) IDEMPOTENT="$value" ;;
                esac
              done < "$file"

              # Add link to details if has issues
              if [ "$HAS_ISSUES" = "true" ]; then
                GIXY_DISPLAY="[${GIXY_STATUS}](#${ROLE})"
                # Decode and save details
                if [ -n "$GIXY_DETAILS" ]; then
                  echo "$GIXY_DETAILS" | base64 -d > "./issues/${ROLE}.txt" 2>/dev/null || true
                fi
              else
                GIXY_DISPLAY="$GIXY_STATUS"
              fi

              # Role name as link to collection
              ROLE_LINK="[${ROLE}](https://github.com/alphanodes/ansible-collection-setup/tree/main/roles/${ROLE})"

              # Format CI workflow status
              [ "$CI_WORKFLOW" = "true" ] && CI_DISPLAY="âœ…" || CI_DISPLAY="âŒ"

              # Format CI badge status
              [ "$CI_BADGE" = "true" ] && BADGE_DISPLAY="âœ…" || BADGE_DISPLAY="âŒ"

              # Format common dependency check (common role itself shows "-")
              if [ "$ROLE" = "common" ]; then
                COMMON_DISPLAY="-"
              elif [ "$HAS_COMMON_DEP" = "true" ]; then
                COMMON_DISPLAY="âœ…"
              else
                COMMON_DISPLAY="âŒ"
              fi

              # Format unused vars (0 = good)
              if [ "$UNUSED_VARS" = "0" ]; then
                UNUSED_DISPLAY="âœ…"
              else
                UNUSED_DISPLAY="[âš ï¸ ${UNUSED_VARS}](#unused-${ROLE})"
                # Save unused list for details section (convert comma to newline)
                if [ -n "$UNUSED_LIST" ]; then
                  mkdir -p ./unused
                  echo "$UNUSED_LIST" | tr ',' '\n' > "./unused/${ROLE}.txt"
                fi
              fi

              # Format idempotency (0 = good)
              if [ "$IDEMPOTENT" = "0" ]; then
                IDEMP_DISPLAY="âœ…"
              elif [ "$IDEMPOTENT" = "?" ]; then
                IDEMP_DISPLAY="?"
              else
                IDEMP_DISPLAY="âš ï¸ ${IDEMPOTENT}"
              fi

              # Format changed_when: false count (0 = good, high = suspicious)
              if [ "$CHANGED_WHEN_FALSE" = "0" ] || [ -z "$CHANGED_WHEN_FALSE" ]; then
                CWF_DISPLAY="âœ…"
              elif [ "$CHANGED_WHEN_FALSE" -gt 10 ]; then
                CWF_DISPLAY="âš ï¸ ${CHANGED_WHEN_FALSE}"
              else
                CWF_DISPLAY="${CHANGED_WHEN_FALSE}"
              fi

              echo "| ${ROLE_LINK} | ${ROLE_TASKS} | ${VERIFY_TASKS} | ${DISTROS} | ${DEPS} | ${COMMON_DISPLAY} | ${CI_DISPLAY} | ${BADGE_DISPLAY} | ${IDEMP_DISPLAY} | ${CWF_DISPLAY} | ${UNUSED_DISPLAY} | ${GIXY_DISPLAY} | ${DURATION} | ${LAST_CHANGE} |" >> ./report.md
            fi
          done

          # Add legend
          cat << 'LEGEND' >> ./report.md

          ## Legend

          | Symbol | Meaning |
          |--------|---------|
          | âœ… | No issues found |
          | âš ï¸ n | n warnings |
          | âŒ n | n errors |
          | ðŸ’¡ nL | n Low severity issues (Gixy) |
          | âš ï¸ nM | n Medium severity issues (Gixy) |
          | âŒ nH | n High severity issues (Gixy) |
          | ðŸ”§ | Test not run |
          | - | Not applicable |

          LEGEND

          # Add Gixy issues details section if any
          if [ "$(ls -A ./issues 2>/dev/null)" ]; then
            cat << 'ISSUES_HEADER' >> ./report.md

          ## Gixy Issues

          ISSUES_HEADER

            for issue_file in ./issues/*.txt; do
              if [ -f "$issue_file" ]; then
                ROLE_NAME=$(basename "$issue_file" .txt)
                echo "### ${ROLE_NAME}" >> ./report.md
                echo "" >> ./report.md
                echo '<pre>' >> ./report.md
                # Convert URLs to markdown links
                sed 's|\(https\?://[^ ]*\)|<a href="\1">\1</a>|g' "$issue_file" >> ./report.md
                echo '</pre>' >> ./report.md
                echo "" >> ./report.md
              fi
            done
          fi

          # Add unused variables details section if any
          if [ "$(ls -A ./unused 2>/dev/null)" ]; then
            cat << 'UNUSED_HEADER' >> ./report.md

          ## Unused Variables

          UNUSED_HEADER

            for unused_file in ./unused/*.txt; do
              if [ -f "$unused_file" ]; then
                ROLE_NAME=$(basename "$unused_file" .txt)
                echo "<h3 id=\"unused-${ROLE_NAME}\">${ROLE_NAME}</h3>" >> ./report.md
                echo "" >> ./report.md
                echo '```' >> ./report.md
                cat "$unused_file" >> ./report.md
                echo '```' >> ./report.md
                echo "" >> ./report.md
              fi
            done
          fi

          # Add footer
          cat << FOOTER >> ./report.md
          ---

          *Last updated: ${DATE}*

          *Note: This report tests role defaults in a Molecule test environment. Production configurations with custom variables may differ.*
          FOOTER

      - name: Update Gist
        uses: exuanbo/actions-deploy-gist@v1
        with:
          token: ${{ secrets.GIST_TOKEN }}
          gist_id: 6877af16c7c7f6f31589ef9668134fe9
          gist_file_name: role-health-report.md
          file_path: ./report.md
