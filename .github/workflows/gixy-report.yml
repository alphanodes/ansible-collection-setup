---
name: "Gixy Security Report"

'on':
  push:
    branches:
      - main
    paths:
      - 'roles/*/templates/**/*.j2'
      - 'roles/nginx/**'
      - 'roles/nginx_mono/**'
      - 'molecule/*/verify.yml'
      - '.github/workflows/gixy-report.yml'
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0'

jobs:
  collect-metadata:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Check out the codebase
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set matrix
        id: set-matrix
        run: |
          echo 'matrix={"role":["dendrite","grafana","hedgedoc","loki","ethercalc","element_web","mailpit","nextcloud","radicale","roundcube","matomo","redmine","jekyll","vimbadmin"]}' >> $GITHUB_OUTPUT

  gixy-scan:
    needs: collect-metadata
    runs-on: ubuntu-latest
    env:
      PY_COLORS: 1
      ANSIBLE_FORCE_COLOR: 1

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.collect-metadata.outputs.matrix) }}

    steps:
      - name: Check out the codebase
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install test dependencies
        run: |
          python -m pip install --no-cache-dir --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install gixy-ng

      - name: Collect role metadata
        id: metadata
        run: |
          ROLE="${{ matrix.role }}"

          # Count verify tasks
          VERIFY_FILE="molecule/${{ matrix.role }}/verify.yml"
          if [ -f "$VERIFY_FILE" ]; then
            TASK_COUNT=$(grep -c "^\s*- name:" "$VERIFY_FILE" 2>/dev/null || echo "0")
          else
            TASK_COUNT="0"
          fi
          echo "tasks=$TASK_COUNT" >> $GITHUB_OUTPUT

          # Get dependencies from meta/main.yml
          META_FILE="roles/${ROLE}/meta/main.yml"
          if [ -f "$META_FILE" ]; then
            DEPS=$(grep -A 20 "^dependencies:" "$META_FILE" | grep "role:" | sed 's/.*role: alphanodes.setup.//' | sed 's/.*role: //' | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')
            [ -z "$DEPS" ] && DEPS="-"
          else
            DEPS="-"
          fi
          echo "dependencies=$DEPS" >> $GITHUB_OUTPUT

          # Check if role uses nginx (check meta/main.yml directly for nginx dependency)
          if grep -q "nginx" "$META_FILE" 2>/dev/null; then
            echo "uses_nginx=true" >> $GITHUB_OUTPUT
          elif [ -d "roles/${ROLE}/templates" ] && grep -rq "nginx" "roles/${ROLE}/templates/" 2>/dev/null; then
            echo "uses_nginx=true" >> $GITHUB_OUTPUT
          else
            echo "uses_nginx=false" >> $GITHUB_OUTPUT
          fi

          # Get last change date
          LAST_CHANGE=$(git log -1 --format="%Y-%m-%d" -- "roles/${ROLE}/" 2>/dev/null || echo "unknown")
          echo "last_change=$LAST_CHANGE" >> $GITHUB_OUTPUT

          # Get tested distros from workflow file and check CI workflow exists
          WORKFLOW_FILE=".github/workflows/${{ matrix.role }}.yml"
          if [ -f "$WORKFLOW_FILE" ]; then
            echo "ci_workflow=true" >> $GITHUB_OUTPUT
            DISTROS=$(grep -A 10 "distro:" "$WORKFLOW_FILE" | grep "- " | sed 's/.*- //' | \
              sed 's/debian12/bookworm/g' | \
              sed 's/debian13/trixie/g' | \
              sed 's/ubuntu2404/noble/g' | \
              sed 's/ubuntu2204/jammy/g' | \
              tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')
            [ -z "$DISTROS" ] && DISTROS="-"
          else
            echo "ci_workflow=false" >> $GITHUB_OUTPUT
            DISTROS="-"
          fi
          echo "distros=$DISTROS" >> $GITHUB_OUTPUT

          # Check if CI badge exists in README.md
          if grep -q "workflows/${{ matrix.role }}.yml/badge.svg" README.md 2>/dev/null; then
            echo "ci_badge=true" >> $GITHUB_OUTPUT
          else
            echo "ci_badge=false" >> $GITHUB_OUTPUT
          fi

          # Check dependencies have correct prefix
          if [ -f "$META_FILE" ]; then
            BAD_DEPS=$(grep -A 20 "^dependencies:" "$META_FILE" | grep "role:" | grep -v "alphanodes.setup\." | wc -l)
            echo "bad_deps=$BAD_DEPS" >> $GITHUB_OUTPUT
          else
            echo "bad_deps=0" >> $GITHUB_OUTPUT
          fi

          # Count unused variables in defaults/main.yml
          DEFAULTS_FILE="roles/${ROLE}/defaults/main.yml"
          if [ -f "$DEFAULTS_FILE" ]; then
            UNUSED=0
            for VAR in $(grep -E "^[a-z_]+:" "$DEFAULTS_FILE" | cut -d: -f1); do
              # Check if variable is used in tasks or templates
              if ! grep -rq "$VAR" "roles/${ROLE}/tasks/" 2>/dev/null && \
                 ! grep -rq "$VAR" "roles/${ROLE}/templates/" 2>/dev/null && \
                 ! grep -rq "$VAR" "roles/${ROLE}/handlers/" 2>/dev/null; then
                UNUSED=$((UNUSED + 1))
              fi
            done
            echo "unused_vars=$UNUSED" >> $GITHUB_OUTPUT
          else
            echo "unused_vars=0" >> $GITHUB_OUTPUT
          fi

      - name: Run Molecule converge
        id: molecule
        run: |
          START_TIME=$(date +%s)
          molecule converge -s ${{ matrix.role }} 2>&1 || true
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          echo "duration=${MINUTES}m ${SECONDS}s" >> $GITHUB_OUTPUT
        env:
          MOLECULE_DISTRO: debian13
        continue-on-error: true

      - name: Run idempotency check
        id: idempotency
        run: |
          # Run converge again to check idempotency
          IDEMP_OUTPUT=$(molecule converge -s ${{ matrix.role }} 2>&1 || true)
          # Extract changed count from the last play recap
          CHANGED=$(echo "$IDEMP_OUTPUT" | grep -E "changed=[0-9]+" | tail -1 | grep -oE "changed=[0-9]+" | cut -d= -f2)
          [ -z "$CHANGED" ] && CHANGED="?"
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT
        env:
          MOLECULE_DISTRO: debian13
        continue-on-error: true

      - name: Run Gixy security check
        id: gixy
        run: |
          CONTAINER_ID=$(docker ps -q --filter "name=instance" 2>/dev/null | head -1)
          if [ -n "$CONTAINER_ID" ]; then
            mkdir -p /tmp/nginx-config
            docker cp "$CONTAINER_ID:/etc/nginx/nginx.conf" /tmp/nginx-config/ 2>/dev/null || true
            docker cp "$CONTAINER_ID:/etc/nginx/sites-enabled/" /tmp/nginx-config/ 2>/dev/null || true

            if [ -f "/tmp/nginx-config/nginx.conf" ]; then
              # Run gixy and capture full output
              GIXY_OUTPUT=$(gixy /tmp/nginx-config/nginx.conf 2>&1 || true)

              # Save full output for details section
              echo "$GIXY_OUTPUT" > /tmp/gixy-full-output.txt

              # Parse counts
              HIGH=$(echo "$GIXY_OUTPUT" | grep "High:" | grep -oE "[0-9]+" || echo "0")
              MEDIUM=$(echo "$GIXY_OUTPUT" | grep "Medium:" | grep -oE "[0-9]+" || echo "0")
              LOW=$(echo "$GIXY_OUTPUT" | grep "Low:" | grep -oE "[0-9]+" || echo "0")

              [ -z "$HIGH" ] && HIGH="0"
              [ -z "$MEDIUM" ] && MEDIUM="0"
              [ -z "$LOW" ] && LOW="0"

              echo "high=$HIGH" >> $GITHUB_OUTPUT
              echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
              echo "low=$LOW" >> $GITHUB_OUTPUT
              echo "tested=true" >> $GITHUB_OUTPUT

              # Generate status icon
              if [ "$HIGH" -gt 0 ]; then
                echo "status=âŒ ${HIGH}H" >> $GITHUB_OUTPUT
                echo "has_issues=true" >> $GITHUB_OUTPUT
              elif [ "$MEDIUM" -gt 0 ]; then
                echo "status=âš ï¸ ${MEDIUM}M" >> $GITHUB_OUTPUT
                echo "has_issues=true" >> $GITHUB_OUTPUT
              elif [ "$LOW" -gt 0 ]; then
                echo "status=ðŸ’¡ ${LOW}L" >> $GITHUB_OUTPUT
                echo "has_issues=true" >> $GITHUB_OUTPUT
              else
                echo "status=âœ…" >> $GITHUB_OUTPUT
                echo "has_issues=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "tested=false" >> $GITHUB_OUTPUT
              echo "status=ðŸ”§" >> $GITHUB_OUTPUT
              echo "has_issues=false" >> $GITHUB_OUTPUT
              echo "high=0" >> $GITHUB_OUTPUT
              echo "medium=0" >> $GITHUB_OUTPUT
              echo "low=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "tested=false" >> $GITHUB_OUTPUT
            echo "status=ðŸ”§" >> $GITHUB_OUTPUT
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "medium=0" >> $GITHUB_OUTPUT
            echo "low=0" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Cleanup
        if: always()
        run: molecule destroy -s ${{ matrix.role }} 2>/dev/null || true

      - name: Write result
        run: |
          mkdir -p /tmp/results
          USES_NGINX="${{ steps.metadata.outputs.uses_nginx }}"
          TESTED="${{ steps.gixy.outputs.tested }}"
          HAS_ISSUES="${{ steps.gixy.outputs.has_issues }}"
          STATUS="${{ steps.gixy.outputs.status }}"

          # Determine final status
          if [ "$USES_NGINX" = "false" ]; then
            FINAL_STATUS="-"
          elif [ "$TESTED" = "false" ]; then
            FINAL_STATUS="ðŸ”§"
          else
            FINAL_STATUS="$STATUS"
          fi

          # Read full gixy output if exists
          if [ -f "/tmp/gixy-full-output.txt" ]; then
            GIXY_DETAILS=$(cat /tmp/gixy-full-output.txt | base64 -w 0)
          else
            GIXY_DETAILS=""
          fi

          {
            echo "role=${{ matrix.role }}"
            echo "tasks=${{ steps.metadata.outputs.tasks }}"
            echo "distros=${{ steps.metadata.outputs.distros }}"
            echo "dependencies=${{ steps.metadata.outputs.dependencies }}"
            echo "gixy_status=${FINAL_STATUS}"
            echo "has_issues=${HAS_ISSUES}"
            echo "gixy_details=${GIXY_DETAILS}"
            echo "duration=${{ steps.molecule.outputs.duration }}"
            echo "last_change=${{ steps.metadata.outputs.last_change }}"
            echo "uses_nginx=${USES_NGINX}"
            echo "ci_workflow=${{ steps.metadata.outputs.ci_workflow }}"
            echo "ci_badge=${{ steps.metadata.outputs.ci_badge }}"
            echo "bad_deps=${{ steps.metadata.outputs.bad_deps }}"
            echo "unused_vars=${{ steps.metadata.outputs.unused_vars }}"
            echo "idempotent=${{ steps.idempotency.outputs.changed }}"
          } > /tmp/results/${{ matrix.role }}.txt

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.role }}
          path: /tmp/results/${{ matrix.role }}.txt

  update-gist:
    needs: gixy-scan
    runs-on: ubuntu-latest
    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: result-*
          path: /tmp/results
          merge-multiple: true

      - name: Generate report
        run: |
          DATE=$(date -u +"%Y-%m-%d %H:%M UTC")

          cat << 'HEADER' > ./report.md
          # Role Health & Security Report

          **Collection:** [alphanodes.setup](https://github.com/alphanodes/ansible-collection-setup)

          > Automatically generated by GitHub Actions

          ## Results

          | Role | Tests | Distros | Deps | CI | Badge | Idemp | Unused | [Gixy](https://github.com/dvershinin/gixy) | Duration | Changed |
          |------|-------|---------|------|-------|-------|-------|--------|------|----------|---------|
          HEADER

          # Collect issues for details section
          mkdir -p ./issues

          # Process each result file
          for file in /tmp/results/*.txt; do
            if [ -f "$file" ]; then
              unset ROLE TASKS DISTROS DEPS GIXY_STATUS HAS_ISSUES GIXY_DETAILS DURATION LAST_CHANGE
              unset CI_WORKFLOW CI_BADGE BAD_DEPS UNUSED_VARS IDEMPOTENT

              while IFS='=' read -r key value; do
                case "$key" in
                  role) ROLE="$value" ;;
                  tasks) TASKS="$value" ;;
                  distros) DISTROS="$value" ;;
                  dependencies) DEPS="$value" ;;
                  gixy_status) GIXY_STATUS="$value" ;;
                  has_issues) HAS_ISSUES="$value" ;;
                  gixy_details) GIXY_DETAILS="$value" ;;
                  duration) DURATION="$value" ;;
                  last_change) LAST_CHANGE="$value" ;;
                  ci_workflow) CI_WORKFLOW="$value" ;;
                  ci_badge) CI_BADGE="$value" ;;
                  bad_deps) BAD_DEPS="$value" ;;
                  unused_vars) UNUSED_VARS="$value" ;;
                  idempotent) IDEMPOTENT="$value" ;;
                esac
              done < "$file"

              # Add link to details if has issues
              if [ "$HAS_ISSUES" = "true" ]; then
                GIXY_DISPLAY="[${GIXY_STATUS}](#${ROLE})"
                # Decode and save details
                if [ -n "$GIXY_DETAILS" ]; then
                  echo "$GIXY_DETAILS" | base64 -d > "./issues/${ROLE}.txt"
                fi
              else
                GIXY_DISPLAY="$GIXY_STATUS"
              fi

              # Role name as link to collection
              ROLE_LINK="[${ROLE}](https://github.com/alphanodes/ansible-collection-setup/tree/main/roles/${ROLE})"

              # Format CI workflow status
              [ "$CI_WORKFLOW" = "true" ] && CI_DISPLAY="âœ…" || CI_DISPLAY="âŒ"

              # Format CI badge status
              [ "$CI_BADGE" = "true" ] && BADGE_DISPLAY="âœ…" || BADGE_DISPLAY="âŒ"

              # Format dependencies check (0 = good)
              [ "$BAD_DEPS" = "0" ] && DEPS_DISPLAY="âœ…" || DEPS_DISPLAY="âŒ ${BAD_DEPS}"

              # Format unused vars (0 = good)
              [ "$UNUSED_VARS" = "0" ] && UNUSED_DISPLAY="âœ…" || UNUSED_DISPLAY="âš ï¸ ${UNUSED_VARS}"

              # Format idempotency (0 = good)
              if [ "$IDEMPOTENT" = "0" ]; then
                IDEMP_DISPLAY="âœ…"
              elif [ "$IDEMPOTENT" = "?" ]; then
                IDEMP_DISPLAY="?"
              else
                IDEMP_DISPLAY="âš ï¸ ${IDEMPOTENT}"
              fi

              echo "| ${ROLE_LINK} | ${TASKS} | ${DISTROS} | ${DEPS_DISPLAY} | ${CI_DISPLAY} | ${BADGE_DISPLAY} | ${IDEMP_DISPLAY} | ${UNUSED_DISPLAY} | ${GIXY_DISPLAY} | ${DURATION} | ${LAST_CHANGE} |" >> ./report.md
            fi
          done

          # Add legend
          cat << 'LEGEND' >> ./report.md

          ## Legend

          ### Columns

          | Column | Description |
          |--------|-------------|
          | Tests | Number of verify tasks in molecule test |
          | Distros | Tested distributions |
          | Deps | Dependencies use correct `alphanodes.setup.` prefix |
          | CI | CI workflow file exists |
          | Badge | CI badge in README.md |
          | Idemp | Idempotency check (changed=0 on second run) |
          | Unused | Unused variables in defaults/main.yml |
          | Gixy | nginx configuration security check |
          | Duration | Molecule converge duration |
          | Changed | Last change date |

          ### Symbols

          | Symbol | Meaning |
          |--------|---------|
          | âœ… | No issues found |
          | âš ï¸ n | n warnings |
          | âŒ n | n errors |
          | ðŸ’¡ nL | n Low severity issues (Gixy) |
          | âš ï¸ nM | n Medium severity issues (Gixy) |
          | âŒ nH | n High severity issues (Gixy) |
          | ðŸ”§ | Test not run |
          | - | Not applicable |

          LEGEND

          # Add issues details section if any
          if [ "$(ls -A ./issues 2>/dev/null)" ]; then
            cat << 'ISSUES_HEADER' >> ./report.md

          ## Issue Details

          ISSUES_HEADER

            for issue_file in ./issues/*.txt; do
              if [ -f "$issue_file" ]; then
                ROLE_NAME=$(basename "$issue_file" .txt)
                echo "### ${ROLE_NAME}" >> ./report.md
                echo "" >> ./report.md
                echo '<pre>' >> ./report.md
                # Convert URLs to markdown links
                sed 's|\(https\?://[^ ]*\)|<a href="\1">\1</a>|g' "$issue_file" >> ./report.md
                echo '</pre>' >> ./report.md
                echo "" >> ./report.md
              fi
            done
          fi

          # Add footer
          cat << FOOTER >> ./report.md
          ---

          *Last updated: ${DATE}*

          *Note: This report tests role defaults in a Molecule test environment. Production configurations with custom variables may differ.*
          FOOTER

      - name: Update Gist
        uses: exuanbo/actions-deploy-gist@v1
        with:
          token: ${{ secrets.GIST_TOKEN }}
          gist_id: 6877af16c7c7f6f31589ef9668134fe9
          gist_file_name: gixy-security-report.md
          file_path: ./report.md
