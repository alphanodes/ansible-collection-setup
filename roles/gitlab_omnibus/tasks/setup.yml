---

- name: Set activ_object_store_consolidated
  ansible.builtin.set_fact:
    activ_object_store_consolidated: "{{ gitlab_object_store_consolidated and gitlab_object_store_connection | length > 1 }}"

- name: Ensure python3-debian is installed for deb822_repository
  ansible.builtin.apt:
    name: python3-debian
    state: present
    update_cache: true

- name: Add Gitlab apt repository
  ansible.builtin.deb822_repository:
    name: gitlab
    uris: '{{ gitlab_apt_url }}'
    types: deb
    suites: '{{ gitlab_apt_suites }}'
    components: '{{ gitlab_apt_components }}'
    signed_by: '{{ gitlab_apt_signed_by }}'
    state: present

- name: Update apt cache after adding repository
  ansible.builtin.apt:
    update_cache: true
  changed_when: false

- name: Ensure required packages are installed
  ansible.builtin.apt:
    name: "{{ gitlab_required_packages }}"
    state: present
  notify: Reconfigure GitLab

- name: Ensure gitlab.rb configuration is latest
  ansible.builtin.template:
    src: gitlab.rb.j2
    dest: "{{ gitlab_config_file }}"
    owner: root
    group: root
    mode: '0600'
    validate: ruby -c %s
  register: config_change
  notify: Reconfigure GitLab

- name: Force reconfigure GitLab
  ansible.builtin.command: gitlab-ctl reconfigure
  when: gitlab_force_reconfigure and not config_change.changed
