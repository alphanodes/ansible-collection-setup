---

# Only GitLab EE is supported for now
# Supported distributions: Debian 11 and Debian 12 only
# See: https://docs.gitlab.com/install/package/debian/

gitlab_required_packages:
  # ruby just used for syntax check
  - ruby
  - gitlab-ee

gitlab_config_file: /etc/gitlab/gitlab.rb

gitlab_vhost_server: '{{ hostname | default(ansible_host) }}'

gitlab_external_url: 'https://{{ gitlab_vhost_server }}'

gitlab_email_display_name: Gitlab
gitlab_email_from: 'git@{{ gitlab_vhost_server }}'
gitlab_email_reply_to: 'noreply@{{ gitlab_vhost_server }}'

gitlab_default_theme: 2
gitlab_default_color_mode: 3

gitlab_default_projects_features:
  issues: false
  merge_requests: true
  wiki: false
  snippets: false
  builds: true
  container_registry: true

# see https://docs.gitlab.com/omnibus/settings/backups.html
# see https://docs.gitlab.com/ee/administration/backup_restore/backup_gitlab.html#backup-archive-permissions
# see https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template#L663
gitlab_manage_backup_path: true
gitlab_backup_path: /var/opt/gitlab/backups
gitlab_backup_command: /opt/gitlab/bin/gitlab-backup create
# every day at 2:30 (see systemd timer)
gitlab_backup_on_calendar: '02:30'
gitlab_backup_owner: "{{ backup_dir_owner | default('git') }}"
gitlab_backup_group: "{{ backup_dir_group | default('git') }}"
gitlab_backup_pg_schema: public
gitlab_backup_path_mode: '0750'
gitlab_backup_archive_permissions: '0644'
# 7 days in seconds
gitlab_backup_keep_time: 604800

gitlab_nginx_listen_addresses:
  - '*'
  - '[::]'

gitlab_nginx_ssl_protocols: "{{ nginx_ssl_protocols | default('TLSv1.2 TLSv1.3') }}"

gitlab_registry_nginx_listen_addresses: '{{ gitlab_nginx_listen_addresses }}'
gitlab_pages_nginx_listen_addresses: '{{ gitlab_nginx_listen_addresses }}'

# Passthrough all downloads via GitLab instead of using Redirects to Object Storage.
# ? https://docs.gitlab.com/ee/administration/object_storage.html#proxy-download
gitlab_object_store_proxy_download: true

# {
#   'provider' => 'AWS',
#   'region' => 'eu-west-1',
#   'aws_access_key_id' => 'AWS_ACCESS_KEY_ID',
#   'aws_secret_access_key' => 'AWS_SECRET_ACCESS_KEY',
#   # # The below options configure an S3 compatible host instead of AWS
#   # 'host' => 's3.amazonaws.com',
#   # 'aws_signature_version' => 4, # For creation of signed URLs. Set to 2 if provider does not support v4.
#   # 'endpoint' => 'https://s3.amazonaws.com', # default: nil - Useful for S3 compliant services such as DigitalOcean Spaces
#   # 'path_style' => false # Use 'host/bucket_name/object' instead of 'bucket_name.host/object'
# }
gitlab_object_store_connection:
  provider: AWS

gitlab_object_store_consolidated: true

gitlab_artifacts_enabled: true
gitlab_artifacts_object_store: false
gitlab_artifacts_object_store_bucket: gl-artifacts

gitlab_external_diffs_enabled: false
gitlab_external_diffs_object_store: false
gitlab_external_diffs_object_store_bucket: gl-diffs

gitlab_lfs_enabled: true
gitlab_lfs_object_store: false
gitlab_lfs_object_store_bucket: gl-lfs

gitlab_uploads_object_store: false
gitlab_uploads_object_store_bucket: gl-uploads

gitlab_packages_enabled: false
gitlab_packages_object_store: false
gitlab_packages_object_store_bucket: gl-packages

gitlab_ci_secure_files_enabled: true
gitlab_ci_secure_files_object_store: false
gitlab_ci_secure_files_object_store_bucket: gl-ci-secure-files

gitlab_dependency_proxy_enabled: true
gitlab_dependency_proxy_object_store: false
gitlab_dependency_proxy_object_store_bucket: gl-proxy

gitlab_terraform_state_enabled: false
gitlab_terraform_state_object_store: false
gitlab_terraform_state_object_store_bucket: gl-terraform

# NOTE: if you want to use object storage, use this
# gitlab_registry_storage: {}
#
# NOT USED
# gitlab_registry_object_store: false
# gitlab_registry_object_store_bucket: gl-container-registry

# https://docs.gitlab.com/ee/administration/pages/
gitlab_pages_enabled: false
gitlab_pages_domain: ''

gitlab_pages_external_http: ["{{ gitlab_pages_domain }}:80"]
gitlab_pages_external_https: ["{{ gitlab_pages_domain }}:443"]

gitlab_pages_with_tls: true
gitlab_pages_nginx_ssl_certificate: ''
gitlab_pages_nginx_ssl_certificate_key: ''

gitlab_pages_external_url: "http{{ 's' if gitlab_pages_with_tls else '' }}://{{ gitlab_pages_domain }}"

gitlab_pages_artifacts_server: true
gitlab_pages_object_store: false
gitlab_pages_object_store_bucket: gl-pages

gitlab_pages_access_control: false

## Sidekiq
## see https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template#L1381
# Default: 4
gitlab_sidekiq_shutdown_timeout: 20
# Default: 20
gitlab_sidekiq_concurrency: 20

gitlab_log_level: warn

gitlab_env:
  GITLAB_LOG_LEVEL: '{{ gitlab_log_level }}'

gitlab_alertmanager_enable: false
gitlab_alertmanager_flags:
  cluster.advertise-address: "127.0.0.1:9093"

# IP addresses allowed to access monitoring endpoints
# See: https://docs.gitlab.com/ee/administration/monitoring/ip_whitelist.html
gitlab_monitoring_ip_whitelist: ['127.0.0.0/8']

gitlab_ldap_enabled: false
gitlab_ldap_prevent_ldap_sign_in: false
gitlab_ldap_servers:
  main:
    label: 'LDAP'

gitlab_force_reconfigure: false

# https://packages.gitlab.com/gitlab/gitlab-ee/debian/ bookworm main
gitlab_apt_url: https://packages.gitlab.com/gitlab/gitlab-ee/debian/
gitlab_apt_suites: '{{ ansible_distribution_release }}'
gitlab_apt_components: main
gitlab_apt_signed_by: https://packages.gitlab.com/gitlab/gitlab-ee/gpgkey

# GitLab default: 400
gitlab_postgresql_max_connections: "{{ postgresql_max_connections | default(150) }}"
# Default: 60000 (60 Seconds)
gitlab_postgresql_statement_timeout: "{{ postgresql_postgresql_statement_timeout | default(30000) }}"
# Default: 60000 (60 Seconds)
gitlab_postgresql_idle_in_transaction_session_timeout: "{{ postgresql_idle_in_transaction_session_timeout | default(gitlab_postgresql_statement_timeout) }}"
gitlab_postgresql_random_page_cost: "{{ postgresql_random_page_cost | default('2.0') }}"
gitlab_postgresql_effective_io_concurrency: "{{ postgresql_effective_io_concurrency | default(2) }}"
gitlab_postgresql_work_mem: "{{ postgresql_work_mem | default('16MB') }}"
gitlab_postgresql_maintenance_work_mem: "{{ postgresql_maintenance_work_mem | default('128MB') }}"
# NOTE: this is not supported at the moment
gitlab_postgresql_max_files_per_process: "{{ postgresql_max_files_per_process | default(200) }}"
gitlab_postgresql_log_connections: "{{ postgresql_log_connections | default(false) }}"
gitlab_postgresql_log_disconnections: "{{ postgresql_log_disconnections | default(false) }}"

# postgresql['log_connections'] = "off"
# postgresql['log_disconnections'] = "off"

# NOTE for memory constrained environments:
# see https://docs.gitlab.com/omnibus/settings/memory_constrained_envs/

# NOTE: use postgresql_max_connections or gitlab_postgresql_max_connections
# NOTE: if not defined, no setting is set (default gitlab value is used - 1/4 of the total RAM)
# postgresql['shared_buffers'] = "256MB"

# see https://docs.gitlab.com/administration/monitoring/prometheus/postgres_exporter/
# Disable postgresql export (fix open files problem - but no postgres stats metrics)
# postgres_exporter_enable: false

# see https://docs.gitlab.com/administration/operations/puma/
# NOTE: use puma_worker_timeout or gitlab_puma_worker_timeout
# NOTE: if not defined, no setting is set (default gitlab value is used)
# puma['worker_timeout'] = 60
# NOTE: on some hosts there are more, if not defined. Why?
# puma['worker_processes'] = 2
# puma['min_threads'] = 4
# puma['max_threads'] = 4

gitlab_kas_enable: false
gitlab_rails_kas_enabled: false
