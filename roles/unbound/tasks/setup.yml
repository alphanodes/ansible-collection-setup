---

- name: Be sure unbound is installed
  ansible.builtin.apt:
    name: '{{ unbound_packages }}'
    state: present

- name: Check if root key file already exists
  ansible.builtin.stat:
    path: "{{ unbound_root_key_file }}"
  register: unbound_root_key_stat

- name: Initial root anchor setup (only if file doesn't exist)
  ansible.builtin.command: unbound-anchor -a {{ unbound_root_key_file }}
  register: unbound_anchor_rc
  changed_when: unbound_anchor_rc.rc == 1
  failed_when: unbound_anchor_rc.rc > 1
  when: not unbound_root_key_stat.stat.exists

- name: Set permission for root key file
  ansible.builtin.file:
    path: "{{ unbound_root_key_file }}"
    state: file
    owner: "{{ unbound_user }}"
    group: "{{ unbound_group }}"
    mode: '0644'

- name: Configure systemd-resolved for unbound
  when: >
    (server_resolver is defined and server_resolver == 'systemd_resolved')
    or server_resolver is undefined and ansible_distribution == 'Ubuntu'
  block:
    - name: Make sure conf override dir exists
      ansible.builtin.file:
        path: /etc/systemd/resolved.conf.d
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Configure systemd-resolved for unbound
      ansible.builtin.template:
        src: resolved.conf.j2
        dest: /etc/systemd/resolved.conf.d/unbound.conf
        mode: '0644'
      notify: Restart systemd-resolved

- name: Start the unbound service (systemd)
  ansible.builtin.systemd_service:
    name: unbound
    state: started
  register: systemd_rc

- name: Run systemd
  when: >
    systemd_rc.status is undefined
    or systemd_rc.status.ActiveState != 'active'
    or (systemd_rc.status.NeedDaemonReload is defined and systemd_rc.status.NeedDaemonReload != 'no')
  block:
    - name: Reload daemon-reload for init script changes (systemd)
      ansible.builtin.systemd_service:
        daemon_reload: true

    - name: Start the unbound service (systemd)
      ansible.builtin.systemd_service:
        name: unbound
        state: started
        enabled: true
