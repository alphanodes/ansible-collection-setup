---
# Setup nginx vhost using nginx_mono role
- name: Setup nginx vhost for rspamd
  when:
    - rspamd_vhost_server is defined
    - rspamd_vhost_server | length > 0
  ansible.builtin.include_role:
    name: alphanodes.setup.nginx_mono
  vars:
    nginx_mono_service_name: rspamd
    nginx_mono_service_enabled: "{{ rspamd_enable_service }}"
    nginx_mono_include_mode: "{{ rspamd_vhost_location != '/' }}"
    nginx_mono_service_config:
      server_name: "{{ rspamd_vhost_server }}"
      listen_ip: "{{ rspamd_vhost_listen_ip | default('') }}"
      root: /usr/share/rspamd/www
      index: index.html
      proxy_pass: "http://127.0.0.1:11333"
      proxy_location: "{{ rspamd_vhost_location }}"
      vhost_users: "{{ [{'user': rspamd_web_user, 'password': rspamd_web_password}] if rspamd_web_password | length > 0 else [] }}"
      vhost_for_zabbix: "{{ rspamd_vhost_for_zabbix | default(false) }}"
      letsencrypt: "{{ rspamd_vhost_letsencrypt | default(false) }}"
      letsencrypt_cert: "{{ rspamd_vhost_letsencrypt_cert | default('') }}"
      letsencrypt_key: "{{ rspamd_vhost_letsencrypt_key | default('') }}"
      letsencrypt_trusted_cert: "{{ rspamd_vhost_letsencrypt_trusted_cert | default('') }}"
      ssl_cert: "{{ rspamd_vhost_ssl_cert | default('') }}"
