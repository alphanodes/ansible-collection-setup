---

- name: Check for rspamd_worker_controller_password
  ansible.builtin.fail:
    msg: missing rspamd_worker_controller_password. Set it!
  when: rspamd_worker_controller_password is undefined or rspamd_worker_controller_password | length == 0

# DKIM keys are managed by alphanodes.setup.dkim role
# rspamd_dkim_key must be set to point to the key generated by dkim role
# Example: /var/lib/dkim/example.com/mail.key

- name: Remove old apt repository files
  ansible.builtin.file:
    path: '{{ item }}'
    state: absent
  loop:
    - /etc/apt/trusted.gpg.d/rspamd.asc

# see https://docs.ansible.com/ansible/latest/collections/ansible/builtin/deb822_repository_module.html
- name: Add rspamd apt repository
  ansible.builtin.deb822_repository:
    name: rspamd
    uris: '{{ rspamd_apt_url }}'
    types: deb
    suites: '{{ rspamd_apt_suites }}'
    components: '{{ rspamd_apt_components }}'
    signed_by: '{{ rspamd_apt_signed_by }}'
    state: present
  register: rspamd_repo

- name: Update apt cache
  apt:
    update_cache: true
  when: rspamd_repo.changed
  tags:
    - skip_ansible_lint

- name: Install required packages
  ansible.builtin.apt:
    name: '{{ rspamd_packages }}'
    state: present

# DKIM keys are managed by alphanodes.setup.dkim role
# This must run AFTER rspamd package installation because the package creates the _rspamd user
# Note: This block is only executed if rspamd_dkim_domains is defined
- name: Setup DKIM keys for rspamd
  when: rspamd_dkim_domains is defined and rspamd_dkim_domains | length > 0
  ansible.builtin.include_role:
    name: alphanodes.setup.dkim
  vars:
    dkim_domains: "{{ rspamd_dkim_domains }}"
    dkim_user: "{{ rspamd_user }}"
    dkim_group: "{{ rspamd_user }}"
    dkim_show_public_keys: true

- name: Customize dkim and arc configuration
  ansible.builtin.template:
    src: rspamd/local.d/dkim.signing.conf.j2
    dest: /etc/rspamd/local.d/{{ item }}.conf
    mode: '0644'
    owner: root
    group: root
  loop:
    - dkim_signing
    - arc
  notify: Restart rspamd

- name: Configuration files for override.d
  ansible.builtin.template:
    src: rspamd/override.d/classifier-bayes.conf.j2
    dest: /etc/rspamd/override.d/classifier-bayes.conf
    mode: '0644'
    owner: root
    group: root
  notify: Restart rspamd
  loop:
    - classifier-bayes.conf

- name: Configuration files for local.d
  ansible.builtin.template:
    src: rspamd/local.d/{{ item }}.j2
    dest: /etc/rspamd/local.d/{{ item }}
    mode: '0644'
    owner: root
    group: root
  notify: Restart rspamd
  loop:
    - worker-controller.inc
    - classifier-bayes.conf
    - milter_headers.conf
    - redis.conf
    - logging.inc

- name: Configure manual whitelists and blacklists
  ansible.builtin.template:
    src: rspamd/local.d/multimap.conf.j2
    dest: /etc/rspamd/local.d/multimap.conf
    mode: '0644'
    owner: root
    group: root
  notify: Restart rspamd

- name: Import setup for whitelist and backlist tasks
  ansible.builtin.include_tasks: setup_whitelist_blacklist.yml
  loop:
    - name: whitelist_ip
      lines: '{{ rspamd_whitelist_ip }}'
    - name: whitelist_from
      lines: '{{ rspamd_whitelist_from }}'
    - name: blacklist_ip
      lines: '{{ rspamd_blacklist_ip }}'
    - name: blacklist_from
      lines: '{{ rspamd_blacklist_from }}'
  loop_control:
    loop_var: map

# DKIM key generation is now handled by alphanodes.setup.dkim role
# Keys are located at: /var/lib/dkim/<domain>/<selector>.key
# Rspamd references these keys via rspamd_dkim_key variable

- name: Start rspamd service
  ansible.builtin.systemd_service:
    name: rspamd
    state: started
    enabled: true
  when: rspamd_enable_service

- name: Include nginx tasks
  ansible.builtin.include_tasks: nginx.yml
  tags:
    - nginx
