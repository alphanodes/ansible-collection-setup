---

- name: Ensure configuration directory exists
  ansible.builtin.file:
    path: /etc/redmine
    state: directory
    mode: '0755'

- name: Ensure Redmine packages are installed
  ansible.builtin.apt:
    name: '{{ redmine_packages }}'
    state: present

- name: Ensure jemalloc library is installed
  ansible.builtin.apt:
    name: libjemalloc2
    state: present
  when: redmine_with_jemalloc

# we always need ruby build packages - for rvm and gems
- name: Install ruby build packages
  ansible.builtin.include_role:
    name: alphanodes.setup.ruby
  vars:
    ruby_build: true

- name: Install ruby-dev if required
  ansible.builtin.include_role:
    name: alphanodes.setup.ruby
  vars:
    ruby_dev: true
  when: redmine_with_ruby_dev or not redmine_use_rvm_as_default

- name: Remove ruby-dev if not required
  ansible.builtin.include_role:
    name: alphanodes.setup.ruby
  vars:
    ruby_dev: false
    ruby_without_dev_packages: true
  when:
    - not redmine_with_ruby_dev
    - redmine_use_rvm_as_default
