---

- name: Set TLS files for letsencrypt
  ansible.builtin.set_fact:
    vhost_letsencrypt_cert: "{{ rocketchat_vhost_letsencrypt_cert }}"
    vhost_letsencrypt_trusted_cert: "{{ rocketchat_vhost_letsencrypt_trusted_cert }}"
    vhost_letsencrypt_key: "{{ rocketchat_vhost_letsencrypt_key }}"
    force_letsencrypt: true
  when:
    - rocketchat_vhost_letsencrypt is defined
    - rocketchat_vhost_letsencrypt

- name: Check trusted TLS cert
  ansible.builtin.stat:
    path: /etc/ssl/certs/{{ rocketchat_vhost_ssl_cert }}_trusted.crt
  register: trusted_cert

- name: Set TLS files
  ansible.builtin.set_fact:
    vhost_ssl_cert: "{{ rocketchat_vhost_ssl_cert }}"
    vhost_ssl_with_trusted_cert: "{{ trusted_cert.stat.exists | bool }}"
  when: rocketchat_vhost_letsencrypt is undefined or not rocketchat_vhost_letsencrypt

- name: Setup nginx_mono and configure rocketchat vhost
  tags: nginx
  ansible.builtin.include_role:
    name: alphanodes.setup.nginx_mono
  vars:
    nginx_with_websocket: true
    nginx_mono_service_name: rocketchat
    nginx_mono_service_enabled: "{{ rocketchat_enabled }}"
    nginx_mono_service_config:
      server_name: "{{ rocketchat_vhost_server }}"
      root: "{{ rocketchat_application_path }}"
      upstream_name: rocket_chat
      upstream_servers:
        - "{{ rocketchat_internal_host }}:{{ rocketchat_internal_port }}"
      proxy_pass: "http://rocket_chat"
      proxy_location: "/"
      proxy_websocket: true
      proxy_host_header: "$host:$server_port"
      proxy_forwarded_proto: "https"
      proxy_connection_upgrade: "upgrade"
      proxy_redirect: "off"
      proxy_timeout: 86400
      proxy_headers:
        - "Referer $http_referer"
        - "X-Forwarded-Ssl on"
        - "X-Nginx-Proxy true"
      error_497_redirect: "https://$host:$server_port$request_uri"
      additional_headers:
        - "Referrer-Policy 'no-referrer'"
      vhost_includes: "{{ rocketchat_vhost_includes | default([]) }}"
      vhost_for_zabbix: "{{ rocketchat_vhost_for_zabbix | default(false) }}"
      redirects: "{{ rocketchat_redirects | default([]) }}"
      letsencrypt: "{{ rocketchat_vhost_letsencrypt | default(false) }}"
