---

# Basic Auth handled by nginx_mono service.yml

- name: Enable block
  when: ethercalc_enabled
  block:
    - name: Set TLS files for letsencrypt
      ansible.builtin.set_fact:
        vhost_letsencrypt_cert: "{{ ethercalc_vhost_letsencrypt_cert }}"
        vhost_letsencrypt_trusted_cert: "{{ ethercalc_vhost_letsencrypt_trusted_cert }}"
        vhost_letsencrypt_key: "{{ ethercalc_vhost_letsencrypt_key }}"
        force_letsencrypt: true
      when:
        - ethercalc_vhost_letsencrypt is defined
        - ethercalc_vhost_letsencrypt

    - name: Check trusted TLS cert
      ansible.builtin.stat:
        path: /etc/ssl/certs/{{ ethercalc_vhost_ssl_cert }}_trusted.crt
      register: trusted_cert
      when: ethercalc_vhost_letsencrypt is undefined or not ethercalc_vhost_letsencrypt

    - name: Set TLS files
      ansible.builtin.set_fact:
        vhost_ssl_cert: "{{ ethercalc_vhost_ssl_cert }}"
        vhost_ssl_with_trusted_cert: "{{ trusted_cert.stat.exists | bool }}"
      when: ethercalc_vhost_letsencrypt is undefined or not ethercalc_vhost_letsencrypt

    - name: Configure ethercalc nginx vhost via nginx_mono
      tags: nginx
      ansible.builtin.include_role:
        name: alphanodes.setup.nginx_mono
        tasks_from: service
      vars:
        nginx_mono_service_name: ethercalc
        nginx_mono_service_enabled: "{{ ethercalc_enabled }}"
        nginx_mono_service_config:
          server_name: "{{ ethercalc_vhost_server }}"
          root: "{{ ethercalc_path }}"
          index: "index.html"
          proxy_pass: "http://{{ ethercalc_ip }}:{{ ethercalc_port }}"
          proxy_location: "/"
          proxy_websocket: true
          vhost_users: "{{ ethercalc_vhost_users | default([]) }}"
          vhost_for_zabbix: "{{ ethercalc_vhost_for_zabbix | default(false) }}"
          letsencrypt: "{{ ethercalc_vhost_letsencrypt | default(false) }}"

- name: Disable block
  when: not ethercalc_enabled
  block:
    - name: Ensure ethercalc vhost is disabled
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/ethercalc.conf
        state: absent
