---

- name: Ensure required packages are installed
  ansible.builtin.apt:
    name: "{{ btrbk_required_packages }}"
    state: present

- name: Ensure Btrbk configuration installed
  ansible.builtin.template:
    src: btrbk.conf.j2
    dest: /etc/btrbk/btrbk.conf
    mode: '0640'

- name: Create snapshot directories
  ansible.builtin.file:
    path: "{{ item.volume }}/{{ item.subvolume }}/{{ item.snapshot_dir | default('.snapshots') }}"
    state: directory
    owner: '{{ btrbk_snapshot_owner }}'
    group: '{{ btrbk_snapshot_group }}'
    mode: '{{ btrbk_snapshot_mode }}'
  loop: '{{ btrbk_volumes }}'
