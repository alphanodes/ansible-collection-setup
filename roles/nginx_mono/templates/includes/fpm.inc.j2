{#
  PHP-FPM Configuration Include
  =============================

  This template provides PHP-FPM fastcgi configuration directives.

  There are TWO ways to use FPM in nginx_mono:

  1. Standard Pattern: instance.with_fpm (for standard PHP apps)
     - Use: All .php files are processed by FPM
     - Example: Drupal, Nextcloud, Roundcube
     - Pattern in vhost: location ~ \.php$ { include fpm.inc.j2 }

  2. Whitelist Pattern: location.with_fpm (for security-sensitive apps)
     - Use: Only specific PHP files are processed by FPM
     - Example: Matomo (only index.php, matomo.php, piwik.php, js/index.php)
     - Pattern in vhost: explicit location = /file.php { include fpm.inc.j2 }
     - Called from: location.inc.j2 when location.with_fpm is defined

  Usage:
    - Direct include: Uses instance.with_fpm for pool name
    - Via location.inc.j2: Set fpm_pool before include to override pool name
#}
{% set _fpm_pool = fpm_pool | default(instance.with_fpm | default(none)) %}
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    include /etc/nginx/fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param SERVER_NAME $host;
    # HTTP_HOST required for HTTP/3 compatibility - HTTP/3 has no Host header,
    # only :authority pseudo-header. $host works across all HTTP versions.
    fastcgi_param HTTP_HOST $host;
    fastcgi_intercept_errors on;
    fastcgi_read_timeout {{ nginx_fastcgi_read_timeout | default(60) }};
    fastcgi_send_timeout {{ nginx_fastcgi_send_timeout | default(60) }};
    fastcgi_pass unix:{{ php_fpm_base + '-' + _fpm_pool + '.sock' if _fpm_pool is string and _fpm_pool != 'www' else php_fpm_custom_listen | default(php_fpm_listen) }};
