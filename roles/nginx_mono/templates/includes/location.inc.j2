{#
  Custom Location Blocks
  ======================

  This template generates custom location blocks defined via instance.locations.

  Each location can have:
    - name: The location pattern (e.g., "= /index.php", "~ \.php$", "@named")
    - rewrite: Optional rewrite rule
    - action: Single nginx directive (e.g., "deny all")
    - actions: List of nginx directives
    - raw_actions: List of raw nginx directives (no semicolon added)
    - return: HTTP return code/redirect
    - with_fpm: FPM pool name for PHP processing (uses fpm.inc.j2)
    - proxy_pass: Proxy to backend (e.g., "http://upstream_name")
    - proxy_websocket: Enable WebSocket support (Upgrade headers)
    - proxy_timeout: Connection/send/read timeout in seconds
    - proxy_headers: List of additional proxy headers

  with_fpm is used for whitelist FPM patterns where only specific PHP files
  should be processed. See fpm.inc.j2 for documentation on FPM patterns.

  Named locations (starting with @) can be used with try_files:
    locations:
      - name: "/"
        raw_actions:
          - "try_files $uri @backend;"
      - name: "@backend"
        proxy_pass: "http://app_upstream"
#}
  location = /favicon.ico {
    log_not_found off;
    access_log off;
  }

{% if instance is defined and instance.use_robots_txt_from_redmine is undefined or not instance.use_robots_txt_from_redmine %}
  location = /robots.txt {
    log_not_found off;
    access_log off;
  }
{% endif %}

  location = /humans.txt {
    log_not_found off;
    access_log off;
  }

  location ~* ^/(apple\-touch\-icon\.png|apple\-touch\-icon\-precomposed\.png) {
    log_not_found off;
    access_log off;
  }

{% if instance.locations is defined %}
{% for location in instance.locations %}

  location {{ location.name }} {
{% if location.rewrite is defined %}
    rewrite {{ location.rewrite }} permanent;
{% endif %}
{% if location.action is defined %}
    {{ location.action }};
{% endif %}
{% if location.actions is defined %}
{% for action in location.actions %}
    {{ action }};
{% endfor %}
{% endif %}
{% if location.raw_actions is defined %}
{% for raw_action in location.raw_actions %}
    {{ raw_action }}
{% endfor %}
{% endif %}
{% if location.return is defined %}
    return {{ location.return }};
{% endif %}
{% if location.proxy_pass is defined %}
    proxy_pass {{ location.proxy_pass }};
{% if location.proxy_http_version is defined %}
    proxy_http_version {{ location.proxy_http_version }};
{% elif location.proxy_websocket is defined and location.proxy_websocket %}
    proxy_http_version 1.1;
{% endif %}
    proxy_set_header X-Real-IP $remote_addr;
{% if nginx_with_proxy_forwarded_hosts | default([]) | length > 0 %}
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Host $forwarded_host;
{% else %}
    proxy_set_header Host $proxy_host;
{% endif %}
{% if nginx_with_proxy_forwarded_for | default(true) %}
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
{% endif %}
{% if location.proxy_forwarded_proto is defined %}
    proxy_set_header X-Forwarded-Proto {{ location.proxy_forwarded_proto }};
{% else %}
    proxy_set_header X-Forwarded-Proto $scheme;
{% endif %}
{% if location.proxy_ssl_header is defined and location.proxy_ssl_header %}
    proxy_set_header X-Forwarded-Ssl on;
{% endif %}
{% if location.proxy_redirect is defined %}
    proxy_redirect {{ location.proxy_redirect }};
{% endif %}
{% if location.proxy_websocket is defined and location.proxy_websocket %}
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
{% endif %}
{% if location.proxy_timeout is defined %}
    proxy_connect_timeout {{ location.proxy_timeout }};
    proxy_send_timeout {{ location.proxy_timeout }};
    proxy_read_timeout {{ location.proxy_timeout }};
{% endif %}
{% if location.proxy_buffers is defined %}
    proxy_buffers {{ location.proxy_buffers }};
{% endif %}
{% if location.proxy_buffer_size is defined %}
    proxy_buffer_size {{ location.proxy_buffer_size }};
{% endif %}
{% if location.proxy_busy_buffers_size is defined %}
    proxy_busy_buffers_size {{ location.proxy_busy_buffers_size }};
{% endif %}
{% if location.proxy_headers is defined %}
{% for header in location.proxy_headers %}
    proxy_set_header {{ header }};
{% endfor %}
{% endif %}
{% endif %}
{% if location.with_fpm is defined and location.with_fpm %}
{% set fpm_pool = location.with_fpm %}
{% include 'includes/fpm.inc.j2' %}

{% endif %}
  }
{% endfor %}
{% endif %}
