{#
  Default Host Redirect
  =====================

  Creates catch-all server blocks that redirect requests for unknown hosts
  to the actual server_name. This is used when vhost_default is true.

  Example: If server_name is "redmine.example.com" and someone visits
  "typo.example.com", they get redirected to "redmine.example.com".

  Note: reuseport MUST be set here on the default_server block if enabled.
  nginx only allows reuseport once per port - on the default_server.
  Other server blocks on the same port inherit the socket options.
#}
{% set reuseport_flag = ' reuseport' if nginx_listen_config.use_reuseport else '' -%}
{% set ssl_port = instance.server_port | default(443) | int -%}
# Default host redirect to {{ instance.server_name | default(nginx_mono_service_name) }}
server {
  listen 80 default_server{{ reuseport_flag }};
{% if nginx_with_ipv6 %}
  listen [::]:80 default_server{{ reuseport_flag }};
{% endif %}
  server_name _;
{% if certbot_certs is defined and certbot_certs | length > 0 %}
  include /etc/nginx/acme-challenge.conf;
  location / {
    return 301 {{ 'https' if nginx_with_ssl else 'http' }}://{{ instance.server_name | default(nginx_mono_service_name) }}$request_uri;
  }
{% else %}
  return 301 {{ 'https' if nginx_with_ssl else 'http' }}://{{ instance.server_name | default(nginx_mono_service_name) }}$request_uri;
{% endif %}
}

{% if nginx_with_ssl %}
server {
  listen {{ ssl_port }} {{ nginx_ssl_listen_option }} default_server{{ reuseport_flag }};
{% if nginx_with_ipv6 %}
  listen [::]:{{ ssl_port }} {{ nginx_ssl_listen_option }} default_server{{ reuseport_flag }};
{% endif %}
{% if nginx_listen_config.use_http3 and ssl_port == 443 %}
  listen 443 quic default_server{{ reuseport_flag }};
{% if nginx_with_ipv6 %}
  listen [::]:443 quic default_server{{ reuseport_flag }};
{% endif %}
{% endif %}
{% include 'includes/modern_protocols.inc.j2' %}
  server_name _;
  return 301 https://{{ instance.server_name | default(nginx_mono_service_name) }}$request_uri;

{% include 'includes/ssl.inc.j2' %}
}
{% endif %}
