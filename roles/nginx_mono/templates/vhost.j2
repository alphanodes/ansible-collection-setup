{{ managed_by_ansible | comment }}
# nginx {{ nginx_mono_service_name | default(instance.name) }} vhost configuration

{% include 'includes/upstream.inc.j2' %}
{# When vhost_default is true AND server_name is defined, we use a separate redirect server block
   (with default_server) instead of putting default_server on the main vhost. This ensures unknown
   hosts get redirected to the canonical server_name instead of being served directly.

   Exceptions where we DON'T use the redirect block:
   - If vhost_default is true WITHOUT server_name (catch-all parking vhost)
   - If vhost_redirect_to or vhost_redirect_to_static is defined (manual redirect takes precedence)

   IMPORTANT: Main vhost MUST come before catch-all redirect block!
   nginx uses first matching server block when Host header contains non-standard port (e.g. :8443).
   With main vhost first, SSH tunnel scenarios work correctly. #}
{% set has_manual_redirect = instance.vhost_redirect_to is defined or instance.vhost_redirect_to_static is defined %}
{% set use_redirect_block = instance.vhost_default | default(false) and instance.server_name is defined and not has_manual_redirect %}
server {
{# Clean listen configuration using pre-calculated variables
   Note: When using redirect block, default_server AND reuseport are there, not here.
   nginx only allows reuseport once per port - on the default_server block. #}
{% set default_server_flag = '' if use_redirect_block else (' default_server' if nginx_listen_config.default_server else '') -%}
{% set reuseport_flag = ' reuseport' if (nginx_listen_config.use_reuseport and not use_redirect_block) else '' -%}
{% set ssl_port = nginx_listen_config.server_port | default(443) -%}

{# SSL Configuration (standard 443 or custom SSL port) #}
{% if nginx_listen_config.use_ssl %}
{# SSL listen directives #}
  listen {{ ssl_port }} {{ nginx_ssl_listen_option }}{{ default_server_flag }}{{ reuseport_flag }};
{% if nginx_listen_config.use_ipv6 %}
  listen [::]:{{ ssl_port }} {{ nginx_ssl_listen_option }}{{ default_server_flag }}{{ reuseport_flag }};
{% endif %}
{# HTTP/3 QUIC support - only for standard port 443, not custom ports #}
{% if nginx_listen_config.use_http3 and ssl_port == 443 %}
{%- set quic_reuseport = ' reuseport' if (nginx_listen_config.use_reuseport and not use_redirect_block) else '' %}
  listen 443 quic{{ default_server_flag }}{{ quic_reuseport }};
{% if nginx_listen_config.use_ipv6 %}
  listen [::]:443 quic{{ default_server_flag }}{{ quic_reuseport }};
{% endif %}
{% endif %}
{% endif %}

{# HTTP Configuration (80) - only if not SSL-only #}
{% if nginx_listen_config.use_http and not nginx_listen_config.ssl_only %}
  listen 80{{ default_server_flag }}{{ reuseport_flag }};
{% if nginx_listen_config.use_ipv6 %}
  listen [::]:80{{ default_server_flag }}{{ reuseport_flag }};
{% endif %}
{% endif %}
{% include 'includes/modern_protocols.inc.j2' %}
{% if instance.server_name is defined %}
  server_name {{ instance.server_name }}{{ ' ' + instance.server_alias if instance.server_alias is defined else '' }};
{% endif %}
{% if not nginx_vhost_with_access_log %}
  access_log off;
{% elif instance.access_log is defined and instance.access_log is sameas false %}
  access_log off;
{% elif instance.access_log is defined and instance.access_log is string %}
  access_log {{ instance.access_log }};
{% endif %}
{% if instance.root is defined %}
  root {{ instance.root }};
{% endif %}
{% if instance.index is defined %}
  index {{ instance.index }};
{% endif %}

{% if nginx_with_protection %}
{% include 'includes/protection.inc.j2' %}
{% endif %}
{% if instance.custom_protection_rules is defined %}
  # custom protection rules
{% for rule in instance.custom_protection_rules %}
  {{ rule }}
{% endfor %}

{% endif %}
{% if instance.limit_req is defined %}
  # rate limiting
{% for limit in instance.limit_req %}
  limit_req {{ limit }};
{% endfor %}
{% if instance.limit_req_status is defined %}
  limit_req_status {{ instance.limit_req_status }};
{% endif %}

{% endif %}
{% if instance.block_hidden_files | default(false) %}
  # Disable .htaccess and other hidden files
  # Using 404 instead of 403 to not reveal file existence (security best practice)
  location ~ /\. {
    return 404;
  }

{% endif %}
{% if instance.vhost_dnt_private_ip is defined and instance.vhost_dnt_private_ip %}
  set $dnt_header $http_dnt;
  if ($private_network) {
    set $dnt_header "";
  }
  more_clear_input_headers DNT $dnt_header;

{% endif %}
{% if nginx_with_ssl %}
{% include 'includes/ssl.inc.j2' %}
{% endif %}
{% if nginx_with_security_headers %}
{% include 'includes/security_headers.inc.j2' %}
{% endif %}

{% if instance.additional_headers is defined %}
{% for header in instance.additional_headers %}
  add_header {{ header }};
{% endfor %}

{% endif %}
{% if nginx_fastcgi_microcache_zone != '' and instance.microcache_zone is defined %}
  # microcache settings for zone {{ nginx_fastcgi_microcache_zone }}
  fastcgi_cache {{ nginx_fastcgi_microcache_zone }};
  fastcgi_cache_key $scheme$host$request_uri$request_method;
  fastcgi_cache_valid 200 301 302 {{ nginx_fastcgi_microcache_valid }};
  fastcgi_cache_use_stale updating error timeout invalid_header http_500;
  fastcgi_pass_header Set-Cookie;
  fastcgi_pass_header Cookie;
  fastcgi_ignore_headers Cache-Control Expires Set-Cookie;

{% endif %}
{% if instance.fastcgi_params is defined %}
{% for fastcgi_param in instance.fastcgi_params %}
  fastcgi_param {{ fastcgi_param }};
{% endfor %}

{% endif %}
{% if instance.fastcgi_buffers is defined %}
  fastcgi_buffer_size {{ instance.fastcgi_buffer_size | default('4k') }};
  fastcgi_busy_buffers_size {{ instance.fastcgi_busy_buffers_size | default('8k') }};
  fastcgi_buffers {{ instance.fastcgi_buffers }};
  fastcgi_max_temp_file_size 0;

{% endif %}
{% if instance.with_fpm is defined %}
{% include 'includes/fpm_location.inc.j2' %}

{% endif %}
{% if instance.vhost_includes is defined %}
{% for vhost_include in instance.vhost_includes %}
  include {{ vhost_include }}.conf;
{% endfor %}

{% endif %}
{% if instance.vhost_redirect_to is defined %}
  return 301 {{ instance.vhost_redirect_to }}$request_uri;

{% endif %}
{% if instance.vhost_redirect_to_static is defined %}
  return 301 {{ instance.vhost_redirect_to_static }};

{% endif %}
{% include 'includes/location.inc.j2' %}
{% include 'includes/proxy.inc.j2' %}
{% include 'includes/rewrite_lines.inc.j2' %}
{% if instance.raw_actions is defined %}
{% for raw_action in instance.raw_actions %}
{{ raw_action | indent(2, first=True) }}
{% endfor %}
{% endif %}
{% include 'includes/error_handler.inc.j2' %}
{% if instance.static_cache is defined and instance.static_cache %}
{% include 'includes/static_cache.inc.j2' %}
{% endif %}
{# Server-level auth_basic is ONLY used when:
   - NOT include_mode (include mode has auth in proxy location)
   - NO proxy_pass (if proxy_pass exists, auth is handled in proxy.inc.j2)
   - auth_basic_realm is explicitly set (opt-in for server-level protection)
   - vhost_users is defined with at least one user
   Example: Redmine with access_protection=true needs server-level auth.
   Note: Static sites (like element_web) need explicit auth_basic_realm if protection is desired. #}
{% if not nginx_mono_include_mode and not (instance.proxy_pass is defined and instance.proxy_pass | length > 0) and instance.auth_basic_realm is defined and instance.vhost_users is defined and instance.vhost_users | length > 0 %}
  # access protection (server level - protects entire vhost)
  auth_basic "{{ instance.auth_basic_realm }}";
  auth_basic_user_file /etc/nginx/.htpasswd_{{ instance.htpasswd_name | default(nginx_mono_service_name | default(instance.name)) }};

{% endif %}
}

{# Catch-all redirect block AFTER main vhost - see comment at top for explanation #}
{% if use_redirect_block %}
{% include 'includes/default_host_redirect.inc.j2' %}
{% endif %}
{% if nginx_listen_config.use_ssl %}
{% include 'includes/port_redirect.inc.j2' %}
{% endif %}
{% if instance.mappings is defined %}
{% include 'mappings.inc.j2' with context %}
{% endif %}
{% if instance.redirects is defined and instance.redirects | length > 0 %}
{% include 'includes/redirects.inc.j2' %}
{% endif %}
{% if instance.external_redirects is defined and instance.external_redirects | length > 0 %}
{% include 'includes/external_redirects.inc.j2' %}
{% endif %}
{% if instance.vhost_for_zabbix is defined and instance.vhost_for_zabbix %}
{% include 'includes/monitoring.inc.j2' %}
{% endif %}
