---
# nginx_mono service configuration tasks
# This file handles individual service integration

- name: Set service-specific variables
  ansible.builtin.set_fact:
    nginx_mono_instance: "{{ nginx_mono_instance_defaults | combine(nginx_mono_service_config | default({})) }}"

- name: Normalize simple directive lists (headers, fastcgi, proxy headers, rewrites)
  ansible.builtin.set_fact:
    nginx_mono_prep_additional_headers: >-
      {{ (nginx_mono_instance.additional_headers | default([]))
         | map('trim')
         | map('regex_replace', '(?<![;}])\s*$', ';')
         | list }}
    nginx_mono_prep_fastcgi_params: >-
      {{ (nginx_mono_instance.fastcgi_params | default([]))
         | map('trim')
         | map('regex_replace', '(?<![;}])\s*$', ';')
         | list }}
    nginx_mono_prep_proxy_headers: >-
      {{ (nginx_mono_instance.proxy_headers | default([]))
         | map('trim')
         | map('regex_replace', '(?<![;}])\s*$', ';')
         | list }}
    nginx_mono_prep_rewrite_lines: >-
      {{ (nginx_mono_instance.rewrite_lines | default([]))
         | map('trim')
         | map('regex_replace', '(?<![;}])\s*$', ';')
         | list }}

- name: Normalize proxy_redirect
  when: nginx_mono_instance.proxy_redirect is defined
  ansible.builtin.set_fact:
    nginx_mono_prep_proxy_redirect: >-
      {{ (nginx_mono_instance.proxy_redirect | trim)
         | regex_replace('(?![;}]$)\s*$',';')
      }}

- name: Init normalized locations list
  when: nginx_mono_instance.locations is defined
  ansible.builtin.set_fact:
    nginx_mono_prep_locations: []

- name: Build normalized locations
  when: nginx_mono_instance.locations is defined
  ansible.builtin.set_fact:
    nginx_mono_prep_locations: "{{ nginx_mono_prep_locations + [ normalized_loc ] }}"
  vars:
    _action: "{{ (item.action | default('') | trim) }}"
    _norm_action: "{{ _action if (_action | length == 0) or (_action[-1:] in [';','}']) else _action + ';' }}"
    _actions: >-
      {{ (item.actions | default([]))
         | map('trim')
         | map('regex_replace', '(?<![;}])\s*$', ';')
         | list }}
    normalized_loc: >-
      {{ item
         | combine( (item.action is defined) | ternary({'action': _norm_action}, {}), recursive=True)
         | combine( (item.actions is defined) | ternary({'actions': _actions}, {}), recursive=True) }}
  loop: "{{ nginx_mono_instance.locations }}"

- name: Init normalized mappings list
  when: nginx_mono_instance.mappings is defined
  ansible.builtin.set_fact:
    nginx_mono_prep_mappings: []

- name: Build normalized mappings
  when: nginx_mono_instance.mappings is defined
  ansible.builtin.set_fact:
    nginx_mono_prep_mappings: "{{ nginx_mono_prep_mappings + [ normalized_map ] }}"
  vars:
    _map_actions: >-
      {{ (item.actions | default([]))
         | map('trim')
         | map('regex_replace', '(?<![;}])\s*$', ';')
         | list }}
    _map_rewrite_lines: >-
      {{ (item.rewrite_lines | default([]))
         | map('trim')
         | map('regex_replace', '(?<![;}])\s*$', ';')
         | list }}
    normalized_map: >-
      {{ item
         | combine( (item.actions is defined) | ternary({'actions': _map_actions}, {}), recursive=True)
         | combine( (item.rewrite_lines is defined) | ternary({'rewrite_lines': _map_rewrite_lines}, {}), recursive=True) }}
  loop: "{{ nginx_mono_instance.mappings }}"

- name: Build prepared instance
  ansible.builtin.set_fact:
    nginx_mono_instance_prepared: >-
      {{ nginx_mono_instance | combine({
          'additional_headers': (nginx_mono_prep_additional_headers | default(nginx_mono_instance.additional_headers | default([]))),
          'fastcgi_params': (nginx_mono_prep_fastcgi_params | default(nginx_mono_instance.fastcgi_params | default([]))),
          'proxy_headers': (nginx_mono_prep_proxy_headers | default(nginx_mono_instance.proxy_headers | default([]))),
          'rewrite_lines': (nginx_mono_prep_rewrite_lines | default(nginx_mono_instance.rewrite_lines | default([]))),
          'locations': (nginx_mono_prep_locations | default(nginx_mono_instance.locations | default([]))),
          'mappings': (nginx_mono_prep_mappings | default(nginx_mono_instance.mappings | default([]))),
          'proxy_redirect': (nginx_mono_prep_proxy_redirect | default(nginx_mono_instance.proxy_redirect | default(omit)))
        }, recursive=True) }}

- name: Check if multiple services would use reuseport without primary service set
  block:
    - name: Find existing vhost files with reuseport
      ansible.builtin.find:
        paths: /etc/nginx/sites-enabled
        patterns: "*.conf"
        excludes: "{{ nginx_mono_service_name }}.conf"
      register: existing_vhosts

    - name: Check if any existing vhost uses reuseport
      ansible.builtin.command: grep -l "listen.*reuseport" {{ item.path }}
      register: reuseport_check
      loop: "{{ existing_vhosts.files | default([]) }}"
      failed_when: false
      changed_when: false

    - name: Fail if multiple services need reuseport but no primary service is configured
      ansible.builtin.fail:
        msg: |
          ERROR: Multiple nginx services detected but no primary service configured!

          Found existing services with reuseport: {{ reuseport_check.results | selectattr('rc', 'equalto', 0) | map(attribute='item.path') | map('basename') | map('regex_replace', '\\.conf$', '') | list }}
          Current service: {{ nginx_mono_service_name }}

          SOLUTION: Set the primary service for reuseport in your configuration:
          nginx_reuseport_primary_service: "grafana"  # or "loki" or "{{ nginx_mono_service_name }}"

          Only ONE service per server can use reuseport on the same port (443).
          This prevents nginx "duplicate listen options" errors.
      when:
        - nginx_with_reuseport | default(false)
        - nginx_reuseport_primary_service is not defined
        - reuseport_check.results | selectattr('rc', 'equalto', 0) | list | length > 0

- name: Determine if this service should use reuseport
  ansible.builtin.set_fact:
    service_uses_reuseport: "{{ nginx_reuseport_primary_service | default('') == nginx_mono_service_name }}"
  when: nginx_with_reuseport | default(false)

- name: Set service_uses_reuseport to false if reuseport disabled
  ansible.builtin.set_fact:
    service_uses_reuseport: false
  when: not (nginx_with_reuseport | default(false))

- name: Calculate listen configuration
  ansible.builtin.set_fact:
    nginx_listen_config:
      use_ipv6: "{{ nginx_with_ipv6 | default(false) }}"
      use_ssl: "{{ nginx_with_ssl and (nginx_mono_instance.server_port is undefined or nginx_mono_instance.server_port == 443) }}"
      use_http: "{{ nginx_mono_instance.server_port is undefined or nginx_mono_instance.server_port == 80 }}"
      use_http3: "{{ nginx_with_http3 | default(false) }}"
      use_reuseport: "{{ service_uses_reuseport | default(false) }}"
      default_server: "{{ nginx_mono_instance.vhost_default is defined and nginx_mono_instance.vhost_default }}"
      ssl_only: "{{ nginx_force_ssl and nginx_with_ssl and (nginx_mono_instance.server_port is undefined or nginx_mono_instance.server_port == 443) }}"


- name: Setup Basic Auth for service
  community.general.htpasswd:
    path: "/etc/nginx/.htpasswd_{{ nginx_mono_service_name }}"
    name: '{{ item.user }}'
    password: '{{ item.password }}'
    owner: root
    group: '{{ nginx_group }}'
    mode: '0640'
  loop: '{{ nginx_mono_instance.vhost_users | default([]) }}'
  when:
    - nginx_mono_instance.vhost_users is defined
    - nginx_mono_instance.vhost_users | length > 0
  notify: Restart nginx

- name: Remove Basic Auth file if not used
  ansible.builtin.file:
    path: "/etc/nginx/.htpasswd_{{ nginx_mono_service_name }}"
    state: absent
  when:
    - nginx_mono_instance.vhost_users is undefined or nginx_mono_instance.vhost_users | length < 1
  notify: Restart nginx

- name: Create service vhost configuration
  tags: nginx
  ansible.builtin.template:
    src: vhost.j2
    dest: "/etc/nginx/sites-available/{{ nginx_mono_service_name }}.conf"
    mode: '0644'
  vars:
    instance: "{{ nginx_mono_instance_prepared }}"
  notify: Reload nginx

- name: Enable service vhost
  tags: nginx
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/{{ nginx_mono_service_name }}.conf"
    dest: "/etc/nginx/sites-enabled/{{ nginx_mono_service_name }}.conf"
    state: link
  notify: Reload nginx
  when: nginx_mono_service_enabled | default(true)

- name: Disable service vhost
  tags: nginx
  ansible.builtin.file:
    path: "/etc/nginx/sites-enabled/{{ nginx_mono_service_name }}.conf"
    state: absent
  notify: Reload nginx
  when: not (nginx_mono_service_enabled | default(true))
