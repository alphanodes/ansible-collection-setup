---
# Calculate nginx listen configuration
# Used by both instance.yml (for nginx_vhosts) and service.yml (for nginx_mono services)
#
# Context detection:
# - service.yml context: nginx_mono_service_name and nginx_mono_instance are defined
# - instance.yml context: instance is defined from loop

- name: Set context-aware variables for listen config calculation
  ansible.builtin.set_fact:
    _listen_calc_name: "{{ nginx_mono_service_name | default(instance.name) }}"
    _listen_calc_instance: "{{ nginx_mono_instance | default(instance) }}"

- name: Determine if this service/instance should use reuseport
  ansible.builtin.set_fact:
    service_uses_reuseport: "{{ nginx_reuseport_primary_service | default('') == _listen_calc_name }}"
  when: nginx_with_reuseport | default(false)

- name: Set service_uses_reuseport to false if reuseport disabled
  ansible.builtin.set_fact:
    service_uses_reuseport: false
  when: not (nginx_with_reuseport | default(false))

- name: Calculate listen configuration
  vars:
    _port: "{{ _listen_calc_instance.server_port | default(443) }}"
    _is_ssl_port: "{{ nginx_with_ssl and (_port | int == 443 or _port | int > 1024) }}"
  ansible.builtin.set_fact:
    nginx_listen_config:
      use_ipv6: "{{ nginx_with_ipv6 | default(false) }}"
      use_ssl: "{{ _is_ssl_port }}"
      use_http: "{{ _port | int == 80 }}"
      use_http3: "{{ nginx_with_http3 | default(false) }}"
      use_reuseport: "{{ service_uses_reuseport | default(false) }}"
      default_server: "{{ _listen_calc_instance.vhost_default is defined and _listen_calc_instance.vhost_default }}"
      ssl_only: "{{ nginx_force_ssl and _is_ssl_port }}"
      server_port: "{{ _port | int }}"
      is_custom_ssl_port: "{{ _is_ssl_port and _port | int != 443 }}"
