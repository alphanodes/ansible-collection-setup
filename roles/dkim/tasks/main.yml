---
- name: Validate DKIM configuration
  ansible.builtin.fail:
    msg: "No DKIM domains configured. Set dkim_domains variable with at least one domain."
  when: dkim_domains | length == 0

- name: Ensure required packages are installed
  ansible.builtin.apt:
    name:
      - openssl
    state: present
    update_cache: false

- name: Create base DKIM directory
  ansible.builtin.file:
    path: "{{ dkim_base_dir }}"
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Include DKIM key generation tasks
  ansible.builtin.include_tasks: generate_key.yml
  loop: "{{ dkim_domains }}"
  loop_control:
    loop_var: dkim_domain
    label: "{{ dkim_domain.domain }}"
