---
# Support two modes:
# 1. dkim_domain (string) - single domain lookup from dkim_domains dictionary
# 2. dkim_domains (list) - direct list of domains with config (legacy/batch mode)

- name: Build domain list from dkim_domain lookup
  when:
    - dkim_domain is defined
    - dkim_domain | length > 0
    - dkim_domains is defined
    - dkim_domain in dkim_domains
  ansible.builtin.set_fact:
    dkim_domains_to_process:
      - domain: "{{ dkim_domain }}"
        selector: "{{ dkim_domains[dkim_domain].selector }}"
        key_size: "{{ dkim_domains[dkim_domain].key_size | default(2048) }}"

- name: Use dkim_domains list directly (legacy mode)
  when: dkim_domains_to_process is not defined
  ansible.builtin.set_fact:
    dkim_domains_to_process: "{{ dkim_domains }}"

- name: Validate DKIM configuration
  ansible.builtin.fail:
    msg: "No DKIM domains configured. Set dkim_domain or dkim_domains variable."
  when: dkim_domains_to_process | length == 0

- name: Ensure required packages are installed
  ansible.builtin.apt:
    name:
      - openssl
    state: present
    update_cache: false

- name: Create base DKIM directory
  ansible.builtin.file:
    path: "{{ dkim_base_dir }}"
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Include DKIM key generation tasks
  ansible.builtin.include_tasks: "{{ role_path }}/tasks/generate_key.yml"
  loop: "{{ dkim_domains_to_process }}"
  loop_control:
    loop_var: dkim_domain_item
    label: "{{ dkim_domain_item.domain }}"
