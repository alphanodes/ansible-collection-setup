---
- name: Update shipper user access
  community.general.htpasswd:
    path: /etc/nginx/.htpasswd_loki
    name: '{{ loki_web_user }}'
    password: '{{ loki_web_password }}'
    owner: root
    group: "{{ nginx_group }}"
    mode: '0640'
  notify: Restart nginx

- name: Update customer user access
  community.general.htpasswd:
    path: /etc/nginx/.htpasswd_loki
    name: '{{ loki_customer_web_user }}'
    password: '{{ loki_customer_web_password }}'
    owner: root
    create: false
    group: "{{ nginx_group }}"
    mode: '0640'
  when: loki_customer_web_user is defined
  notify: Restart nginx

- name: Activate block
  when:
    - loki_vhost_server is defined
    - loki_vhost_server | length > 0
  block:
    - name: Set TLS files for letsencrypt
      ansible.builtin.set_fact:
        vhost_letsencrypt_cert: "{{ loki_vhost_letsencrypt_cert }}"
        vhost_letsencrypt_trusted_cert: "{{ loki_vhost_letsencrypt_trusted_cert }}"
        vhost_letsencrypt_key: "{{ loki_vhost_letsencrypt_key }}"
        force_letsencrypt: true
      when:
        - loki_vhost_letsencrypt is defined
        - loki_vhost_letsencrypt

    - name: Check trusted TLS cert
      ansible.builtin.stat:
        path: /etc/ssl/certs/{{ loki_vhost_ssl_cert }}_trusted.crt
      register: trusted_cert
      when: loki_vhost_letsencrypt is undefined or not loki_vhost_letsencrypt

    - name: Set TLS files
      ansible.builtin.set_fact:
        vhost_ssl_cert: "{{ loki_vhost_ssl_cert }}"
        vhost_ssl_with_trusted_cert: "{{ trusted_cert.stat.exists | bool }}"
      when: loki_vhost_letsencrypt is undefined or not loki_vhost_letsencrypt

    - name: Provide loki vhost nginx configuration
      ansible.builtin.template:
        src: nginx/vhost.j2
        dest: /etc/nginx/sites-available/loki.conf
        mode: '0644'
      notify: Reload nginx

    - name: Ensure loki vhost is enabled
      ansible.builtin.file:
        src: /etc/nginx/sites-available/loki.conf
        dest: /etc/nginx/sites-enabled/loki.conf
        state: link
      notify: Reload nginx
