---

- name: Setup nginx_mono and configure loki vhost
  tags: nginx
  ansible.builtin.include_role:
    name: alphanodes.setup.nginx_mono
  vars:
    nginx_mono_service_name: loki
    nginx_mono_service_enabled: true
    nginx_mono_service_config:
      server_name: "{{ loki_vhost_server }}"
      proxy_pass: "http://{{ loki_instance_addr }}:{{ loki_http_listen_port }}"
      proxy_location: "{{ loki_vhost_location }}"
      redirects: "{{ loki_redirects | default([]) }}"
      vhost_users: "{{ [{'user': loki_web_user, 'password': loki_web_password}] + ([{'user': loki_customer_web_user, 'password': loki_customer_web_password}] if loki_customer_web_user is defined else []) }}"
      vhost_for_zabbix: "{{ loki_vhost_for_zabbix | default(false) }}"
      letsencrypt: "{{ loki_vhost_letsencrypt | default(false) }}"
      letsencrypt_cert: "{{ loki_vhost_letsencrypt_cert | default('') }}"
      letsencrypt_key: "{{ loki_vhost_letsencrypt_key | default('') }}"
      letsencrypt_trusted_cert: "{{ loki_vhost_letsencrypt_trusted_cert | default('') }}"
      ssl_cert: "{{ loki_vhost_ssl_cert | default('') }}"
      vhost_includes: "{{ loki_vhost_includes | default([]) }}"

- name: Include ssl role
  ansible.builtin.include_role:
    name: alphanodes.setup.ssl
