#!/bin/bash
##################################
# Zabbix monitoring script
#
# php information
#  - phpinfo (CORE)
#     ZBX_REQ_DATA_SOURCE = info (default)
#  - fpm information (fix, php-fpm has to be configured to it; )
#     ZBX_REQ_DATA_SOURCE = fpm
#  - Zend Opcache configuration
#     ZBX_REQ_DATA_SOURCE = opcache_config
#  - Zend Opcache statistics
#     ZBX_REQ_DATA_SOURCE = opcache_stat
##################################

# Zabbix requested parameter
ZBX_REQ_DATA="$1"
ZBX_REQ_DATA_SOURCE="$2"
ZBX_REQ_DATA_PORT="$3"

# Handle port if non-default
if [ ! -z "$ZBX_REQ_DATA_PORT" ]; then
  PORT="$ZBX_REQ_DATA_PORT"
else
  PORT=80
fi

# URLs
PHP_INFO_URL="http://localhost:$PORT/php/info.php"
PHP_EXTENSIONS_URL="http://localhost:$PORT/php/loaded_extensions.php"
PHP_FPM_STATUS_URL="http://localhost:$PORT/php_status"
PHP_OPCACHE_CONFIG="http://localhost:$PORT/php/opcache_config.php"
PHP_OPCACHE_STAT="http://localhost:$PORT/php/opcache_stat.php"

# Programs to get content
WGET_BIN="/usr/bin/wget"

#
# Error handling:
#  - need to be displayable in Zabbix (avoid NOT_SUPPORTED)
#  - items need to be of type "float" (allow negative + float)
#
ERROR_WRONG_PARAM="-0.9902"
ERROR_DATA="-0.9903" # either can not connect /	bad host / bad port

# Only ZBX_REQ_DATA is mandatory
if [ -z "$ZBX_REQ_DATA" ]; then
  echo $ERROR_WRONG_PARAM
  exit 1
fi

if [ -z "$ZBX_REQ_DATA_SOURCE" ]; then
  ZBX_REQ_DATA_SOURCE='info'
fi


##########################
# Data retrieve methods
##########################

RESULTS=''
get_data_from_wget(){
	url=$1
	RESULTS=$($WGET_BIN -q $url -O - 2> /dev/null)
	# error during retrieve
	if [ $? -ne 0 -o -z "$RESULTS" ]; then
		echo $ERROR_DATA
		exit 1
	fi
}

# convert GBytes / MBytes / KBytes to bytes
# Based on the 2nd field (unit)
convert_from_size() {
  value=$1
  unit=$2

  # validate the value is a number (not perfect but ...)
  echo $value | grep -E '^[0-9.]+$' 2>&1 > /dev/null
  if [ $? -ne 0 ]; then
    echo $ERROR_STATS
    exit 1
  fi

  case $unit in
    Bytes) 	echo "$value";;
    KBytes) echo "$value * 1024" | bc | cut -f1 -d. ;;
    MBytes) echo "$value * 1024 * 1024" | bc | cut -f1 -d. ;;
    GBytes) echo "$value * 1024 * 1024 * 1024" | bc | cut -f1 -d. ;;
  esac
}

get_from_info(){
	if [ "$ZBX_REQ_DATA" == "loaded_extensions" ]; then
		get_data_from_wget $PHP_EXTENSIONS_URL
		value=`echo "$RESULTS";`
	else
	  get_data_from_wget $PHP_INFO_URL

	  # Parse JSON with Python3
	  if [ "$ZBX_REQ_DATA" == "php_version" ]; then
	    value=`echo "$RESULTS" | python3 -c "import json, sys; data=json.load(sys.stdin); print(data.get('php_version', ''))"`
	  elif [ "$ZBX_REQ_DATA" == "php_major_version" ]; then
	    value=`echo "$RESULTS" | python3 -c "import json, sys; data=json.load(sys.stdin); v=data.get('php_version', '').split('.'); print(v[0] if len(v) > 0 else '')"`
	  elif [ "$ZBX_REQ_DATA" == "php_minor_version" ]; then
	    value=`echo "$RESULTS" | python3 -c "import json, sys; data=json.load(sys.stdin); v=data.get('php_version', '').split('.'); print(v[1] if len(v) > 1 else '')"`
	  elif [ "$ZBX_REQ_DATA" == "php_release_version" ]; then
	    value=`echo "$RESULTS" | python3 -c "import json, sys; data=json.load(sys.stdin); v=data.get('php_version', '').split('.'); print(v[2].split('-')[0] if len(v) > 2 else '')"`
	  else
	    # All other values from ini.values (expose_php, display_errors, etc.)
	    # Use special marker to distinguish between "key not found" and "empty value"
	    value=`echo "$RESULTS" | python3 -c "import json, sys; data=json.load(sys.stdin); ini_values = data.get('ini', {}).get('values', {}); print(ini_values['${ZBX_REQ_DATA}'] if '${ZBX_REQ_DATA}' in ini_values else '__KEY_NOT_FOUND__')"`
	  fi
	fi
	# Check if key was not found (empty string is a valid value for "Off")
	if [ "$value" == "__KEY_NOT_FOUND__" ]; then
		echo $ERROR_WRONG_PARAM
	else
		echo "$value"
	fi
}

get_from_fpm(){
  get_data_from_wget $PHP_FPM_STATUS_URL

	if [ "$ZBX_REQ_DATA" == "php_version" ]; then
		value=`php -r "echo PHP_VERSION;"`
	elif [ "$ZBX_REQ_DATA" == "php_minor_version" ]; then
		value=`php -r "echo PHP_MINOR_VERSION;"`
	elif [ "$ZBX_REQ_DATA" == "php_major_version" ]; then
		value=`php -r "echo PHP_MAJOR_VERSION;"`
	elif [ "$ZBX_REQ_DATA" == "php_release_version" ]; then
		value=`php -r "echo PHP_RELEASE_VERSION;"`
	else
	  para=${ZBX_REQ_DATA//_/ }
		value=`echo "$RESULTS" | sed -n -e "/^$para:/{s/.*:[[:space:]]*//p}";`
	fi
	[ -z "$value" ] && echo $ERROR_WRONG_PARAM || echo $value
}

get_from_opcache_config(){
  get_data_from_wget $PHP_OPCACHE_CONFIG
	value=`echo "$RESULTS" | sed -n -e "/^$ZBX_REQ_DATA:/{s/.*:[[:space:]]*//p}";`
	[ -z "$value" ] && echo $ERROR_WRONG_PARAM || echo $value
}

get_from_opcache_stat(){
  get_data_from_wget $PHP_OPCACHE_STAT
	value=`echo "$RESULTS" | sed -n -e "/^$ZBX_REQ_DATA:/{s/.*:[[:space:]]*//p}" | head -1`
	[ -z "$value" ] && echo $ERROR_WRONG_PARAM || echo $value
}

#
# Grab php data for key ZBX_REQ_DATA
#
case $ZBX_REQ_DATA_SOURCE in
  info)						get_from_info;;
  fpm)						get_from_fpm;;
  opcache_config)	get_from_opcache_config;;
  opcache_stat)		get_from_opcache_stat;;
  *) echo $ERROR_WRONG_PARAM; exit 1;;
esac

exit 0
