---

- name: Set TLS files for letsencrypt - {{ matomo_vhost_letsencrypt_cert }}
  ansible.builtin.set_fact:
    vhost_letsencrypt_cert: "{{ matomo_vhost_letsencrypt_cert }}"
    vhost_letsencrypt_key: "{{ matomo_vhost_letsencrypt_key }}"
    force_letsencrypt: true
  when: matomo_vhost_letsencrypt | default(false) | bool

- name: Check trusted TLS cert
  ansible.builtin.stat:
    path: /etc/ssl/certs/{{ matomo_vhost_ssl_cert }}_trusted.crt
  register: trusted_cert
  when:
    - matomo_vhost_ssl_cert is defined
    - matomo_vhost_ssl_cert is not none
    - matomo_vhost_ssl_cert != omit
    - matomo_vhost_ssl_cert | string | length > 0

- name: Set TLS files
  ansible.builtin.set_fact:
    vhost_ssl_cert: "{{ matomo_vhost_ssl_cert }}"
    vhost_ssl_with_trusted_cert: "{{ (trusted_cert.stat.exists | default(false)) | bool }}"
  when: not (matomo_vhost_letsencrypt | default(false) | bool)

- name: Setup nginx_mono and configure matomo vhost
  ansible.builtin.include_role:
    name: alphanodes.setup.nginx_mono
  vars:
    php_fpm_custom_listen: "{{ php_fpm_base + '-' + matomo_php_fpm_pool + '.sock' if matomo_php_fpm_pool is defined else php_fpm_listen }}"
    nginx_mono_service_name: matomo
    nginx_mono_service_enabled: true
    # Matomo defines own security headers with 'always' flag via additional_headers
    # Disable nginx_mono default security headers to avoid duplicates
    nginx_with_security_headers: false
    # Matomo is a tracking tool accessed by many clients/bots - disable bot/location blocking
    nginx_with_protection: false
    nginx_mono_service_config:
      server_name: "{{ matomo_vhost_server }}"
      server_alias: "{{ [matomo_vhost_main | default(''), matomo_vhost_alias | default('')] | select | join(' ') | trim | default(omit, true) }}"
      root: "{{ matomo_dir }}"
      index: "index.php"
      vhost_default: "{{ matomo_vhost_default | default(false) }}"
      vhost_for_zabbix: "{{ matomo_vhost_for_zabbix | default(false) }}"
      letsencrypt: "{{ matomo_vhost_letsencrypt | default(false) }}"
      letsencrypt_cert: "{{ matomo_vhost_letsencrypt_cert | default('') }}"
      letsencrypt_key: "{{ matomo_vhost_letsencrypt_key | default('') }}"
      ssl_cert: "{{ matomo_vhost_ssl_cert | default('') }}"
      ssl_only: "{{ matomo_vhost_ssl_only | default(true) }}"
      access_log: "{{ matomo_with_access_log | default(true) }}"
      block_hidden_files: true
      # Matomo uses HTTP 403 for failed login attempts - don't intercept with nginx error page
      error_403_disabled: true
      additional_headers:
        - "Referrer-Policy origin always"
        - "X-Content-Type-Options 'nosniff' always"
        - "X-XSS-Protection '1; mode=block' always"
      vhost_includes: "{{ matomo_vhost_includes | default([]) }}"
      locations:
        # PHP-FPM for allowed files only
        - name: "~ ^/(index|matomo|piwik|js/index|plugins/HeatmapSessionRecording/configs)\\.php$"
          with_fpm: true
        # Deny all other PHP files
        - name: "~* ^.+\\.php$"
          actions:
            - "deny all"
            - "return 403"
        # Main location
        - name: "/"
          raw_actions:
            - "try_files $uri $uri/ =404;"
        # Deny sensitive directories
        - name: "~ ^/(console|config|tmp|core|lang)"
          actions:
            - "deny all"
            - "return 403"
        # Preview JS - no cache
        - name: "~ js/container_.*_preview\\.js$"
          raw_actions:
            - "expires off;"
            - "add_header Cache-Control 'private, no-cache, no-store';"
        # Static files with cache - MUST come before libs/vendor/plugins deny!
        - name: "~ \\.(gif|ico|jpg|png|svg|js|css|htm|html|mp3|mp4|wav|ogg|avi|ttf|eot|woff|woff2)$"
          raw_actions:
            - "allow all;"
            - "expires 1h;"
            - "add_header Pragma public;"
            - "add_header Cache-Control 'public';"
        # Deny libs, vendor, plugins, misc, node_modules - AFTER static files!
        - name: "~ ^/(libs|vendor|plugins|misc|node_modules)"
          actions:
            - "deny all"
            - "return 403"
        # Text files in root
        - name: "~/(.*\\.md|LEGALNOTICE|LICENSE)"
          raw_actions:
            - "default_type text/plain;"
