---

- name: Be sure matomo database exists
  community.mysql.mysql_db:
    login_unix_socket: "{{ mysql_socket if mysql_root_plugin == 'auth_socket' else omit }}"
    name: '{{ matomo_db_name }}'
    state: present

- name: Create matomo mysql user
  community.mysql.mysql_user:
    login_unix_socket: "{{ mysql_socket if mysql_root_plugin == 'auth_socket' else omit }}"
    name: '{{ matomo_db_user }}'
    plugin: caching_sha2_password
    plugin_auth_string: "{{ matomo_db_password }}"
    salt: "{{ [ansible_machine_id, ansible_hostname, 'matomo'] | join | hash('sha1') | truncate(20, true, '') }}"
    host: '{{ matomo_db_host }}'
    priv: '{{ matomo_db_name }}.*:ALL/*.*:FILE'
    column_case_sensitive: true
    state: present

- name: Allow mysql to write to {{ matomo_dir }}
  ansible.builtin.lineinfile:
    dest: '/etc/apparmor.d/usr.sbin.mysqld'
    regexp: '{{ matomo_dir }}/\*'
    insertbefore: 'Allow systemd notify messages'
    line: '  {{ matomo_dir }}/* rw,'
  when: ansible_distribution == 'Ubuntu'
  notify: Restart apparmor
