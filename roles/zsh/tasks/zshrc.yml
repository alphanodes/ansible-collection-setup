---

- name: Root block
  when: zsh_user == 'root'
  block:
    - name: Gather the package facts
      ansible.builtin.package_facts:
        manager: auto

    - name: Check if ruby-rubygems is installed
      ansible.builtin.set_fact:
        shell_with_ruby_gems: "{{ true if 'ruby-rubygems' in ansible_facts.packages else false }}"

    - name: Configure /root/.zshrc
      ansible.builtin.template:
        src: zshrc.j2
        dest: /root/.zshrc
        mode: 0644

- name: Non-Root block
  when: zsh_user != 'root'
  block:
    - name: Set shell_with_ruby_gems to false
      ansible.builtin.set_fact:
        shell_with_ruby_gems: false

    - name: Configure .zshrc for user {{ zsh_user }}
      ansible.builtin.template:
        src: zshrc.j2
        dest: '{{ zsh_user_home | default("/home" + zsh_user) }}/.zshrc'
        mode: 0644
      ignore_errors: true
      become: true
      become_user: '{{ zsh_user }}'
