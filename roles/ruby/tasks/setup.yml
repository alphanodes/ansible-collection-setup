---

- name: Pinning ruby backport packages
  ansible.builtin.template:
    src: backports-pin.j2
    dest: /etc/apt/preferences.d/ruby
    mode: '0644'
  when:
    - debian_backports is defined
    - debian_backports
    - ruby_use_backports

- name: Remove unwanted pinning for backport packages
  ansible.builtin.file:
    path: /etc/apt/preferences.d/ruby
    state: absent
  when: debian_backports is undefined or not debian_backports or not ruby_use_backports

- name: Ensure required packages are present
  ansible.builtin.apt:
    name: '{{ ruby_required_packages }}'
    state: present
  when: not ruby_without_required_packages

- name: Ensure ruby packages are absent
  ansible.builtin.apt:
    name: '{{ ruby_required_packages }}'
    state: absent
    purge: true
  when: ruby_without_required_packages

- name: Ensure dev packages are present
  ansible.builtin.apt:
    name: '{{ ruby_dev_packages }}'
    state: present
  when: ruby_dev

- name: Ensure dev packages are absent
  ansible.builtin.apt:
    name: '{{ ruby_dev_packages }}'
    state: absent
    purge: true
  when: not ruby_dev and ruby_without_dev_packages

- name: Ensure build packages are present
  ansible.builtin.apt:
    name: '{{ ruby_build_packages }}'
    state: present
  when: ruby_build

- name: Ensure build packages are absent
  ansible.builtin.apt:
    name: '{{ ruby_build_packages }}'
    state: absent
    purge: true
  when: not ruby_build and ruby_without_build_packages
